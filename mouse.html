<!DOCTYPE HTML>
<html>
  <head>
    <style>
    textarea {
      font-size:12px;
    }
    </style>
  </head>
  <body bgcolor="#cccccc"><button onclick="location.reload()">reload</button>
  &nbsp;Select image:<input type='file' name='img' size='65' id='uploadimage' style="display:none;">
  <button onclick="openFile()" id="imgloader" title="open image file...">open...</button>
  &nbsp;
  <button onclick="closePath()">close path</button>
  <br>
    <canvas id="myCanvas" width="500" height="500"></canvas>
    <textarea id="text1" name="text1" rows="38" cols="80" wrap="soft"></textarea>
    <script>
    
    window.onload = function () {
      document.getElementById("uploadimage").addEventListener("change", drawFile, true)
    }
    
    function openFile () {
      let canvas = document.getElementById('myCanvas')
      let ctx = canvas.getContext('2d')
      document.getElementById('uploadimage').click();
    }
    
    function drawFile () {
      let canvas = document.getElementById('myCanvas')
      let ctx = canvas.getContext('2d')
      let IMG = new Image()
      let f = document.getElementById("uploadimage").files[0]
      let url = window.URL || window.webkitURL
      let src = url.createObjectURL(f);
      IMG.src = src;
      ctx.globalAlpha = 1
      ctx.globalCompositeOperation = "source-over"
      IMG.onload = function () {
        canvas.height = this.height
        canvas.width = this.width
        ctx.drawImage(IMG, 0, 0);
        resizeCanvas()
        url.revokeObjectURL(src);
      }
    }
    
    function resizeCanvas () {
      let ocanvas = document.createElement('CANVAS')
      let octx = ocanvas.getContext('2d')
      let canvas = document.getElementById("myCanvas");
      let ctx = canvas.getContext("2d")
      ocanvas.height = canvas.height
      ocanvas.width = canvas.width
      octx.drawImage(canvas, 0, 0)
      let ar = canvas.width/canvas.height
      if (canvas.width > 500) {
        let W = canvas.width
        canvas.width = 500
        canvas.height = Math.floor(canvas.height * 500/W)
      }
      ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
      octx.clearRect(0,0,ocanvas.width,ocanvas.height)
    }

    let allpoints = []
  
    
    function writeMessage(canvas, message) {
      var context = canvas.getContext('2d');
      context.fillStyle = '#ffffff';
      context.fillRect(0, 0, canvas.width, canvas.height);
    }
    
    function closePath() {
      document.getElementById("text1").innerHTML += "  ctx.closePath()\n  ctx.fill()\n}"
    }
    
    function getMousePos(canvas, evt) {
      let rect = canvas.getBoundingClientRect();
      return {
        x: Math.floor(evt.clientX - rect.left),
        y: Math.floor(evt.clientY - rect.top)
      };
    }
    
    let canvas = document.getElementById('myCanvas');
    let context = canvas.getContext('2d');
    context.fillStyle = '#ffffff';
    context.lineWidth = 3
    context.fillRect(0, 0, canvas.width, canvas.height);
    let message = '';
    let buffer = []
    let cps = [];
    let i = 0;
    canvas.addEventListener('mousedown', function(evt) {
      let mousePos = getMousePos(canvas, evt);
      if (i === 0) {
        context.beginPath();
        context.moveTo(mousePos.x, mousePos.y);
        message  = 'function <name> (ctx,s,p,x,y) {\n'
        /*message += '  let canvas = document.getElementById("myCanvas");\n'
        message += '  let ctx = canvas.getContext("2d")\n'
        message += '  ctx.clearRect(0,0,canvas.width,canvas.height)\n'
        message += '  ctx.globalAlpha = document.getElementById("opacity").value/100\n'
        message += '  ctx.fillStyle=randomPick(getCurrentPalette())\n'
        message += '  let s = canvas.width/500, p = 33\n'
        message += '  let x = 0, y = 0\n'*/
        message += '  ctx.beginPath()\n'
        message += '  ctx.moveTo(x+' + mousePos.x + '*s, y+' + mousePos.y+'*s);';
        context.fillStyle = '#000000';
        context.fillRect(mousePos.x, mousePos.y, 3, 3);
        allpoints.push([mousePos.x, mousePos.y] )
      } else
      if (i % 3 !== 0) {
        cps.push([mousePos.x, mousePos.y]);
        message = "";
        context.fillStyle = '#ff0000';
        context.fillRect(mousePos.x, mousePos.y, 6, 6);
        // draw a line yo CP
        allpoints.push([mousePos.x, mousePos.y] )
        
      } else
      if (i % 3 === 0) {
        context.bezierCurveTo(cps[0][0], cps[0][1], cps[1][0], cps[1][1], mousePos.x, mousePos.y);
        context.stroke();
        message = '  ctx.bezierCurveTo(x+'+cps[0][0]+"*s+pet(p), y+"+cps[0][1]+"*s+pet(p), x+"+cps[1][0]+"*s+pet(p), y+"+cps[1][1]+'*s+pet(p), x+' + mousePos.x + '*s+pet(p), y+' + mousePos.y+'*s+pet(p));';
        cps = [];
        context.fillStyle = '#000000';
        context.fillRect(mousePos.x, mousePos.y, 5, 5);
        allpoints.push([mousePos.x, mousePos.y] )
      }
      console.log(allpoints)

      i++;
      if (message !== "") {
        document.getElementById('text1').innerHTML += message+"\n";
      }
    }, false);
    </script>
  </body>
</html>
