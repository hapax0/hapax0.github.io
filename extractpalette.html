<!DOCTYPE html>
<html>
<head>
<style>
  div[class=buttons] {margin-top:8px}
  body {background-color:#ccc;}
  button {background-color:#fff;
   border:none;
   border-radius:4px;
   min-width:24px;
   padding:4px 4px 2px 4px;
  }
  select {width:120px;}
  input, img, span, a{
    vertical-align: middle;
  }
  input[id='lower'] {
   -webkit-transform: rotateY(180deg);
   -moz-transform: rotateY(180deg);
   -ms-transform: rotateY(180deg);
   -o-transform: rotateY(180deg);
   transform: rotateY(180deg);
  }
  #lower{
    transform: rotateY(180deg);
  }
  input[type='number']{
    width: 44px;
  }
  span[class='sample'] {
    display:inline-block;
    width:32px;
    text-align:right;
  }
  input[type='color'] {
    display:inline-block;
    vertical-align: baseline;
  }
  canvas[id='palettecanvas'] {
    margin:4px;
  }
  div[id='background'] {
    background-color: #ffffff;
    opacity: 0.8;
    background-image:  repeating-linear-gradient(45deg, #aaaaaa 25%, transparent 25%, transparent 75%, #aaaaaa 75%, #aaaaaa), repeating-linear-gradient(45deg, #aaaaaa 25%, #ffffff 25%, #ffffff 75%, #aaaaaa 75%, #aaaaaa);
    background-position: 0 0, 10px 10px;
    background-size: 20px 20px;
  }

  svg {background-color:#ccc;}
  svg[class=white] { background-color:#fff;}
</style>
</head>
<body>
<div>
&nbsp;Select image:<input type='file' name='img' size='65' id='uploadimage' style="display:none;">
  <span onclick="openFile()" id="imgloader" title="open image file..."><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-upload" viewBox="0 0 16 16">
    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
  </svg></span>
&nbsp;
<button onclick="extractPalette()">Extract</button>
&nbsp;alt:<input type="checkbox" id="alt" title="alternate method">
&nbsp;Save palette:
<a href="#" id="downloader" onclick="saveAs()" download="image.png" title="save palette as png file"
><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-download" viewBox="0 0 16 16">
  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
</svg></a>
<br>
<canvas id="palettecanvas" width="400" height="80"></canvas><br>
<br>
<canvas id="myCanvas" width="400" height="500" style="border:1px solid #000000;"></canvas>

</div>
<script>

window.onload = function () {
  document.getElementById("uploadimage").addEventListener("change", drawFile, true)
 // let filePicker = document.getElementById("uploadimage");
 // filePicker.addEventListener("click", function(){this.value = null;}, false);
}

function openFile () {
  let canvas = document.getElementById('myCanvas')
  let ctx = canvas.getContext('2d')
  document.getElementById('uploadimage').click();
}

function drawFile () {
  let canvas = document.getElementById('myCanvas')
  let ctx = canvas.getContext('2d')
  let IMG = new Image()
  let f = document.getElementById("uploadimage").files[0]
  let url = window.URL || window.webkitURL
  let src = url.createObjectURL(f);
  IMG.src = src;
  ctx.globalAlpha = 1
  let mode = ctx.globalCompositeOperation
  ctx.globalCompositeOperation = "source-over"
  document.getElementById('mode')
  IMG.onload = function () {
    canvas.height = this.height
    canvas.width = this.width
    ctx.drawImage(IMG, 0, 0);
    resizeCanvas()
    url.revokeObjectURL(src);
  }
  //document.getElementById("uploadimage").value = ""
}

function extractPalette () {
  if (isCanvasBlank(document.getElementById("myCanvas")))
    return
  let colors = colorSamplePalette()
  colors.sort((a, b) => bright(b) - bright(a));
  if (colors.length >= 1) {
    let i = 0, x = 0, y = 0
    let canvas = document.getElementById("palettecanvas")
    let ctx = canvas.getContext("2d");
    ctx.fillStyle = "#cccccc"
    ctx.fillRect(0,0,canvas.width, canvas.height)
    for (; i < colors.length; i++) {
      ctx.fillStyle = colors[i]
      ctx.fillRect(x,y,40,40)
      x += 40
      if (i > 0 && i % 10 === 0) {
        y += 40
        x = 0
      }
    }
  }
}

function colorSamplePalette () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let alt = document.getElementById("alt").checked
  let mind = 1000000
  let maxd = -1000000
  let pixels = imgData.data;
  let sample = []
  let i = 0, j = 0
  for (; i < 6000; i++) {
    let n = 4 * Math.floor(Math.random() * pixels.length/4)
    let c = []
    c.push(pixels[n])
    c.push(pixels[n+1])
    c.push(pixels[n+2])
    sample.push(c)
  }
  i = 0, j = 1
  let m = 0
  for (; i < sample.length; i++) {
    j = i + 1
    for (; j < sample.length; j++) {
      m += dist3d(sample[i], sample[j])
      maxd = (maxd < m)? m: maxd
    }
  }
  let threshold = m/sample.length/sample.length
  let bins = [], bc = 0
  i = 0
  for (;i < sample.length; i++) {
    if (sample[i]) {
      bins.push([sample[i]])
      let bc = bins.length - 1
      j = i + 1
      for (; j < sample.length; j++) {
        if (sample[j] && dist3d(sample[j], bins[bc][0]) < threshold) {
          bins[bc].push(sample[j])
          sample[j] = null
        }
      }
    }
  }
  if (alt)
    bins.sort(function(a, b) { return interesting(b[0]) - interesting(a[0]);});
  else
    bins.sort(function(a, b) { return b.length - a.length;});
  let count = bins.length;
  if (count > 20)
    count = 20
  let colors = [], clrs = []
  i = 0
  for (; i < count; i++) {
    colors.push(averageColor(bins[i]))
    clrs.push(averageColor(bins[i], true))
  }
  //resort clrs by interesting
  clrs.sort(function(a, b) { return interesting(b) - interesting(a);});
  let colors2 = []
  i = 0, j = 0
  for (; i < clrs.length; i++) {
    let rgb = clrs[i]
    let R = ('0'+(rgb[0]).toString(16)).slice(-2),
    G = ('0'+(rgb[1]).toString(16)).slice(-2),
    B = ('0'+(rgb[2]).toString(16)).slice(-2);
    colors2.push('#'+R+G+B)
  }
  return colors2
}

function averageColor (b, dec) {
  let aR = 0, aG = 0, aB = 0
  let i = 0
  for (; i < b.length; i++) {
    aR += b[i][0]
    aG += b[i][1]
    aB += b[i][2]
  }
  aR = Math.floor(aR/b.length)
  aG = Math.floor(aG/b.length)
  aB = Math.floor(aB/b.length)
  let R = ('0'+(aR).toString(16)).slice(-2),
  G = ('0'+(aG).toString(16)).slice(-2),
  B = ('0'+(aB).toString(16)).slice(-2);
  if (dec)
    return [aR,aG,aB]
  else
    return '#'+R+G+B;
}

function hexToR(h) { return parseInt((cutHex(h)).substring(0,2),16) }
function hexToG(h) { return parseInt((cutHex(h)).substring(2,4),16) }
function hexToB(h) { return parseInt((cutHex(h)).substring(4,6),16) }
function cutHex(h) { return (h.charAt(0)=="#") ? h.substring(1,7) : h}

function dist3d (p1, p2) {
  return Math.sqrt(Math.pow(p1[0] - p2[0], 2) + Math.pow(p1[1] - p2[1], 2) + Math.pow(p1[2] - p2[2], 2))
}

function interesting (color) {
  let average = (color[0] + color[1] + color[2])/3
  return Math.abs(color[0] - average) + Math.abs(color[1] - average) + Math.abs(color[2] - average)
}

function interestingB (color) {
  let average = (color[0] + color[1] + color[2])/3
  return  average //+ colorful
}

function bright (c) { //-ness
  return (hexToR(c)*0.2126 + hexToG(c)*0.7152 + hexToB(c)*0.0722)
}

function resizeCanvas () {
  let ocanvas = document.createElement('CANVAS')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  let ar = canvas.width/canvas.height
  if (canvas.width > 500) {
    let W = canvas.width
    canvas.width = 400
    canvas.height = Math.floor(canvas.height * 400/W)
  }
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function saveAs () {
  document.getElementById("downloader").download = "image.png";
  document.getElementById("downloader").href = document.getElementById("palettecanvas").toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
}
// returns true if every pixel's uint32 representation is 0 (or "blank")
function isCanvasBlank(canvas) {
  const context = canvas.getContext('2d');
  const pixelBuffer = new Uint32Array(
    context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
  );
  return !pixelBuffer.some(color => color !== 0);
}
</script>
</body>
</html>