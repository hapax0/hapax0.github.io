<!DOCTYPE html>
<html>
<head>
<style>
  div[class=buttons] {margin-top:8px}
  body {background-color:#ccc;}
  button {background-color:#fff;}
  svg {background-color:#fff;}
  input, img, span, a{
    vertical-align: middle;
  }
  input[type='number']{
    width: 60px;
  }
  div[id='background'] {
    background-color: #ffffff;
    opacity: 0.8;
    background-image:  repeating-linear-gradient(45deg, #aaaaaa 25%, transparent 25%, transparent 75%, #aaaaaa 75%, #aaaaaa), repeating-linear-gradient(45deg, #aaaaaa 25%, #ffffff 25%, #ffffff 75%, #aaaaaa 75%, #aaaaaa);
    background-position: 0 0, 10px 10px;
    background-size: 20px 20px;
  }
</style>
</head>
<body>
<div style="margin-left:8px;">
<div style="font-size:32px;font-weight:bold;">Airbrush</div>
<table border="0" cellpadding="6" style="margin-left:6px;">
  <tr><td style="text-align:right;"><button onclick="resizeFromDialog()">resize</button></td><td>W: <input type="number" id="canvaswidth" min="40" size="6" onchange="checkWidth()">
    H: <input type="number" id="canvasheight" min="40" size="6" onchange="checkHeight()"></td><td style="text-align:right;"></td><td>01-14-22
  </td><td><!--dot mode: <input type="checkbox" id="dotmode"--></td>
  <td rowspan='7'>
    <div style="border-style:solid;margin:10px;padding:10px;">
    <span style="color:red">touch to place text:</span> <input type="checkbox" id="textmode"><br>
    text: &nbsp;<input type="text" id="caption" value="your text here" style="width:10em;"><br>
    font size: &nbsp;<input type="number" id="textsize" value="48" style="width:4em;"><br>
    font: <input list='facelist' id="face" style="width:10em;"><input type='button' class='mockbb' value='X' onclick="clearFace()" title="clear the face field">&nbsp;
    <datalist id="facelist">
      <option value="arial">arial</option>
      <option value="bookman">bookman</option>
      <option value="calibri">calibri</option>
      <option value="century gothic">century gothic</option>
      <option value="courier new">courier new</option>
      <option value="garamond">garamond</option>
      <option value="georgia">georgia</option>
      <option value="palatino">palatino</option>
      <option value="tahoma">tahoma</option>
      <option value="times new roman">times new roman</option>
      <option value="monospace">monospace</option>
      <option value="sans-serif">sans-serif</option>
      <option value="serif">serif</option>
      <option value="cursive">cursive</option>
    </datalist><br>weight:
    <select id="style">
      <option value="normal">normal</option>
      <option value="100">100</option>
      <option value="500">500</option>
      <option value="900">900</option>
      <option value="bold">bold</option>
      <option value="bold italic">bold italic</option>
      <option value= "italic">italic</option>
      <option value="lighter">lighter</option>
    </select>
  </div>
  </td>
  </tr>
  <tr><td style="text-align:right;">canvas size </td><td>
    <select id="canvassizes" onchange="resizeCanvas()">
      <option value="square">square</option>
      <option value="portrait">portrait</option>
      <option value="landscape">landscape</option>
    </select> &nbsp;<span id="redspan" style="color:red;">cut </span><input type="number" step="1" id="rednumber" style="color:red;" onchange="pushMarker()">
    <!--input type="range" id="canvas_size" class="range" min="1" max="5" value="5" onchange="resizeCanvas()"-->
  </td><td style="text-align:right;">sharpness</td><td><button onclick="sharpenCanvas()">+</button>&nbsp;&nbsp;<button onclick="blurCanvas()">-</button></td><td>
    &nbsp;<button onclick="testImage('transformfunctions')" title="transformations"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-shuffle" viewBox="0 0 16 16">
      <path fill-rule="evenodd" d="M0 3.5A.5.5 0 0 1 .5 3H1c2.202 0 3.827 1.24 4.874 2.418.49.552.865 1.102 1.126 1.532.26-.43.636-.98 1.126-1.532C9.173 4.24 10.798 3 13 3v1c-1.798 0-3.173 1.01-4.126 2.082A9.624 9.624 0 0 0 7.556 8a9.624 9.624 0 0 0 1.317 1.918C9.828 10.99 11.204 12 13 12v1c-2.202 0-3.827-1.24-4.874-2.418A10.595 10.595 0 0 1 7 9.05c-.26.43-.636.98-1.126 1.532C4.827 11.76 3.202 13 1 13H.5a.5.5 0 0 1 0-1H1c1.798 0 3.173-1.01 4.126-2.082A9.624 9.624 0 0 0 6.444 8a9.624 9.624 0 0 0-1.317-1.918C4.172 5.01 2.796 4 1 4H.5a.5.5 0 0 1-.5-.5z"/>
      <path d="M13 5.466V1.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192zm0 9v-3.932a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384l-2.36 1.966a.25.25 0 0 1-.41-.192z"/>
    </svg></button>
    <select id="transformfunctions">
      <option value="diss" selected>distress</option>
      <option value="impasto">impasto</option>
      <option value="dotblur" >dot blur</option>
      <option value="dirblur">dir blur</option>
      <option value="jaggyblur">jaggy blur</option>
      <option value="haloblur" style="color:red">halo dot</option>
      <option value="halojaggy" style="color:red">halo jaggy</option>
      <option value="halfRip" style="color:red">left rip</option>
      <option value="halfCurve" style="color:red">left curve</option>
      <option value="leftClip" style="color:red">left clip</option>
      <option value="leftCut" style="color:red">left cut</option>
      <option value="nudgeUp" style="color:red">nudge up</option>
      <option value="nudgeDown" style="color:red">nudge down</option>
      <!--option value="smear">smear shake</option-->
      <option value="smearside">smear right</option>
      <option value="smearrandom">smear random</option>
      <option value="smearrandomoc">smear from off</option>
      <option value="smearzoom">smear zoom</option>
      <option value="reverse">reversible</option>
      <option value="pasta">pasta</option>
      <option value="blasco">blasco</option>
      <option value="shred">shred</option>
      <option value="slices">slices</option>
      <option value="pixelado">pixelado</option>
      <option value="checkerboard">checkerboard</option>
      <option value="diamonds">diamonds</option>
      <option value="dots">dots</option>
      <option value="dashes">dashes</option>
      <option value="holes">holes</option>
      <option value="holes2">holes2</option>
      <!--option value="swap">swap squares</option>
      <option value="swapDiag">swap diagonal</option>
      <option value="rectify">shade squares</option-->
      <option value="tatter">tatter</option>
    </select>
  </td></tr>
  <tr><td style="text-align:right;">feature size</td><td><input type="range" id="speck_size" min="0" max="500" value="25"></td><td style="text-align:right;">saturation</td><td><button onclick="saturationScale(1.1)">+</button>&nbsp;&nbsp;<button onclick="saturationScale(0.9)">-</button>
  </td><td>
    &nbsp;<button onclick="testImage('patternfunctions')" title="patterns"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-bricks" viewBox="0 0 16 16">
  <path d="M0 .5A.5.5 0 0 1 .5 0h15a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H14v2h1.5a.5.5 0 0 1 .5.5v3a.5.5 0 0 1-.5.5H.5a.5.5 0 0 1-.5-.5v-3a.5.5 0 0 1 .5-.5H2v-2H.5a.5.5 0 0 1-.5-.5v-3A.5.5 0 0 1 .5 6H2V4H.5a.5.5 0 0 1-.5-.5v-3zM3 4v2h4.5V4H3zm5.5 0v2H13V4H8.5zM3 10v2h4.5v-2H3zm5.5 0v2H13v-2H8.5zM1 1v2h3.5V1H1zm4.5 0v2h5V1h-5zm6 0v2H15V1h-3.5zM1 7v2h3.5V7H1zm4.5 0v2h5V7h-5zm6 0v2H15V7h-3.5zM1 13v2h3.5v-2H1zm4.5 0v2h5v-2h-5zm6 0v2H15v-2h-3.5z"/>
</svg></button>
    <select id="patternfunctions">
    <option value="specksRadial">specks</option>
    <option value="blobs">blobs</option>
    <option value="fog">fog</option>
    <option value="smudge">smudges</option>
    <option value="smudgewatercolor" >watercolor</option>
    <option value="smudgestreaks">streaks</option>
    <option value="smudgestreaks2" selected>streaks2</option>
    <option value="smudgehorizontal">horizontal</option>
    <option value="smudgehorizontal2">horizontal2</option>
    <option value="skinnyLines">horizontal3</option>
    <option value="smudgearcs">arcs</option>
    <option value="smudgearcs2" >arcs2</option>
    <option value="smudgestars">stars</option>
    <option value="rays">rays</option>
    </select>
  </td>
   
  </tr>
  <tr><td style="text-align:right;">quantity</td><td><input type="range" id="number" min="9" max="20000" value="10000">
  </td><td style="text-align:right;">contrast</td><td><button onclick="contrastImage(5)">+</button>&nbsp;&nbsp;<button onclick="contrastImage(-5)">-</button></td>
  <td>
    &nbsp;<button onclick="testImage('fadefunctions')" title="fade, darken, blur, gray"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-lightbulb" viewBox="0 0 16 16">
      <path d="M2 6a6 6 0 1 1 10.174 4.31c-.203.196-.359.4-.453.619l-.762 1.769A.5.5 0 0 1 10.5 13a.5.5 0 0 1 0 1 .5.5 0 0 1 0 1l-.224.447a1 1 0 0 1-.894.553H6.618a1 1 0 0 1-.894-.553L5.5 15a.5.5 0 0 1 0-1 .5.5 0 0 1 0-1 .5.5 0 0 1-.46-.302l-.761-1.77a1.964 1.964 0 0 0-.453-.618A5.984 5.984 0 0 1 2 6zm6-5a5 5 0 0 0-3.479 8.592c.263.254.514.564.676.941L5.83 12h4.342l.632-1.467c.162-.377.413-.687.676-.941A5 5 0 0 0 8 1z"/>
    </svg></button>
    <select id="fadefunctions">
    <option value="sobel">sobel</option>
    <option value="emboseCanvas">embose</option>
    <option value="edgeDarken" style="color:red">darken edges</option>
    <option value="edgeBlur" style="color:red">blur edges</option>
    <option value="edgeGrey" style="color:red">gray edges</option>
    <option value="vig" style="color:red">fade center</option>
    <option value="haze">haze</option>
    <option value="transparenter">fade all</option>
    <option value="leftFade">fade left</option>
    <option value="downFade">fade dowm</option>
    <option value="chaze">edge haze</option>
    <option value="rectFrame">rect frame</option>
    <option value="framePolaroid">polaroid frame</option>
    <option value="frame">jaggy frame</option>
    <option value="ripFrame">rip frame</option>
    <option value="makeSquare" selected>pad to square</option>
    <option value="makeSquare2">skewed square</option>
    </select>
  </td></tr>
  <tr>
    <td style="text-align:right;">opacity</td><td><input type="range" id="speck_opacity" min="1" max="100" value="100" ></td>
    <td style="text-align:right;">&nbsp;brightness
</td><td>
  <button onclick="adjustBrightness(5)">+</button>&nbsp;&nbsp;<button onclick="adjustBrightness(-5)">-</button>
</td>
<td>
  &nbsp;<button onclick="testImage('drawingfunctions')" title="drawing functions">
    <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-brush" viewBox="0 0 16 16">
      <path d="M15.825.12a.5.5 0 0 1 .132.584c-1.53 3.43-4.743 8.17-7.095 10.64a6.067 6.067 0 0 1-2.373 1.534c-.018.227-.06.538-.16.868-.201.659-.667 1.479-1.708 1.74a8.118 8.118 0 0 1-3.078.132 3.659 3.659 0 0 1-.562-.135 1.382 1.382 0 0 1-.466-.247.714.714 0 0 1-.204-.288.622.622 0 0 1 .004-.443c.095-.245.316-.38.461-.452.394-.197.625-.453.867-.826.095-.144.184-.297.287-.472l.117-.198c.151-.255.326-.54.546-.848.528-.739 1.201-.925 1.746-.896.126.007.243.025.348.048.062-.172.142-.38.238-.608.261-.619.658-1.419 1.187-2.069 2.176-2.67 6.18-6.206 9.117-8.104a.5.5 0 0 1 .596.04zM4.705 11.912a1.23 1.23 0 0 0-.419-.1c-.246-.013-.573.05-.879.479-.197.275-.355.532-.5.777l-.105.177c-.106.181-.213.362-.32.528a3.39 3.39 0 0 1-.76.861c.69.112 1.736.111 2.657-.12.559-.139.843-.569.993-1.06a3.122 3.122 0 0 0 .126-.75l-.793-.792zm1.44.026c.12-.04.277-.1.458-.183a5.068 5.068 0 0 0 1.535-1.1c1.9-1.996 4.412-5.57 6.052-8.631-2.59 1.927-5.566 4.66-7.302 6.792-.442.543-.795 1.243-1.042 1.826-.121.288-.214.54-.275.72v.001l.575.575zm-4.973 3.04.007-.005a.031.031 0 0 1-.007.004zm3.582-3.043.002.001h-.002z"/>
    </svg></button>
  <select id="drawingfunctions" >
    <option value="shape">right shape</option>
    <option value="hrips">rips</option>
    <option value="land">land</option>
    <option value="spiral4">scribble</option>
    <option value="script" selected>script</option>
    <option value="diagonal">diagonal</option>
    <option value="randomTexture" >random texture</option>
    <option value="landscape2">landscape</option>
    <option value="landscape3">landscape2</option>
    <option value="paperish">paperish</option>
    <option value="coloringbook">coloring book</option>
    <option value="edgeSmear">streak left</option>
    <option value="smeardownOff">vertical streaks</option>
    <option value="strokes">strokes</option>
    <option value="strokes2">strokes2</option>
    <option value="birds">birds</option>
    <option value="grid">grid</option>
    <option value="dotmode" style="color:red">dot mode</option>
    <!--option value="rothko">rothko</option-->
  </select>
</td>
</tr>
<tr><td>grunge: <input type="checkbox" id="grungy">
</td><td style="text-align:right;">
  mode: <select id="mode">
    <option value="source-over" selected>source-over</option>
    <option value="source-in">source-in</option>
    <option value="source-out">source-out</option>
    <option value="source-atop">source-atop</option>
    <option value="destination-over">destination-over</option>
    <option value="destination-in">destination-in</option>
    <option value="destination-out">destination-out</option>
    <option value="destination-atop">destination-atop</option>
    <option value="darken">darken</option>
    <option value="lighten">lighten</option>
    <option value="color">color</option>
    <option value="hue">hue</option>
    <option value="saturation">saturation</option>
    <option value="luminosity">luminosity</option>
    <option value="xor">xor</option>
  </select>
 </td><td>&nbsp;warmth</td>
  <td>
    <button onclick="adjustWarmth(5)">+</button>&nbsp;&nbsp;<button onclick="adjustWarmth(-5)">-</button>
</td><td>
&nbsp;<button id="cf" onclick="testImage('colorfunctions')" title="color functions"><svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" class="bi bi-funnel" viewBox="0 0 16 16">
  <path d="M1.5 1.5A.5.5 0 0 1 2 1h12a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-.128.334L10 8.692V13.5a.5.5 0 0 1-.342.474l-3 1A.5.5 0 0 1 6 14.5V8.692L1.628 3.834A.5.5 0 0 1 1.5 3.5v-2zm1 .5v1.308l4.372 4.858A.5.5 0 0 1 7 8.5v5.306l2-.666V8.5a.5.5 0 0 1 .128-.334L13.5 3.308V2h-11z"/>
</svg></button>
<select id='colorfunctions'>
    <option value="colorFilterOut" >filter selected</option>
    <option value="colorFilter">filter unselected</option>
    <option value="alphaWhite">filter light</option>
    <option value="alphaBlack">filter dark</option>
    <option value="filterGrays">filter grays</option>
    <option value="filterRed">filter red</option>
    <option value="filterGreen">filter green</option>
    <option value="filterBlue">filter blue</option>
    <option value="highContrast">high contrast</option>
    <option value="threshold">threshold</option>
    <option value="posterize">posterize</option>
    <option value="colorSample">simplify colors</option>
    <option value="sample3colors">CYM</option>
    <option value="sampleImageData">sample lightness</option>
    <option value="sampleImageDataColor">sample colors</option>
    <option value="sampleImageDataColor2" >sample colors2</option>
    <option value="pointillism" selected>pointillism</option>
    <option value="pointillism2" selected>pointillism2</option>

</select>

</td></tr>
</table>
<div style='margin:4px;'>
  
<span>color: <input type="color" id="paintcolor" style="margin-bottom:6px;">&nbsp;</span>
<a href="javascript:randomPickColor()" title='random color'>
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-palette" viewBox="0 0 16 16">
  <path d="M8 5a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zm4 3a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3zM5.5 7a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6a1.5 1.5 0 1 0 0-3 1.5 1.5 0 0 0 0 3z"/>
  <path d="M16 8c0 3.15-1.866 2.585-3.567 2.07C11.42 9.763 10.465 9.473 10 10c-.603.683-.475 1.819-.351 2.92C9.826 14.495 9.996 16 8 16a8 8 0 1 1 8-8zm-8 7c.611 0 .654-.171.655-.176.078-.146.124-.464.07-1.119-.014-.168-.037-.37-.061-.591-.052-.464-.112-1.005-.118-1.462-.01-.707.083-1.61.704-2.314.369-.417.845-.578 1.272-.618.404-.038.812.026 1.16.104.343.077.702.186 1.025.284l.028.008c.346.105.658.199.953.266.653.148.904.083.991.024C14.717 9.38 15 9.161 15 8a7 7 0 1 0-7 7z"/>
</svg></a>
&nbsp;<input type='file' name='img' size='65' id='uploadimage' style="display:none;">
  <span onclick="openFile()" id="imgloader" title="open image file..."><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-upload" viewBox="0 0 16 16">
    <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
    <path d="M7.646 1.146a.5.5 0 0 1 .708 0l3 3a.5.5 0 0 1-.708.708L8.5 2.707V11.5a.5.5 0 0 1-1 0V2.707L5.354 4.854a.5.5 0 1 1-.708-.708l3-3z"/>
  </svg></span>
&nbsp;
<a href="#" id="downloader" onclick="saveAs()" download="image.png" title="save as png file"
><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-download" viewBox="0 0 16 16">
  <path d="M.5 9.9a.5.5 0 0 1 .5.5v2.5a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1v-2.5a.5.5 0 0 1 1 0v2.5a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2v-2.5a.5.5 0 0 1 .5-.5z"/>
  <path d="M7.646 11.854a.5.5 0 0 0 .708 0l3-3a.5.5 0 0 0-.708-.708L8.5 10.293V1.5a.5.5 0 0 0-1 0v8.793L5.354 8.146a.5.5 0 1 0-.708.708l3 3z"/>
</svg></a>
&nbsp;
<span onclick="copyToOff()" id="copybutton" title="copy canvas offscreen">
 <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#087aea" class="bi bi-clipboard-check" viewBox="0 0 64 64">
  <path d="M45,6h-5c-0.9-3.5-4.2-6-7.9-6c-3.7,0-7.2,2.5-8.1,6h-5v11h26V6z M32,10c-1.1,0-2-0.9-2-2c0-1.1,0.9-2,2-2s2,0.9,2,2
				C34,9.1,33.1,10,32,10z"/>
	<path d="M52,11h-3v10H15V11h-3c-2.2,0-4,1.8-4,4v45c0,2.2,1.8,4,4,4h40c2.2,0,4-1.8,4-4V15C56,12.8,54.2,11,52,11z"/>
</svg></span>
&nbsp;
 <span onclick="pasteFromOff()" id="pastebutton" title="paste from offscreen"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#087aea" class="bi bi-layers-fill" viewBox="0 0 16 16">
  <path d="M7.765 1.559a.5.5 0 0 1 .47 0l7.5 4a.5.5 0 0 1 0 .882l-7.5 4a.5.5 0 0 1-.47 0l-7.5-4a.5.5 0 0 1 0-.882l7.5-4z"/>
  <path d="m2.125 8.567-1.86.992a.5.5 0 0 0 0 .882l7.5 4a.5.5 0 0 0 .47 0l7.5-4a.5.5 0 0 0 0-.882l-1.86-.992-5.17 2.756a1.5 1.5 0 0 1-1.41 0l-5.17-2.756z"/>
</svg></span>
&nbsp;
<a href="javascript:clearOff()" title="clear offscreen">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="#087aea" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
</svg></a>
&nbsp;
<a href="javascript:flipH()">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow-left-right" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M1 11.5a.5.5 0 0 0 .5.5h11.793l-3.147 3.146a.5.5 0 0 0 .708.708l4-4a.5.5 0 0 0 0-.708l-4-4a.5.5 0 0 0-.708.708L13.293 11H1.5a.5.5 0 0 0-.5.5zm14-7a.5.5 0 0 1-.5.5H2.707l3.147 3.146a.5.5 0 1 1-.708.708l-4-4a.5.5 0 0 1 0-.708l4-4a.5.5 0 1 1 .708.708L2.707 4H14.5a.5.5 0 0 1 .5.5z"/>
</svg></a>
&nbsp;
<a href="javascript:flipV()">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow-down-up" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M11.5 15a.5.5 0 0 0 .5-.5V2.707l3.146 3.147a.5.5 0 0 0 .708-.708l-4-4a.5.5 0 0 0-.708 0l-4 4a.5.5 0 1 0 .708.708L11 2.707V14.5a.5.5 0 0 0 .5.5zm-7-14a.5.5 0 0 1 .5.5v11.793l3.146-3.147a.5.5 0 0 1 .708.708l-4 4a.5.5 0 0 1-.708 0l-4-4a.5.5 0 0 1 .708-.708L4 13.293V1.5a.5.5 0 0 1 .5-.5z"/>
</svg></a>
&nbsp;
<a href="javascript:rc()" title="rotate clockwise">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow-clockwise" viewBox="0 0 16 16">
    <path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/>
    <path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/>
  </svg></a>
&nbsp;
<a href="javascript:rcc()" title="rotate counter-clockwise">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow-counterclockwise" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M8 3a5 5 0 1 1-4.546 2.914.5.5 0 0 0-.908-.417A6 6 0 1 0 8 2v1z"/>
  <path d="M8 4.466V.534a.25.25 0 0 0-.41-.192L5.23 2.308a.25.25 0 0 0 0 .384l2.36 1.966A.25.25 0 0 0 8 4.466z"/>
</svg></a>
&nbsp;
<a href="javascript:zoom()" title="zoom canvas">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrows-angle-expand" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M5.828 10.172a.5.5 0 0 0-.707 0l-4.096 4.096V11.5a.5.5 0 0 0-1 0v3.975a.5.5 0 0 0 .5.5H4.5a.5.5 0 0 0 0-1H1.732l4.096-4.096a.5.5 0 0 0 0-.707zm4.344-4.344a.5.5 0 0 0 .707 0l4.096-4.096V4.5a.5.5 0 1 0 1 0V.525a.5.5 0 0 0-.5-.5H11.5a.5.5 0 0 0 0 1h2.768l-4.096 4.096a.5.5 0 0 0 0 .707z"/>
</svg></a>
&nbsp;
<a href="javascript:zoom_neg()" title="zoom canvas">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrows-angle-contract" viewBox="0 0 16 16">
  <path fill-rule="evenodd" d="M.172 15.828a.5.5 0 0 0 .707 0l4.096-4.096V14.5a.5.5 0 1 0 1 0v-3.975a.5.5 0 0 0-.5-.5H1.5a.5.5 0 0 0 0 1h2.768L.172 15.121a.5.5 0 0 0 0 .707zM15.828.172a.5.5 0 0 0-.707 0l-4.096 4.096V1.5a.5.5 0 1 0-1 0v3.975a.5.5 0 0 0 .5.5H14.5a.5.5 0 0 0 0-1h-2.768L15.828.879a.5.5 0 0 0 0-.707z"/>
</svg></a>
&nbsp;
<a href="javascript:expandMargins(true)" title="add/increase margins">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow" viewBox="0 0 16 16">
<path d="M 15,2 C 15,1.4477153 14.552285,1 14,1 H 2 C 1.4477153,1 1,1.4477153 1,2 v 12 c 0,0.552285 0.4477153,1 1,1 h 12 c 0.552285,0 1,-0.447715 1,-1 z M 0,2 C 0,0.8954305 0.8954305,0 2,0 h 12 c 1.104569,0 2,0.8954305 2,2 v 12 c 0,1.104569 -0.895431,2 -2,2 H 2 C 0.8954305,16 0,15.104569 0,14 Z" id="path2" style="fill-rule:evenodd" />
  <rect style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:0.93606186;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" id="rect839" width="8.4021072" height="8.7749891" x="3.6633532" y="3.595556" />
</svg></a>
&nbsp;
<a href="javascript:expandMargins()" title="increase bottom margin">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-arrow-down-square" viewBox="0 0 16 16">
<path d="M 15,2 C 15,1.4477153 14.552285,1 14,1 H 2 C 1.4477153,1 1,1.4477153 1,2 v 12 c 0,0.552285 0.4477153,1 1,1 h 12 c 0.552285,0 1,-0.447715 1,-1 z M 0,2 C 0,0.8954305 0.8954305,0 2,0 h 12 c 1.104569,0 2,0.8954305 2,2 v 12 c 0,1.104569 -0.895431,2 -2,2 H 2 C 0.8954305,16 0,15.104569 0,14 Z" id="path2" style="fill-rule:evenodd" />
  <rect style="fill:#000000;fill-opacity:1;stroke:#000000;stroke-width:1.30432093;stroke-linejoin:round;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1" id="rect839" width="13.72476" height="10.430133" x="1.3377649" y="1.2764586" />
</svg></a>
&nbsp;
<a href="javascript:fill()" title="fill"><svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="black" class="bi bi-bucket-fill" viewBox="0 0 16 16">
  <path d="M2.522 5H2a.5.5 0 0 0-.494.574l1.372 9.149A1.5 1.5 0 0 0 4.36 16h7.278a1.5 1.5 0 0 0 1.483-1.277l1.373-9.149A.5.5 0 0 0 14 5h-.522A5.5 5.5 0 0 0 2.522 5zm1.005 0a4.5 4.5 0 0 1 8.945 0H3.527z"/></svg></a>
&nbsp;
<a href="javascript:greyScale()" title="convert to greyscale">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="grey" class="bi bi-palette-fill" viewBox="0 0 16 16">
  <path d="M12.433 10.07C14.133 10.585 16 11.15 16 8a8 8 0 1 0-8 8c1.996 0 1.826-1.504 1.649-3.08-.124-1.101-.252-2.237.351-2.92.465-.527 1.42-.237 2.433.07zM8 5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zm4.5 3a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3zM5 6.5a1.5 1.5 0 1 1-3 0 1.5 1.5 0 0 1 3 0zm.5 6.5a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z"/>
</svg></a>
&nbsp;
<a href="javascript:invertColors()" title="invert colors">
<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="30" height="30" fill="black" class="bi bi-square" viewBox="0 0 16 16" version="1.1" id="svg4" sodipodi:docname="spiral.svg" inkscape:version="0.92.4 (5da689c313, 2019-01-14)">
  <metadata   id="metadata10">  <rdf:RDF>    <cc:Work       rdf:about="">      <dc:format>image/svg+xml</dc:format>      <dc:type         rdf:resource="http://purl.org/dc/dcmitype/StillImage" />      <dc:title />    </cc:Work>  </rdf:RDF>
  </metadata>
  <defs   id="defs8" />
  <sodipodi:namedview   pagecolor="#ffffff"   bordercolor="#666666"   borderopacity="1"   objecttolerance="10"   gridtolerance="10"   guidetolerance="10"   inkscape:pageopacity="0"   inkscape:pageshadow="2"   inkscape:window-width="2072"   inkscape:window-height="1160"   id="namedview6"   showgrid="false"   inkscape:zoom="19.666667"   inkscape:cx="1.0038413"   inkscape:cy="12.028218"   inkscape:window-x="30"   inkscape:window-y="20"   inkscape:window-maximized="1"   inkscape:current-layer="svg4" />
  <path   style="fill:#080907;fill-opacity:0.99041533;stroke:#000000;stroke-width:0.35413408;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:1"   d="M 7.8490935,9.3582994 C 7.9125109,15.175258 8.0046144,15.190446 8.0046144,15.190446 4.6226405,15.292508 2.3125978,12.610557 2.3125978,9.5345523 2.3125978,6.458548 5.0547716,4.9796141 7.771333,0.99629336 7.7355147,6.4754756 7.8136598,6.1079957 7.8490935,9.3582994 Z"   id="path868"   inkscape:connector-curvature="0"   sodipodi:nodetypes="ssscs" />
  <path   sodipodi:nodetypes="ssscs"   inkscape:connector-curvature="0"   id="path871"   d="m 8.1290313,9.3898868 c -0.063417,5.8169592 -0.2799378,5.7847662 -0.2799378,5.7847662 3.3819755,0.102062 5.4431455,-2.564096 5.4431455,-5.6400996 0,-3.0760053 -2.446648,-4.4826064 -5.1632077,-8.465928 0.035818,5.479183 0.035433,5.0709575 0,8.3212614 z"   style="fill:none;fill-opacity:0.99041533;stroke:#000000;stroke-width:0.40277886;stroke-miterlimit:4;stroke-dasharray:none;stroke-opacity:0.99680511" />
</svg></a>

&nbsp;
<a href="javascript:clearCanvas()" title="clear canvas">
  <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="red" class="bi bi-x-circle-fill" viewBox="0 0 16 16">
  <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0zM5.354 4.646a.5.5 0 1 0-.708.708L7.293 8l-2.647 2.646a.5.5 0 0 0 .708.708L8 8.707l2.646 2.647a.5.5 0 0 0 .708-.708L8.707 8l2.647-2.646a.5.5 0 0 0-.708-.708L8 7.293 5.354 4.646z"/>
</svg></a>
&nbsp;
<a href="info.html" title="info">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="blue" class="bi bi-info-circle-fill" viewBox="0 0 16 16">
  <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm.93-9.412-1 4.705c-.07.34.029.533.304.533.194 0 .487-.07.686-.246l-.088.416c-.287.346-.92.598-1.465.598-.703 0-1.002-.422-.808-1.319l.738-3.468c.064-.293.006-.399-.287-.47l-.451-.081.082-.381 2.29-.287zM8 5.5a1 1 0 1 1 0-2 1 1 0 0 1 0 2z"/>
</svg></a>

&nbsp;
<a href="javascript:showMode()" title="show canvas info">
<svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" fill="blue" class="bi bi-bug-fill" viewBox="0 0 16 16">
  <path d="M4.978.855a.5.5 0 1 0-.956.29l.41 1.352A4.985 4.985 0 0 0 3 6h10a4.985 4.985 0 0 0-1.432-3.503l.41-1.352a.5.5 0 1 0-.956-.29l-.291.956A4.978 4.978 0 0 0 8 1a4.979 4.979 0 0 0-2.731.811l-.29-.956z"/>
  <path d="M13 6v1H8.5v8.975A5 5 0 0 0 13 11h.5a.5.5 0 0 1 .5.5v.5a.5.5 0 1 0 1 0v-.5a1.5 1.5 0 0 0-1.5-1.5H13V9h1.5a.5.5 0 0 0 0-1H13V7h.5A1.5 1.5 0 0 0 15 5.5V5a.5.5 0 0 0-1 0v.5a.5.5 0 0 1-.5.5H13zm-5.5 9.975V7H3V6h-.5a.5.5 0 0 1-.5-.5V5a.5.5 0 0 0-1 0v.5A1.5 1.5 0 0 0 2.5 7H3v1H1.5a.5.5 0 0 0 0 1H3v1h-.5A1.5 1.5 0 0 0 1 11.5v.5a.5.5 0 1 0 1 0v-.5a.5.5 0 0 1 .5-.5H3a5 5 0 0 0 4.5 4.975z"/>
</svg></a>
<!--
<a href="javascript:flipStrip()" title='flip random strip vertical'>
<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="30" height="30" fill="black" class="bi bi-square" viewBox="0 0 16 16" version="1.1" id="svg4" sodipodi:docname="randomrectH.svg" inkscape:version="0.92.4 (5da689c313, 2019-01-14)">
  <metadata   id="metadata10">  <rdf:RDF>    <cc:Work       rdf:about="">      <dc:format>image/svg+xml</dc:format>      <dc:type         rdf:resource="http://purl.org/dc/dcmitype/StillImage" />      <dc:title></dc:title>    </cc:Work>  </rdf:RDF>
  </metadata>
  <defs   id="defs8">  <linearGradient     inkscape:collect="always"     id="linearGradient4624">    <stop       style="stop-color:#930000;stop-opacity:0"       offset="0"       id="stop4620" />    <stop       style="stop-color:#000000;stop-opacity:0;"       offset="1"       id="stop4622" />  </linearGradient>  <linearGradient     inkscape:collect="always"     xlink:href="#linearGradient4624"     id="linearGradient4626"     x1="-15.254237"     y1="-3.9322028"     x2="-7.0847454"     y2="-3.9661012"     gradientUnits="userSpaceOnUse"     gradientTransform="matrix(0.95034692,0,0,1.1975809,5.8033975,-1.9426262)" />
  </defs>
  <sodipodi:namedview   pagecolor="#ffffff"   bordercolor="#666666"   borderopacity="1"   objecttolerance="10"   gridtolerance="10"   guidetolerance="10"   inkscape:pageopacity="0"   inkscape:pageshadow="2"   inkscape:window-width="2072"   inkscape:window-height="1160"   id="namedview6"   showgrid="false"   inkscape:zoom="19.666667"   inkscape:cx="-6.3050839"   inkscape:cy="10.77966"   inkscape:window-x="30"   inkscape:window-y="20"   inkscape:window-maximized="1"   inkscape:current-layer="svg4" />
  <rect   style="fill:#8f8f8f;fill-opacity:0.95692306;stroke:url(#linearGradient4626);stroke-width:0.71121722"   id="rect4618"   width="14.303526"   height="3.6536365"   x="-15.136449"   y="-8.3567896"   transform="matrix(0,-1,-1,0,0,0)" />
  <path   d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"   id="path2"   style="fill:#000000;fill-opacity:1" />
</svg></a>
&nbsp;
<a href="javascript:flipStripH()" title='flip random strip horizontal'>
<svg xmlns:dc="http://purl.org/dc/elements/1.1/" xmlns:cc="http://creativecommons.org/ns#" xmlns:rdf="http://www.w3.org/1999/02/22-rdf-syntax-ns#" xmlns:svg="http://www.w3.org/2000/svg" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" xmlns:sodipodi="http://sodipodi.sourceforge.net/DTD/sodipodi-0.dtd" xmlns:inkscape="http://www.inkscape.org/namespaces/inkscape" width="30" height="30" fill="black" class="bi bi-square" viewBox="0 0 16 16" version="1.1" id="svg4" sodipodi:docname="randomrectH.svg" inkscape:version="0.92.4 (5da689c313, 2019-01-14)">
  <metadata   id="metadata10">  <rdf:RDF>    <cc:Work       rdf:about="">      <dc:format>image/svg+xml</dc:format>      <dc:type         rdf:resource="http://purl.org/dc/dcmitype/StillImage" />      <dc:title></dc:title>    </cc:Work>  </rdf:RDF>
  </metadata>
  <defs   id="defs8">  <linearGradient     inkscape:collect="always"     id="linearGradient4624">    <stop       style="stop-color:#930000;stop-opacity:0"       offset="0"       id="stop4620" />    <stop       style="stop-color:#000000;stop-opacity:0;"       offset="1"       id="stop4622" />  </linearGradient>  <linearGradient     inkscape:collect="always"     xlink:href="#linearGradient4624"     id="linearGradient4626"     x1="-15.254237"     y1="-3.9322028"     x2="-7.0847454"     y2="-3.9661012"     gradientUnits="userSpaceOnUse"     gradientTransform="matrix(0.95034692,0,0,1.1975809,5.8343839,10.843218)" />
  </defs>
  <sodipodi:namedview   pagecolor="#ffffff"   bordercolor="#666666"   borderopacity="1"   objecttolerance="10"   gridtolerance="10"   guidetolerance="10"   inkscape:pageopacity="0"   inkscape:pageshadow="2"   inkscape:window-width="2072"   inkscape:window-height="1160"   id="namedview6"   showgrid="false"   inkscape:zoom="19.666667"   inkscape:cx="-6.3050839"   inkscape:cy="10.77966"   inkscape:window-x="30"   inkscape:window-y="20"   inkscape:window-maximized="1"   inkscape:current-layer="svg4" />
  <rect   style="fill:#8f8f8f;fill-opacity:0.95692307;stroke:url(#linearGradient4626);stroke-width:0.71121722"   id="rect4618"   width="14.303526"   height="3.6536365"   x="-15.105463"   y="4.4290547"   transform="scale(-1,1)" />
  <path   d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"   id="path2"   style="fill:#000000;fill-opacity:1" />
</svg></a-->
<br>
<canvas id="marker" width='512' height='6' style="border:1px solid #000000;" title="touch canvas: red mark shows location of clip or rip"></canvas>
<div id="background" style="width:1024px;height:1024px;float:left;position:absolute;">
<canvas id="myCanvas" width="512" height="512" style="border:1px solid #000000;">
</canvas><canvas id="OC" width="512" height="512" style="border:1px solid #000000;display:none;"></canvas>
</div>

</div>
<div>
</div>
<br>
 <div sytle="display:none;">
   <canvas id="offscreen" width='512' height='512' hidden></canvas>
 </div>
  <div sytle="display:none;">
   <canvas id="off" width='512' height='512' sytle="visibility:hidden;"></canvas>
 </div>
 <br><br>

<script>
let BLACK = 0
let LASTCLICK = [512,512]

window.onload = function () {
  let myCanvas = document.getElementById("myCanvas")
  let ctx = myCanvas.getContext("2d")
  ctx.imageSmoothingEnabled = false
  document.getElementById("face").value = "monospace"
  resizeCanvas()
  LASTCLICK[0] = myCanvas.width/2
  LASTCLICK[1] = myCanvas.height/2
  myCanvas.addEventListener('click', function(event) {
    var rect = myCanvas.getBoundingClientRect();
    var x = event.clientX - rect.left;
    var y = event.clientY - rect.top;
    LASTCLICK = []
    LASTCLICK.push(x)
    LASTCLICK.push(y)
    syncMarker()
    let textmode = document.getElementById("textmode").checked
    if (textmode)
      drawTextAt()
    if (document.getElementById("drawingfunctions").value == "dotmode" && !textmode)
      clearDotAt()
}, false);
let marker = document.getElementById("marker")
marker.addEventListener('click', function(event) {
    var rect = marker.getBoundingClientRect();
    var x = event.clientX - rect.left;
   // var y = event.clientY - rect.top;
    //LASTCLICK = []
    LASTCLICK[0] = x
    //LASTCLICK.push(y)
    
    syncMarker()
}, false);

  document.getElementById("mode").addEventListener ('change', function(event) {
    refreshMode()
  }, false);
  
  let result = document.getElementById("background")
  result.style.backgroundColor = "#fff";
  document.getElementById("paintcolor").value = randomColor()
  const selectElement = document.getElementById("mode");
  selectElement.addEventListener('change', (event) => {
  let ctx = document.getElementById("myCanvas").getContext("2d");
  ctx.globalCompositeOperation = selectElement.value
  let filePicker = document.getElementById("uploadimage");
  filePicker.addEventListener("click", function(){this.value = null;}, false);
  });
  syncMarker()
}

function dotmode () {
  alert("Dot mode is enabled.\nClick or tap the canvas to draw a dot.")
}

function showResize() {
  let canvas = document.getElementById("myCanvas");
  let d = document.getElementById("resize")
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  d.showModal()
}

// returns true if every pixel's uint32 representation is 0 (or "blank")
function isCanvasBlank(canvas) {
  const context = canvas.getContext('2d');
  const pixelBuffer = new Uint32Array(
    context.getImageData(0, 0, canvas.width, canvas.height).data.buffer
  );
  return !pixelBuffer.some(color => color !== 0);
}

function getRatio () {
  let canvas = document.getElementById("myCanvas");
  return canvas.width/canvas.height
}

function checkWidth () {
  if (isCanvasBlank(document.getElementById("myCanvas")))
    return
  let ratio = getRatio()
  let w = document.getElementById('canvaswidth').value
  let h = document.getElementById('canvasheight').value
  if (isNaN(w) || w == 0)
    return
  // w centric
  if (w/h != ratio)
    h = w / ratio
   document.getElementById('canvasheight').value = Math.floor(h)
}

function checkHeight () {
  if (isCanvasBlank(document.getElementById("myCanvas")))
    return
  let ratio = getRatio()
  let w = document.getElementById('canvaswidth').value
  let h = document.getElementById('canvasheight').value
  if (isNaN(h) || h == 0)
    return
  // w centric
  if (w/h != ratio)
    w = h * ratio
   document.getElementById('canvaswidth').value = Math.floor(w)
}

function resizeFromDialog () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  let h = document.getElementById("canvasheight").value
  let w = document.getElementById("canvaswidth").value
  if (h < 40 || w < 40) {
    alert("minimum dimension must 40 or larger")
    document.getElementById("canvasheight").value = canvas.height
    document.getElementById("canvaswidth").value = canvas.width
    return
  }
  canvas.width = w
  canvas.height = h
  syncBackground(canvas)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
 // LASTCLICK[0] = myCanvas.width/2
 // LASTCLICK[1] = myCanvas.height/2
  ctx.globalCompositeOperation = mode
}

function pushMarker() {
  let m = document.getElementById("marker")
  let w = document.getElementById("myCanvas").width
  let value = document.getElementById("rednumber").value
  let s = Math.floor(value)
  if (w <= value)
    value = w/3
  if (value < 1)
    value = 1
  document.getElementById("rednumber").value = value
  LASTCLICK[0] = value
  m.width = w
  ctx = m.getContext("2d")
  ctx.fillStyle = "#ffffff"
  ctx.fillRect(0,0,m.width,m.height)
  let x = s
  m.title = s
  document.getElementById("rednumber").value = +s
  ctx.fillStyle = "#ff0000"
  ctx.beginPath()
  ctx.moveTo(0,0)
  ctx.lineTo(x,0)
  ctx.lineTo(x,6)
  ctx.lineTo(0,6)
  ctx.closePath()
  ctx.fill()
}

function syncMarker () {
  let m = document.getElementById("marker")
  let w = document.getElementById("myCanvas").width
  let s = Math.floor(LASTCLICK[0])
  m.width = w
  ctx = m.getContext("2d")
  ctx.fillStyle = "#ffffff"
  ctx.fillRect(0,0,m.width,m.height)
  let x = s
  m.title = s
  document.getElementById("rednumber").value = +s
  ctx.fillStyle = "#ff0000"
  ctx.beginPath()
  ctx.moveTo(0,0)
  ctx.lineTo(x,0)
  ctx.lineTo(x,6)
  ctx.lineTo(0,6)
  ctx.closePath()
  ctx.fill()
}

function showMode () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  alert(objToString(ctx))
}

function objToString (obj) {
    var str = '';
    for (var p in obj) {
      str += p + '::' + obj[p] + '\n';
    }
    return str;
}

function textTool () {
  window.open("text tool.html")
}

function setDate () {
  let d = document.getElementById("bdate")
  let date = new Date()
  d.innerHTML = date.toString().substring(0,25)
}

function swapDiag () {// number to divide height by, to match width's divisor
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let W = 2 + Math.floor(document.getElementById("speck_size").value/10)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100

  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = w
  let N = wdivs * hdivs
  let temp = document.createElement('CANVAS')
  let tempctx = temp.getContext("2d")
  temp.width = canvas.width
  temp.height = canvas.height
  tempctx.drawImage(canvas, 0, 0, temp.width, temp.height)
  let grunge = document.getElementById("grungy").checkd

  let sx = 0, sy = 0
  let dx = 0, dy = 0
  tempctx.imageSmoothingEnabled = false
  ctx.imageSmoothingEnabled = false
  for (; i < wdivs; i++) {
    let j = 0
    for (; j < wdivs; j++) {
      sx = i, sy = j
      dx = j, dy = i
      if (grunge)
        tempctx.translate(pt(20), pt(20))
      ctx.drawImage(temp, dx*w, dy*h, w, h, sx*w, sy*h, w, h)
      ctx.drawImage(temp, sx*w, sy*h, w, h, dx*w, dy*h, w, h)
    }
  }
}

function diss () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let color = document.getElementById("paintcolor").value
  let mode = ctx.globalCompositeOperation
  functions = ["smudge", "smudge", "smudge", "rays", /*"specksRadial"*/]
  let args = ["", "streaks", "streaks2", "arcs", "arcs2", "stars", "horizontal"]
  document.getElementById("number").value = 3 + Math.random() * 10000
  document.getElementById("speck_size").value = 1 + Math.random() * 400
  document.getElementById("speck_opacity").value = 15 + Math.random() + 45
  let nf = 3 + Math.floor(Math.random() * 5)
  ctx.globalCompositeOperation = "destination-out"
  let i = 0
  for (; i < nf; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 5 + Math.random() * 200
    document.getElementById("speck_opacity").value = 25 + Math.random() + 55
    window[f](a)
  }
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  contrastImage(5 + Math.random() *11)
  document.getElementById("speck_opacity").value = val
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalCompositeOperation = "destination-over"
  document.getElementById("paintcolor").value = color
  fill()
  //restore values
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("paintcolor").value = color
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
}

function dissOver () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")

  functions = ["smudge", "smudge", "smudge"]
  let args = ["", "streaks", "streaks2", "arcs", "arcs2", "stars", "horizontal"]
  let nf = 3 + Math.floor(Math.random() * 5)
  let i = 0
  for (; i < nf; i++) {
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    window[f](a)
  }
 // contrastImage(5 + Math.random() *11)
}

function pasteFromOffColor () {
  let OC = document.getElementById('OC')
  if (OC && OC.width > 0) {
    let canvas = document.getElementById('myCanvas')
    let ctx = canvas.getContext('2d')
    ctx.globalCompositeOperation = "source-atop"
    let OCctx = OC.getContext('2d')
    OCctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.globalAlpha = 1
    ctx.drawImage(OC, 0, 0)
    return true
  }
  return true
}

function pasteFromOffColorC () {
  let OC = document.getElementById('OC')
  if (OC && OC.width > 0) {
    let canvas = document.getElementById('myCanvas')
    let ctx = canvas.getContext('2d')
    ctx.globalCompositeOperation = "color"
    document.getElementById("mode").value = "color"
    let OCctx = OC.getContext('2d')
    OCctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.globalAlpha = 1
    ctx.drawImage(OC, 0, 0)
    return true
  }
  return true
}

function coloringbook () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  const myPromise = new Promise((copyToOff) => {
    setTimeout(() => {
      copyToOff()
    }, 300);
  });
  
  copyToOff()
  myPromise
    .then(sobel)
    .then(alphaWhite)
    .then(pasteFromOffColor)
    .then(c2)
    .then(pasteFromOffColorC)
  return true
}

function c2 () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = 1.0
  ctx.fillStyle = petColor("#dddddd", 120)
  ctx.globalCompositeOperation = "destination-over"
  ctx.fillRect(0,0,canvas.width,canvas.height)
  return true
}


function landscape () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let color = document.getElementById("paintcolor").value
  let mode = ctx.globalCompositeOperation
  functions = ["smudge", "smudge", "smudge", "rays", "blobs", "hrips", "fog", "tatter", "specksRadial"]
  let args = ["", "streaks", "arcs", "stars", "horizontal", "streaks2"]
  document.getElementById("number").value = 3 + Math.random() * 10000
  document.getElementById("speck_size").value = 1 + Math.random() * 400
  document.getElementById("speck_opacity").value = 15 + Math.random() + 45
  if (Math.random() > 0.5) {
    randomPickColor()
    edgeSmear()
    rc()
  }
  let i = 0
  for (; i < 3; i++) {
    randomPickColor()
    ctx.fillStyle = randomColor()
    if (Math.random() > 0.4)
      shape()
    rc()
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 1 + Math.random() * 400
    document.getElementById("speck_opacity").value = 15 + Math.random() + 75
  }
  if (document.getElementById("grungy").checked) {
    document.getElementById("speck_opacity").value = 15 + Math.random() + 75
    ctx.fillStyle = randomColor()
    drawHouseAt(ctx, canvas.width/2, canvas.height/2+Math.random()*canvas.height/4, canvas.height/7 + Math.random()*canvas.height/5)
    if (Math.random() > 0.5)
      drawHouseAt(ctx, canvas.width/2, canvas.height/2+Math.random()*canvas.height/4, canvas.height/9 + Math.random()*canvas.height/9)
    if (Math.random() > 0.5)
      drawHouseAt(ctx, canvas.width/2-canvas.width/7, canvas.height/2+Math.random()*canvas.height/4, canvas.height/9 + Math.random()*canvas.height/9)
    if (Math.random() > 0.5)
      flipH()
    if (Math.random() > 0.5)
      rc()
  }
  let nf = 1 + Math.floor(Math.random() * 5)
  i = 0
  for (; i < nf; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 5 + Math.random() * 400
    document.getElementById("speck_opacity").value = 15 + Math.random() + 60
    window[f](a)
  }
  
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  smeardown()
  rcc()
  if (Math.random() > 0.5) {
    smeardown()
    rcc()
  }
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  smear()
  smear()
  rcc()
  contrastImage(5 + Math.random() *11)
  document.getElementById("speck_opacity").value = val
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalCompositeOperation = "color"
  document.getElementById("paintcolor").value = color
  fill()
  //restore values
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("paintcolor").value = color
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
}

function landscape2 () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let color = document.getElementById("paintcolor").value
  let mode = ctx.globalCompositeOperation
  functions = ["smudge", "smudge", "smudge", "rays", "blobs", "birds", "hrips", "fog", "specksRadial"]
  let args = ["", "streaks", "arcs", "stars", "horizontal"]
  document.getElementById("number").value = 3 + Math.random() * 10000
  document.getElementById("speck_size").value = 1 + Math.random() * 400
  document.getElementById("speck_opacity").value = 15 + Math.random() + 45
  if (Math.random() > 0.5) {
    randomPickColor()
    fill()
    rc()
  }
  let i = 0
  for (; i < 2; i++) {
    randomPickColor()
    ctx.fillStyle = randomColor()
    shape2()
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 1 + Math.random() * 400
    document.getElementById("speck_opacity").value = 15 + Math.random() + 75
  }
  rc()
  
  if (document.getElementById("grungy").checked) {
    document.getElementById("speck_opacity").value = 15 + Math.random() + 75
    ctx.fillStyle = randomColor()
    drawHouseAt(ctx, canvas.width/2 + pet(canvas.width/3), canvas.height/2+Math.random()*canvas.height/4, canvas.height/7 + Math.random()*canvas.height/5)
    if (Math.random() > 0.5)
      drawHouseAt(ctx, canvas.width/2, canvas.height/2+Math.random()*canvas.height/4, canvas.height/9 + Math.random()*canvas.height/9)
    if (Math.random() > 0.5)
      drawHouseAt(ctx, canvas.width/2-canvas.width/7, canvas.height/2+Math.random()*canvas.height/4, canvas.height/9 + Math.random()*canvas.height/9)
  }
  let nf = 2 + Math.floor(Math.random() * 5)
  i = 0
  for (; i < nf; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 5000
    document.getElementById("speck_size").value = 5 + Math.random() * 100
    document.getElementById("speck_opacity").value = 15 + Math.random() + 50
    window[f](a)
   // document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  }
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  smeardown()
  rcc()
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  smear()
  //smear()
  rc()
  contrastImage(5 + Math.random() *11)
  document.getElementById("speck_opacity").value = val
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalCompositeOperation = "color"
  document.getElementById("paintcolor").value = color
  fill()
  //restore values
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("paintcolor").value = color
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
}

function landscape3 () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let color = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  let mode = ctx.globalCompositeOperation
  functions = ["smudge", "smudge", "smudge", "rays", "blobs", "hrips", "fog", "specksRadial"]
  let args = ["", "streaks", "arcs", "arcs2", "stars", "horizontal", "horizontal2"]
  document.getElementById("number").value = 3 + Math.random() * 10000
  document.getElementById("speck_size").value = 1 + Math.random() * 400
  document.getElementById("speck_opacity").value = 100//15 + Math.random() + 75
  randomPickColor()
  fill()
  document.getElementById("speck_opacity").value = 15 + Math.random() + 75
  randomPickColor()
  fog()

  let i = 0
  for (; i < 2; i++) {
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 1 + Math.random() * 400
    document.getElementById("speck_opacity").value = 15 + Math.random() + 65
    randomPickColor()
    ctx.fillStyle = randomColor()
    if (Math.random() > 0.8)
      diagonal()
    else
      land()
  }
  if (grunge) {
    flipV()
    i = 0
    for (; i < 2; i++) {
      randomPickColor()
      ctx.fillStyle = randomColor()
      if (Math.random() > 0.8)
        diagonal()
      else
        land()
      document.getElementById("number").value = 3 + Math.random() * 10000
      document.getElementById("speck_size").value = 1 + Math.random() * 400
      document.getElementById("speck_opacity").value = 15 + Math.random() + 65
    }
  }
 // rc()
  diss()
  let nf = 2 + Math.floor(Math.random() * 5)
  i = 0
  
  for (; i < nf; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 5000
    document.getElementById("speck_size").value = 5 + Math.random() * 100
    document.getElementById("speck_opacity").value = 15 + Math.random() + 50
    window[f](a)
   // document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  }
  diss()
  //impasto()
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  document.getElementById("speck_opacity").value = 5 + Math.random() + 5
  contrastImage(5 + Math.random() *11)
  document.getElementById("speck_opacity").value = val
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalCompositeOperation = "color"
  document.getElementById("paintcolor").value = color
  fill()
  //restore values
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("paintcolor").value = color
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
}

function impasto_smudge () {
  let soft = true
  impasto(soft)
}

function impasto (soft) {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let checked = document.getElementById("grungy").checked
  document.getElementById("grungy").checked = false
  let mode = ctx.globalCompositeOperation
  /*
  ctx.shadowColor = "#ffaa00"
  ctx.shadowOffsetX = 1
  ctx.shadowOffsety = 1
  ctx.shadowBlur = 0
  */
  functions = ["dotblur", "jaggyblur", "dirblur"]
  //document.getElementById("speck_size").value = 280 + pet(30)
  document.getElementById("speck_opacity").value = 50 + pet(10)
  if (soft)
    document.getElementById("speck_opacity").value = 25 + pet(10)
  let f = randomPick(functions)
  window[f](canvas)
  document.getElementById("speck_size").value = 33 + Math.random() * 4
  f = randomPick(functions)
  window[f](canvas)
  f = randomPick(functions)
  window[f](canvas)
  
  if (!soft) {
    contrastImage(20)
    //sharpenCanvas()
   // emboseCanvas()
  }
  //restore values
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("grungy").checked = checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
}

function randomTexture () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let val = document.getElementById("speck_opacity").value
  let num = document.getElementById("number").value
  let size = document.getElementById("speck_size").value
  let color = document.getElementById("paintcolor").value
  functions = ["smudge", "smudge", "smudge", "smudge", "smudge", "blobs", "specksRadial", "strokes2", "strokes"]
  let args = ["", "streaks", "arcs", "arcs2", "stars", "horizontal"]
  let i = 0
  for (; i < 4; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 1 + Math.random() * 400
    document.getElementById("speck_opacity").value = 15 + Math.random() + 75
    window[f](a)
  }
  sobel()
  document.getElementById("speck_opacity").value = 50
  alphaWhite()
  if (Math.random() > 0.6)
    alphaBlack()
  let mode = ctx.globalCompositeOperation
  ctx.globalCompositeOperation = "source-atop"
  ctx.fillStyle = color
  ctx.fillRect(0,0,canvas.width, canvas.height)
  ctx.globalCompositeOperation = "destination-out"
  functions = functions.slice(0, -1)
  functions.push("rays")
  i = 0
  for (; i < 3; i++) {
    randomPickColor()
    let f = randomPick(functions)
    let a = ''
    if (f == "smudge")
      a = randomPick(args)
    document.getElementById("number").value = 3 + Math.random() * 10000
    document.getElementById("speck_size").value = 1 + Math.random() * 400
    document.getElementById("speck_opacity").value = 25 + Math.random() + 70
    window[f](a)
  }
  document.getElementById("speck_opacity").value = val
  document.getElementById("number").value = num
  document.getElementById("speck_size").value = size
  document.getElementById("paintcolor").value = color
  ctx.globalCompositeOperation = mode
  refreshMode()
}

function draw (canvas, ctx, temp, tempctx) {
  var img = new Image();
  img.onload = function () {
   // var canvas = document.getElementById('canvas');
   // var context = canvas.getContext('2d');
    ctx.drawImage(img, 0, 0);
  };
}

function swap () {// number to divide height by, to match width's divisor
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let W = 2 + Math.floor(document.getElementById("speck_size").value/10)
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = w
  let N = wdivs * hdivs
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100

  let temp = document.createElement('CANVAS')
  let tempctx = temp.getContext("2d")
  temp.width = canvas.width
  temp.height = canvas.height
  let MAX = N/5
  if (MAX > 20)
    MAX = 20

  let src = Math.floor(Math.random() * N)
  let sx = src %W, sy = Math.floor(src/W)
  let dest = Math.floor(Math.random() * N)
  let dx = dest % W, dy = Math.floor(dest/W)
  tempctx.imageSmoothingEnabled = false
  ctx.imageSmoothingEnabled = false
  tempctx.drawImage(canvas, 0, 0, temp.width, temp.height)
  let grunge = document.getElementById("grungy").checkd
    
  for (; i < MAX; i++) {
    src = Math.floor(Math.random() * N)
    sx = src %W, sy = Math.floor(src/W)
    dest = Math.floor(Math.random() * N)
    dx = dest % W, dy = Math.floor(dest/W)
    //console.log(sx,sy,dx,dy)
    //tempctx.imageSmoothingEnabled = false
    //ctx.imageSmoothingEnabled = false
    if (grunge)
      tempctx.translate(pt(2), pt(2))
    ctx.drawImage(temp, sx*w, sy*h, w, h, dx*w, dy*h, w, h)
    ctx.drawImage(temp, dx*w, dy*h, w, h, sx*w, sy*h, w, h)
    tempctx.drawImage(canvas, 0, 0, temp.width, temp.height)
  }
}

function testHW () {// number to divide height by, to match width's divisor
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let wdivs = 20
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let diff  = (ch - (hdivs*h))
  let i = 0, x = w
  for (; i < wdivs; i++) {
    ctx.beginPath()
    ctx.moveTo(x, 0)
    ctx.lineTo(x,ch)
    ctx.closePath()
    ctx.stroke()
    x += w
  }

  i = 0, y = h
  for (; i < hdivs; i++) {
    ctx.beginPath()
    ctx.moveTo(0, y)
    ctx.lineTo(cw,y)
    ctx.closePath()
    ctx.stroke()
    y += h
  }
  
  ctx.fillRect(4*w, 4*h, w,h)
  ctx.fillRect(1*w, 4*h, w,h)
  ctx.fillRect(4*w, 1*h, w,h)
  let temp = document.createElement('CANVAS')
  let tempctx = temp.getContext("2d")
  temp.width = w
  temp.height = h
  tempctx.drawImage(canvas, 10*w, 10*h, w, h, 0, 0, temp.width, temp.height)
  ctx.drawImage(canvas, 9*w, 9*h, w, h, 10*w, 10*h, w, h)
  ctx.drawImage(temp, 0, 0, w, h, 9*w, 9*h, w, h)

}

function showColors () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let colors = colorSample()
  let i = 0, x = 10, y = 10
  if (document.getElementById("grungy").checked) {
    ctx.clearRect(10,10,40,canvas.height)
    for (;i < colors.length; i++) {
      ctx.beginPath()
      ctx.moveTo(x, y)
      ctx.lineTo(x+40, y)
      ctx.lineTo(x+40, y+40)
      ctx.lineTo(x, y+40)
      ctx.closePath()
      ctx.fillStyle = colors[i]
      /*
      let cl = []
      cl.push(hexToR(colors[i]))
      cl.push(hexToG(colors[i]))
      cl.push(hexToB(colors[i]))
      console.log(colors[i], interesting(cl))*/
      ctx.fill()
      y += 44
    }
  }
}

function colorSample () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  saturationScale(1.1)
  let mind = 1000000
  let maxd = -1000000
  let pixels = imgData.data;
  let sample = []
  let i = 0, j = 0
  for (; i < 2000; i++) {
    let n = 4 * Math.floor(Math.random() * pixels.length/4)
    let c = []
    c.push(pixels[n])
    c.push(pixels[n+1])
    c.push(pixels[n+2])
    sample.push(c)
  }
  i = 0, j = 1
  let m = 0
  for (; i < sample.length; i++) {
    j = i + 1
    for (; j < sample.length; j++) {
      m += dist3d(sample[i], sample[j])
      maxd = (maxd < m)? m: maxd
    }
  }
  let threshold = m/sample.length/sample.length * 0.8
  //console.log(threshold)
  let bins = [], bc = 0
  i = 0
  for (;i < sample.length; i++) {
    if (sample[i]) {
      bins.push([sample[i]])
      let bc = bins.length - 1
      j = i + 1
      for (; j < sample.length; j++) {
        if (sample[j] && dist3d(sample[j], bins[bc][0]) < threshold) {
          bins[bc].push(sample[j])
          sample[j] = null
        }
      }
    }
  }
 // bins.sort(function(a, b) { return b.length - a.length;});
  bins.sort(function(a, b) { return interesting(b[0]) - interesting(a[0]);});
  let count = bins.length;
  if (count > 12)
    count = 12
  let colors = [], clrs = []
  i = 0
  for (; i < count; i++) {
    if (1/*i == 0 || bins[i].length > 9*/) {
      colors.push(averageColor(bins[i]))
      clrs.push(averageColor(bins[i], true))
    }
  }
  //resort clrs by interesting
  clrs.sort(function(a, b) { return interesting(b) - interesting(a);});
 
  let colors2 = []
  i = 0, j = 0
  for (; i < clrs.length;i++) {
    let rgb = clrs[i]
    let R = ('0'+(rgb[0]).toString(16)).slice(-2),
    G = ('0'+(rgb[1]).toString(16)).slice(-2),
    B = ('0'+(rgb[2]).toString(16)).slice(-2);

    colors2.push('#'+R+G+B)
    j = 0
    for (; j < pixels.length; j += 4) {
      if (dist3d(rgb, [pixels[j], pixels[j+1], pixels[j+2]]) < threshold) {
        pixels[j] = rgb[0]
        pixels[j+1] = rgb[1]
        pixels[j+2] = rgb[2]
      }
    }
  }
  ctx.putImageData(imgData, 0, 0);
  return colors2
}

function averageColor (b, dec) {
  let aR = 0, aG = 0, aB = 0
  let i = 0
  for (; i < b.length; i++) {
    aR += b[i][0]
    aG += b[i][1]
    aB += b[i][2]
  }
  
  aR = Math.floor(aR/b.length)
  aG = Math.floor(aG/b.length)
  aB = Math.floor(aB/b.length)
  
  let R = ('0'+(aR).toString(16)).slice(-2),
  G = ('0'+(aG).toString(16)).slice(-2),
  B = ('0'+(aB).toString(16)).slice(-2);
  if (dec)
    return [aR,aG,aB]
  else
    return '#'+R+G+B;
}

function dist3d (p1, p2) {
  // d=sqrt((r2-r1)^2+(g2-g1)^2+(b2-b1)^2)
  rmean = (p1[0] + p2[0])/2
  return Math.sqrt((2+rmean/256) * Math.pow(p1[0] - p2[0], 2) + 4 * Math.pow(p1[1] - p2[1], 2)  +  (2+(255-rmean)/256) * Math.pow(p1[2] - p2[2], 2))
}

function interesting (color) {
  let average = (color[0] + color[1] + color[2])/3
  return Math.abs(color[0] - average) + Math.abs(color[1] - average) + Math.abs(color[2] - average)
}

function posterize () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
  let grunge = document.getElementById("grungy").checked
  let t1 = 255 * 1/3
  let t2 = 255 * 2/3
  let colors = []
  colors.push(document.getElementById("paintcolor").value)
  colors.push(randomColor())
  colors.push(randomColor())
  let c = colors[0]
  
  let pixels = imgData.data;
  let i = 0
  for (; i < pixels.length; i += 4) {
    let lightness = pixels[i] * 0.2126 + pixels[i+1] * 0.7152 + pixels[i+2] * 0.0722;
    //let lightness = parseInt((pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3);
    if (lightness < t1 && lightness < t2) {
      pixels[i] =   hexToR(c)
      pixels[i+1] = hexToG(c)
      pixels[i+2] = hexToB(c)
     // if (!grunge) {
        pixels[i] /= 6
        pixels[i+1] /= 6
        pixels[i+2] /= 6
     // }
    } else
    if (lightness >= t1 && lightness < t2) {
      if (grunge)
        c = colors[1]
      pixels[i] =   hexToR(c)/1.7
      pixels[i+1] = hexToG(c)/1.7
      pixels[i+2] = hexToB(c)/1.7
      
    } else
    if (lightness >= t2) {
      if (grunge)
        c = colors[2]
      pixels[i] =   hexToR(c) * 1.1
      pixels[i+1] = hexToG(c) * 1.1
      pixels[i+2] = hexToB(c) * 1.1
    }
  }
  ctx.putImageData(imgData, 0, 0);
}

function leftCut () {
  const cut = true
  leftClip(cut)
}

function leftClip (cut) {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let H = canvas.height, W = canvas.width
  let grunge = document.getElementById("grungy").checked
  let s = LASTCLICK[0]
  if (W-s < 30 && cut) {
    alert("Cannot cut canvas width to less than 30px.")
    return
  }
  let x = 0, y = 0
  ctx.save()
  ctx.beginPath()
  ctx.moveTo(x,y)
  x = s
  ctx.lineTo(x, y)
  y += H+1
  ctx.lineTo(x, y)
  ctx.lineTo(0, y)
  ctx.closePath()
  ctx.clip()
  ctx.clearRect(0,0,W,H)
  ctx.restore()
  ctx.globalAlpha = 1
  let off = document.createElement('CANVAS')
  off.height = canvas.height
  off.width = canvas.width - x
  offctx = off.getContext("2d")
  offctx.drawImage(canvas, -x, 0)
  ctx.clearRect(0,0,W,H)
  if (cut)
    canvas.width -= x
  syncBackground(canvas)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  if (cut)
    ctx.drawImage(off, 0, 0)
  else
    ctx.drawImage(off, x, 0)
  //if (canvas.width >= LASTCLICK[0] && cut)
  //  LASTCLICK[0] = canvas.width/3
  //syncMarker()
}

function halfCurve () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let H = canvas.height, W = canvas.width
  let grunge = document.getElementById("grungy").checked
  let s = document.getElementById("speck_size").value/500
  let half = W*s
  let lx = LASTCLICK[0]
  let offset = 2 + W/(5 + Math.random() * 10)
  let x = 0, y = 0
  if (Math.random() > 0.5)
    offset *= -1
  ctx.save()
  ctx.beginPath()
  ctx.moveTo(x,y)
  x = lx
  ctx.lineTo(x,y)
  ctx.bezierCurveTo(x-offset, H/2, x+offset, H/2, x, H);
  ctx.lineTo(0,H)
  ctx.closePath()
  ctx.clip()
  ctx.clearRect(0,0,W,H)
  ctx.restore()
}

function halfRip () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let H = canvas.height, W = canvas.width
  let grunge = document.getElementById("grungy").checked
  let s = document.getElementById("speck_size").value/500
  let half = W*s
  let lx = LASTCLICK[0]
  const offset = 2 + W/100
  let x = 0, y = 0
  x = 0, y = 0
  ctx.save()
  ctx.beginPath()
  ctx.moveTo(x,y)
  x = lx//half-offset
  ctx.lineTo(x, y)
  while (y < H) {
    x += pet(9)
    y += 4 + pet(4)
    ctx.lineTo(x, y)
    if (Math.random() > 0.95)
      y += 9
  }
  ctx.lineTo(0, y)
  ctx.closePath()
  ctx.clip()
  ctx.clearRect(0,0,W,H)
  ctx.restore()
}

function ripFrame () {
  let i = 0
  for (; i < 4;i++) {
    ripSide()
    rc()
  }
}

function ripSide () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let H = canvas.height, W = canvas.width
  let grunge = document.getElementById("grungy").checked
  const offset = 5 + Math.floor(document.getElementById("speck_size").value/2)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let x = 0, y = 0
  ctx.save()
  ctx.beginPath()
  ctx.moveTo(x,y)
  x = offset
  ctx.lineTo(x, y)
  while (y < H) {
    x += pet(4)
    y += 4 + pet(4)
    ctx.lineTo(x, y)
    if (Math.random() > 0.95)
      y += 9
  }
  ctx.lineTo(0, y)
  ctx.closePath()
  ctx.clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (grunge)
    ctx.clearRect(0,0,W,H)
  else
    ctx.fill()
  ctx.restore()
}

function sampleImageData () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  // set above as in rectify
  let W = 0.5 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 0.5
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w, j = 0, linecount = 0
  let lightness = 0
  // outer loop
  for (;j < numsquares; j++) {
    let imgData = ctx.getImageData(x, y, w, h)
    let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
    let pixels = imgData.data
    let i = 0, lightness = 0
    for (; i < pixels.length; i += 4) {
      lightness += parseInt((pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3)
    }
    lightness /= (pixels.length/4) //avg = 0 to 255
    radius = lightness/255 * w/2
    offctx.beginPath()
    offctx.arc(x+w/2, y+h/2, radius, 0, Math.PI*2)
    offctx.closePath()
    offctx.fill()
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      if (!grunge && linecount % 2 == 1)
        x = -w/2
      else
        x = 0
      y += h
    }
  }
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(off, 0, 0)
}

function pointillism2 () { // five sided
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  // set above as in rectify
  let W = 2 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 2
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w/4, j = 0
  let lightness = 0, linecount = 0
  let r = 0, g = 0, b = 0
  let D = radius * 5
  let r0 = radius
  // outer loop
  let points = []
  for (;j < numsquares; j++) {
    points[j] = [x, y]
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      x = 0
      y += h
    }
  }
  points = shuffle(points)
  let inc = Math.PI/2.5
  let angle = Math.random() * 2 * Math.PI
  j = 0
  for (;j < points.length; j++) {
    x = points[j][0]
    y = points[j][1]
    let imgData = ctx.getImageData(x, y, w, h)
    let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
    let pixels = imgData.data
    let i = 0, r = 0, g = 0, b = 0
    for (; i < pixels.length; i += 4) {
      r += parseInt(pixels[i])
      g += parseInt(pixels[i+1])
      b += parseInt(pixels[i+2])
    }
    r /= pixels.length/4
    g /= pixels.length/4
    b /= pixels.length/4
    let R = ('0'+(Math.round(r)).toString(16)).slice(-2),
      G = ('0'+(Math.round(g)).toString(16)).slice(-2),
      B = ('0'+(Math.round(b)).toString(16)).slice(-2);
    offctx.fillStyle = "#"+R+G+B
    //radius = w/2
    offctx.beginPath()
    
    let k = 0
    let x1 = x+w/2+pet(D)
    let y1 = y+h/2+pet(D)
    radius = r0 + Math.random()*D
    angle = Math.random() * 2 * Math.PI
    //offctx.moveTo (x1, y1)
    for (; k < 5; k++) {
      x = x1 + radius * Math.cos(angle);
      y = y1 + radius * Math.sin(angle);
      offctx.lineTo(x, y)
      //offctx.arc(x1, y1, radius+Math.random()*D/2, angle, inc)
      angle += inc
    }
    //offctx.arc(x+w/2+pet(D), y+h/2+pet(D), radius+Math.random()*D/2, 0, Math.PI*2)
    offctx.closePath()
    offctx.fill()
  }
  if (grunge)
    ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(off, 0, 0)
}

function pointillism () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  // set above as in rectify
  let W = 2 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 2
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w/4, j = 0
  let lightness = 0, linecount = 0
  let r = 0, g = 0, b = 0
  let D = radius * 5
  // outer loop
  let points = []
  for (;j < numsquares; j++) {
    points[j] = [x, y]
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      x = 0
      y += h
    }
  }
  points = shuffle(points)
  j = 0
  for (;j < points.length; j++) {
    x = points[j][0]
    y = points[j][1]
    let imgData = ctx.getImageData(x, y, w, h)
    let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
    let pixels = imgData.data
    let i = 0, r = 0, g = 0, b = 0
    for (; i < pixels.length; i += 4) {
      r += parseInt(pixels[i])
      g += parseInt(pixels[i+1])
      b += parseInt(pixels[i+2])
    }
    r /= pixels.length/4
    g /= pixels.length/4
    b /= pixels.length/4
    let R = ('0'+(Math.round(r)).toString(16)).slice(-2),
      G = ('0'+(Math.round(g)).toString(16)).slice(-2),
      B = ('0'+(Math.round(b)).toString(16)).slice(-2);
    offctx.fillStyle = "#"+R+G+B
    //radius = w/2
    offctx.beginPath()
    offctx.arc(x+w/2+pet(D), y+h/2+pet(D), radius+Math.random()*D/2, 0, Math.PI*2)
    offctx.closePath()
    offctx.fill()
  }
  if (grunge)
    ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(off, 0, 0)
}

function sampleImageDataColor () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  // set above as in rectify
  let W = 2 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 2
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w, j = 0
  let lightness = 0, linecount = 0
  let r = 0, g = 0, b = 0
  // outer loop
  for (;j < numsquares; j++) {
    let imgData = ctx.getImageData(x, y, w, h)
    let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
    let pixels = imgData.data
    let i = 0, r = 0, g = 0, b = 0
    for (; i < pixels.length; i += 4) {
      r += parseInt(pixels[i])
      g += parseInt(pixels[i+1])
      b += parseInt(pixels[i+2])
    }
    r /= pixels.length/4
    g /= pixels.length/4
    b /= pixels.length/4
    let R = ('0'+(Math.round(r)).toString(16)).slice(-2),
      G = ('0'+(Math.round(g)).toString(16)).slice(-2),
      B = ('0'+(Math.round(b)).toString(16)).slice(-2);
    offctx.fillStyle = "#"+R+G+B
    radius = w/2
    offctx.beginPath()
    offctx.arc(x+w/2, y+h/2, radius, 0, Math.PI*2)
    offctx.closePath()
    offctx.fill()
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      if (!grunge && linecount % 2 == 1)
        x = -w/2
      else
        x = 0
      y += h
    }
  }
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(off, 0, 0)
}

function sample3colors () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  let targets = shuffle(["#FF00FF", "#00FFFF", "#FFFF00"])
  let i = 0
  let offs = []
  for (;i < targets.length; i++)
    offs.push(sampleAColor(targets[i]))
  ctx.globalAlpha = 1.0
  ctx.clearRect(0,0,canvas.width,canvas.height)
  let W = 1 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 1
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs * 2
  i = 0
  offs = shuffle(offs)
  for (;i < offs.length; i++) {
    if (i == 0)
      ctx.drawImage(offs[i], pet(w),pet(3))
    if (i == 1)
      ctx.drawImage(offs[i], pet(w),pet(w))
    if (i == 2)
      ctx.drawImage(offs[i], pet(3),pet(w))
  }
}

function sampleAColor (targetcolor) {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = targetcolor
  offctx.globalAlpha = 1.0
  let tr = hexToR(targetcolor)
  let tg = hexToG(targetcolor)
  let tb = hexToB(targetcolor)
  let targ = [tr,tg,tb]
  let maxd = []
  if (tr > 127)
    maxd.push(0)
  else
    maxd.push(255)
  if (tg > 127)
    maxd.push(0)
  else
    maxd.push(255)
  if (tb > 127)
    maxd.push(0)
  else
    maxd.push(255)
  let maxdist = dist3d(maxd, targ)
  let grunge = document.getElementById("grungy").checked
  // set above as in rectify
  let W = 2 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 2
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs * 1.3
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w, j = 0
  let lightness = 0, linecount = 0, dist = 0
  let r = 0, g = 0, b = 0
  // outer loop
  for (;j < numsquares; j++) {
    let imgData = ctx.getImageData(x, y, w, h)
    let pixels = imgData.data
    let i = 0, r = 0, g = 0, b = 0, dist = 0
    for (; i < pixels.length; i += 4) { // compare colors w/ target
      dist += dist3d(targ, [pixels[i], pixels[i+1], pixels[i+2]])
    }
    dist /= pixels.length/4
    offctx.fillStyle = targetcolor
    radius = w/2 * (1-(dist/maxdist))
    if (radius < 0)
      radius = 0.01
    if (radius > 0) {
      offctx.beginPath()
      offctx.arc(x+w/2, y+h/2, radius, 0, Math.PI*2)
      offctx.closePath()
      offctx.fill()
    }
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      if (!grunge && linecount % 2 == 1)
        x = -w/2
      else
        x = 0
      y += h
    }
  }
  return off
}


function sampleImageDataColor2 () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  off.width = canvas.width
  off.height = canvas.height
  let offctx = off.getContext("2d")
  offctx.fillStyle = document.getElementById("paintcolor").value
  let targetcolor = document.getElementById("paintcolor").value
  let tr = hexToR(targetcolor)
  let tg = hexToG(targetcolor)
  let tb = hexToB(targetcolor)
  let targ = [tr,tg,tb]
  let maxd = []
  if (tr > 127)
    maxd.push(0)
  else
    maxd.push(255)
  if (tg > 127)
    maxd.push(0)
  else
    maxd.push(255)
  if (tb > 127)
    maxd.push(0)
  else
    maxd.push(255)
  let maxdist = dist3d(maxd, targ)
  let grunge = document.getElementById("grungy").checked
  // set above as in rectify
  let W = 2 + Math.floor(document.getElementById("speck_size").value/2)
  //invert range of W [2- 102] => [102 - 2]
  W = 251 - W + 2
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = 0, y = 0
  let numsquares = (1+wdivs) * (1+hdivs)
  let radius = w, j = 0
  let lightness = 0, linecount = 0, dist = 0
  let r = 0, g = 0, b = 0
  // outer loop
  for (;j < numsquares; j++) {
    let imgData = ctx.getImageData(x, y, w, h)
    let pixels = imgData.data
    let i = 0, r = 0, g = 0, b = 0, dist = 0
    for (; i < pixels.length; i += 4) { // compare colors w/ target
      dist += dist3d(targ, [pixels[i], pixels[i+1], pixels[i+2]])
    }
    dist /= pixels.length/4
    offctx.fillStyle = targetcolor
    //console.log(Math.round(dist), (1-(dist/maxdist)))
    radius = w/2 * (1-(dist/maxdist))
    if (radius < 0)
      radius = 0.01
    if (radius > 0) {
      offctx.beginPath()
      offctx.arc(x+w/2, y+h/2, radius, 0, Math.PI*2)
      offctx.closePath()
      offctx.fill()
    }
    x += w
    if (x >= (wdivs)*w) {
      linecount++
      if (!grunge && linecount % 2 == 1)
        x = -w/2
      else
        x = 0
      y += h
    }
  }
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(off, 0, 0)
}

function filterGrays () {
  let ctx = document.getElementById("myCanvas").getContext("2d")
  let op = document.getElementById("speck_opacity").value
  //document.getElementById("speck_opacity").value = 42
  alphaBlack()
  //document.getElementById("speck_opacity").value = 63
  alphaWhite()
  document.getElementById("speck_opacity").value = op
  let mode = ctx.globalCompositeOperation
  ctx.globalCompositeOperation = "destination-over"
  if (document.getElementById("grungy").checked)
    fill()
  ctx.globalCompositeOperation = mode
  refreshMode()
}

function filterGrays2 () {
  let ctx = document.getElementById("myCanvas").getContext("2d")
  let op = document.getElementById("speck_opacity").value
  let oc = document.getElementById("paintcolor").value
 // document.getElementById("speck_opacity").value = 50
  document.getElementById("paintcolor").value = "#000000"
  colorFilterOut()
 // document.getElementById("speck_opacity").value = 50
  document.getElementById("paintcolor").value = "#7f7f7f"
  colorFilterOut()
  document.getElementById("paintcolor").value = "#ffffff"
  colorFilterOut()
  document.getElementById("speck_opacity").value = op
  let mode = ctx.globalCompositeOperation
  ctx.globalCompositeOperation = "destination-over"
  if (document.getElementById("grungy").checked)
    fill()
  ctx.globalCompositeOperation = mode
  refreshMode()
  document.getElementById("paintcolor").value = oc
}

function alphaBlack () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let threshold = 127 - document.getElementById("speck_opacity").value * 1.27
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
    let lightness = parseInt((pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3)
    if (lightness < threshold)
      pixels[i+3] = lightness/255
  }
  ctx.putImageData(imgData, 0, 0)
}

function alphaWhite () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let threshold = 127 + document.getElementById("speck_opacity").value * 1.27
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
    let lightness = parseInt((pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3)
    if (lightness > threshold)
      pixels[i+3] = 1-lightness/255
  }
  ctx.putImageData(imgData, 0, 0)
  return true
}

function filterRed () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let threshold = 127 + document.getElementById("speck_opacity").value * 1.27
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
      pixels[i] *= 0.9
  }
  ctx.putImageData(imgData, 0, 0)
}

function filterGreen () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let threshold = 127 + document.getElementById("speck_opacity").value * 1.27
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
      pixels[i+1] *= 0.9
  }
  ctx.putImageData(imgData, 0, 0)
}

function filterBlue () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let threshold = 127 + document.getElementById("speck_opacity").value * 1.27
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
      pixels[i+2] *= 0.9
  }
  ctx.putImageData(imgData, 0, 0)
}

function testImage (id) {
  let f = document.getElementById(id).value
  window[f]()
}

function invertColors() {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, canvas.width, canvas.height)
  let pixels = imgData.data
  let i = 0
  for (; i < pixels.length; i += 4) {
    var r = pixels[i]; // Red color lies between 0 and 255
    var g = pixels[i + 1]; // Green color lies between 0 and 255
    var b = pixels[i + 2]; // Blue color lies between 0 and 255
    var a = pixels[i + 3]; // Transparency lies between 0 and 255
    var invertedRed = 255 - r
    var invertedGreen = 255 - g
    var invertedBlue = 255 - b
    pixels[i] = invertedRed
    pixels[i + 1] = invertedGreen
    pixels[i + 2] = invertedBlue
  }
  ctx.putImageData(imgData, 0, 0)
}

function ellipse1(ctx, x, y, rx, ry, rot) {
  ry*=4/3;
  var p1_x=x-rx, p1_y=y,
      p2_x=x+rx, p2_y=y,
      cp1_x, cp1_y,
      cp2_x, cp2_y,
      cp3_x, cp3_y,
      cp4_x, cp4_y,
      p1n_x, p1n_y, dx, dy;
  //
  if (rot) {
      //
      p1n_x=rx*Math.cos(rot) + x;
      p1n_y=rx*Math.sin(rot) + y;
      //
      p2_x-=p1n_x-p1_x;
      p2_y-=p1n_y-p1_y;
      //
      p1_x=p1n_x;
      p1_y=p1n_y;
      //
      dx=ry*Math.sin(rot);
      dy=ry*Math.cos(rot);
      //
      cp1_x=p1_x+dx;
      cp1_y=p1_y-dy;
      cp4_x=p1_x-dx;
      cp4_y=p1_y+dy;
      //
      cp2_x=p2_x+dx;
      cp2_y=p2_y-dy;
      cp3_x=p2_x-dx;
      cp3_y=p2_y+dy;
  } else {
      cp1_x=p1_x;
      cp1_y=p1_y-ry;
      cp4_x=p1_x;
      cp4_y=p1_y+ry;
      //
      cp2_x=p2_x;
      cp2_y=p2_y-ry;
      cp3_x=p2_x;
      cp3_y=p2_y+ry;
  }
  ctx.moveTo(p1_x, p1_y);
  ctx.bezierCurveTo(cp1_x, cp1_y, cp2_x, cp2_y, p2_x, p2_y);
  ctx.bezierCurveTo(cp3_x, cp3_y, cp4_x, cp4_y, p1_x, p1_y);
}

function blockish () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let color = document.getElementById("paintcolor").value
  ctx.fillStyle = document.getElementById("paintcolor").value
  let i = 0, x = Math.random() *canvas.width, y = Math.random() *canvas.height
  let w = canvas.width/(2+Math.random()*10)
  let h = w / 2
  for (; i < 7; i++) {
    w = canvas.width/(2+Math.random()*10)
    h = w / 3
    x = Math.random() *canvas.width - w/2, y = Math.random() *canvas.height - h/2
    ctx.beginPath()
    ctx.moveTo(x+pet(120), y+pet(120))

    ctx.lineTo(x+w+pet(120), y+pet(120))
    ctx.lineTo(x+w+pet(120), y+h+pet(120))
    ctx.lineTo(x+pet(120), y+h+pet(120))

    ctx.closePath()
    ctx.fillStyle - petColor(color, 60)
    ctx.fill()
  }

}

function paperish () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let a0 = document.getElementById("speck_opacity").value
  let n0 = document.getElementById("number").value
  let color0 = document.getElementById("paintcolor").value
  let mode = ctx.globalCompositeOperation
  let size0 = document.getElementById("speck_size").value
  let shapes = ["hrips", "land", "diagonal"]
  let i = 0
  let nf = 1
  let j = 0
  ctx.save()
 // clearOff()
  for (; j < 3; j++) {
    i = 0
    ctx.globalCompositeOperation = "source-over"
    for (; i < nf; i++) {
      document.getElementById("paintcolor").value = petColor(color0, 90)
      let f = randomPick(shapes)
       //document.getElementById("number").value = 3 + Math.random() * 10000
     // document.getElementById("speck_size").value = 100 + Math.random() * 100
      document.getElementById("speck_opacity").value = 30 + Math.random() + 25
      window[f]()
      if (Math.random() > 0.5)
        flipV()
      if (Math.random() > 0.5)
        flipH()
    }
    functions = ["smudge", "smudge", "smudge"]
    let args = [ "streaks", "streaks2", "arcs", "arcs2", "stars", "horizontal"]
    ctx.globalCompositeOperation = "destination-out"
    i = 0
    nf = 1
    for (; i < nf; i++) {
      //randomPickColor()
      document.getElementById("paintcolor").value = petColor(color0, 60)
      let f = randomPick(functions)
      let a = ''
      if (f == "smudge")
        a = randomPick(args)
      document.getElementById("number").value = 10000 + Math.random() * 10000
      document.getElementById("speck_size").value = 250 + Math.random() * 200
      document.getElementById("speck_opacity").value = 50 + Math.random() + 50
      window[f](a)
    }
    /*
    ctx.globalCompositeOperation = "destination-over"
    pasteFromOff()
    ctx.globalCompositeOperation = "source-over"
    copyToOff()
    ctx.clearRect(0,0,canvas.width, canvas.height)
    */
  }/*
  ctx.globalCompositeOperation = "destination-over"
  pasteFromOff()
  ctx.globalCompositeOperation = "color"
  document.getElementById("speck_opacity").value = a0
  document.getElementById("paintcolor").value = color0*/
 // fill()
  //restore
  ctx.restore()
  document.getElementById("speck_opacity").value = a0
  ctx.globalCompositeOperation = mode
  document.getElementById("speck_size").value = size0
  document.getElementById("number").value = n0
}

function dotted (canvas, source, jaggy, dir) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height, cw = canvas.width
  let dir2 = dir + Math.PI/2
  // calculate h based on canvas dims
  let minsize = cw/200
  if (ch > cw) {
    minsize = ch/200
  }
  if (minsize < 4)
    minsize = 4
  if (dir)
    minsize *= 2
  let h = 4 + Math.floor(document.getElementById("speck_size").value/10)
  h = Math.floor(minsize/4 * h)
  let w = h
  let off = h/3
  let r = w/1.2
  let t = w*2
  let rd2 = r/3, rt2 = r*2, wd4 = w/4, wt4 = w*9
  ctx.save()
  ctx.beginPath()
  let count = canvas.height/h * canvas.width/w
  let newline = Math.floor(canvas.width/w)
  let counter = 0
  let x = w/3 + pet(11), y = h/3 + pet(11)
  let xo = 0, yo = 0, i = 0
  let inc = Math.PI*2/5, a = Math.random()*Math.PI*2
  ctx.save()
  ctx.beginPath()
  for (;i < count; i++) {
    x0 = x+w/2+pet(t)
    y0 = y+h/2+pet(t)
    ctx.moveTo(x0, y0)
    if (dir) {
      ellipse1(ctx, x0, y0, rd2, rt2, dir)
    } else
    if (jaggy) {
      ctx.arc(x0+pet(w),y0+pet(w),r,a,a+Math.PI/2)
      a += inc
    } else
       ctx.arc(x0+pet(w),y0+pet(w),r+pet(w),0,Math.PI*2)
    x += w*1.3
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = w
      y += 1.3*h
      off *= -1
      x =+ off
    }
  }
  ctx.closePath()
  ctx.clip()
  ctx.drawImage(source, pet(r*3), pet(r*3), canvas.width, canvas.height)
  ctx.restore()
  refreshMode()
}

function dottedhalo (canvas, source, jaggy, dir) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height, cw = canvas.width
  let cx = cw/2, cy = ch/2
  cx = LASTCLICK[0]
  cy = LASTCLICK[1]
  let dir2 = dir + Math.PI/2
  // calculate h based on canvas dims
  let minsize = cw/200
  if (ch > cw) {
    minsize = ch/200
  }
  if (minsize < 4)
    minsize = 4
  if (dir)
    minsize *= 2
  let h = 4 + Math.floor(document.getElementById("speck_size").value/10)
  h = Math.floor(minsize/4 * h)
  let w = h
  let off = h/3
  let r = w/1.2
  let t = w
  let rd2 = r/3, rt2 = r*2, wd4 = w/4, wt4 = w*9
  ctx.save()
  ctx.beginPath()
  let count = canvas.height/h * canvas.width/w * 2
  let newline = Math.floor(canvas.width/w) + w
  let counter = 0
  let x = w/2//w/3 + pet(11),
  let y = 0// h/3 + pet(11)
  let xo = 0, yo = 0, i = 0
  let inc = 5, a = Math.random()*Math.PI*2
  ctx.save()
  ctx.beginPath()
  let dist = 0, max_dist = distance(cx, cy, 0, 0), r0 = r
  while (y < canvas.height) {
    x0 = x + w/2+pet(t)
    y0 = y + h/2+pet(t)
    ctx.moveTo(x0,y0)
    dist = distance(x0, y0, cx, cy)/max_dist
    r = r0 * dist
    a = Math.random() * 6.28
    if (dist * Math.random() > 0.02) {

      if (dir) {
        ellipse1(ctx, x0, y0, rd2, rt2, dir)
      } else
      if (jaggy) {
        ctx.arc(x0+pet(w),y0+pet(w),r,a,a+Math.PI/2)
       // a += inc
      } else
         ctx.arc(x0+pet(w),y0+pet(w),r,0,Math.PI*2)
    }
    x += w*1.3
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = 0
      y += 1.3*h
      off *= -1
      x =+ off
    }
    i++
  }
  ctx.closePath()
  ctx.clip()
  ctx.drawImage(source, pet(r*3), pet(r*3), canvas.width, canvas.height)
  ctx.restore()
  refreshMode()
}


function qBlur () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  ctx.drawImage(canvas, 0, 0, canvas.width / 4, canvas.height / 4);
  ctx.drawImage(canvas, 0, 0, canvas.width / 4, canvas.height / 4, 0, 0, canvas.width, canvas.height);
}

function jaggyblur (canvas) {
  let jaggy = true
  dotblur(canvas, jaggy, false)
}

function dirblur (canvas) {
  let jaggy = false
  let dir = Math.random() * Math.PI * 2
  dotblur(canvas, jaggy, dir)
}

function halojaggy () {
  let jaggy = true
  haloblur(jaggy)
}

function haloblur (jaggy, dir) {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  let offctx = off.getContext("2d")
  off.height = canvas.height
  off.width = canvas.width
  let grunge = document.getElementById("grungy").checked
  offctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let i = 0
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  if (grunge)
    ctx.clearRect(0,0,canvas.width, canvas.height)
  for (; i < 3; i++) {
    offctx.clearRect(0,0,canvas.width, canvas.height)
    offctx.putImageData(imgData, pet(17), pet(17))
    dottedhalo(canvas, off, jaggy, dir)
  }
  refreshMode()
}

function dotblur (canvas, jaggy, dir) {
  if (!canvas)
    canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  let offctx = off.getContext("2d")
  off.height = canvas.height
  off.width = canvas.width
  let grunge = document.getElementById("grungy").checked
  offctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let i = 0
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  if (grunge)
    ctx.clearRect(0,0,canvas.width, canvas.height)
  for (; i < 3; i++) {
    offctx.clearRect(0,0,canvas.width, canvas.height)
    offctx.putImageData(imgData, pet(17), pet(17))
    dotted(canvas, off, jaggy, dir)
  }
  refreshMode()
}

function colorFilterOut () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let target = document.getElementById("paintcolor").value
  let threshold = +document.getElementById("speck_opacity").value
  threshold = 100 - threshold
  let grunge = document.getElementById("grungy").checked
  let mode = ctx.globalCompositeOperation
  let r = hexToR(target)
  let g = hexToG(target)
  let b = hexToB(target)
  let pixels = imgData.data
  let i = 0
  let d = imgData.data
  let dist = 0
  for( ;i < d.length; i +=4) {
    dist = 0
    dist += Math.abs(d[i] - r)
    dist += Math.abs(d[i+1] - g)
    dist += Math.abs(d[i+2] - b)
   // if (i == 0)
   //   alert(threshold+", d:"+dist)
    if (dist/3 <= threshold) {
      if (grunge) {
        d[i + 3] *= 0.8
      } else
        d[i + 3] = 0.0
    }
  }
  ctx.putImageData(imgData, 0, 0)
  refreshMode()
}

function colorFilterOff () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let off = document.createElement('CANVAS')
  let offctx = off.getContext("2d")
  off.height = canvas.height
  off.width = canvas.width
  let off2 = document.createElement('CANVAS')
  let off2ctx = off2.getContext("2d")
  off2.height = canvas.height
  off2.width = canvas.width
  offctx.globalAlpha = 0.8
  off2ctx.globalAlpha = 0.8
  // red
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let target = "#ff5555"//document.getElementById("paintcolor").value
  let threshold = document.getElementById("speck_opacity").value
  let tclose = threshold * 0.95
  let r = hexToR(target)
  let g = hexToG(target)
  let b = hexToB(target)
  let pixels = imgData.data
  let i = 0
  let d = imgData.data
  let dist = 0
  for( ;i < d.length; i +=4) {
    dist = 0
    dist += Math.abs(d[i] - r)
    dist += Math.abs(d[i+1] - g)
    dist += Math.abs(d[i+2] - b)
    let lightness = parseInt((d[i] + d[i + 1] + d[i + 2]) / 3);
    
    if (dist/3 > threshold) {
        d[i + 3] = 0.0
    }
  }
  offctx.clearRect(0,0,canvas.width, canvas.height)
  offctx.putImageData(imgData, 0, 0)
  offctx.globalCompositeOperation = "destination-out"
  dashes(off)
  offctx.globalCompositeOperation = "source-over"
  off2ctx.drawImage(off, -6,6,off2.width,off2.height)
  
  // blue
  imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  target = "#5555ff"//document.getElementById("paintcolor").value
  threshold = document.getElementById("speck_opacity").value
  tclose = threshold * 0.95
  r = hexToR(target)
  g = hexToG(target)
  b = hexToB(target)
  pixels = imgData.data
  i = 0
  d = imgData.data
  dist = 0
  for( ;i < d.length; i +=4) {
    dist = 0
    dist += Math.abs(d[i] - r)
    dist += Math.abs(d[i+1] - g)
    dist += Math.abs(d[i+2] - b)
    let lightness = parseInt((d[i] + d[i + 1] + d[i + 2]) / 3);
    
    if (dist/3 > threshold) {
        d[i + 3] = 0.0
    }
  }
  offctx.clearRect(0,0,canvas.width, canvas.height)
  offctx.putImageData(imgData, 0, 0)
  offctx.globalCompositeOperation = "destination-out"
  dashes(off)
  offctx.globalCompositeOperation = "source-over"
  off2ctx.drawImage(off, 0,6,off2.width,off2.height)
  
  // green
  imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  target = "#55ff55"//document.getElementById("paintcolor").value
  threshold = document.getElementById("speck_opacity").value
  tclose = threshold * 0.95
  r = hexToR(target)
  g = hexToG(target)
  b = hexToB(target)
  pixels = imgData.data
  i = 0
  d = imgData.data
  dist = 0
  for( ;i < d.length; i +=4) {
    dist = 0
    dist += Math.abs(d[i] - r)
    dist += Math.abs(d[i+1] - g)
    dist += Math.abs(d[i+2] - b)
    let lightness = parseInt((d[i] + d[i + 1] + d[i + 2]) / 3);
    
    if (dist/3 > threshold) {
        d[i + 3] = 0.0
    }
  }
  offctx.clearRect(0,0,canvas.width, canvas.height)
  offctx.putImageData(imgData, 0, 0)
  offctx.globalCompositeOperation = "destination-out"
  dashes(off)
  offctx.globalCompositeOperation = "source-over"
  refreshMode()
  off2ctx.drawImage(off, -6,0,off2.width,off2.height)
  
  ctx.clearRect(0,0,canvas.width, canvas.height)
  ctx.drawImage(off2, 0,0,off2.width,off2.height)
}

function colorFilter () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let target = document.getElementById("paintcolor").value
  let threshold = document.getElementById("speck_opacity").value
  let grunge = document.getElementById("grungy").checked
  let r = hexToR(target)
  let g = hexToG(target)
  let b = hexToB(target)
  let pixels = imgData.data
  let i = 0
  let d = imgData.data
  let dist = 0
  for( ;i < d.length; i +=4) {
    dist = 0
    dist += Math.abs(d[i] - r)
    dist += Math.abs(d[i+1] - g)
    dist += Math.abs(d[i+2] - b)
    let lightness = parseInt((d[i] + d[i + 1] + d[i + 2]) / 3);
    if (dist/3 > threshold) {
      if (grunge) {
        d[i + 3] *= 0.8
      } else
        d[i + 3] = 0.0
    }
  }
  ctx.putImageData(imgData, 0, 0)
}

function highContrast () {
  let canvas = document.getElementById("myCanvas")
  
  greyScale(canvas)
  contrastImage(40, canvas)
  adjustBrightness(-30, canvas)
  if (document.getElementById("grungy").checked) {
    sharpenCanvas()
  }
}

function contrastImage (contrast, canvas) {  //input range [-100..100]
  if (!canvas)
    canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let pixels = imgData.data
  let i = 0
  let d = imgData.data
  contrast = (contrast/100) + 1;  //convert to decimal & shift range: [0..2]
  let intercept = 128 * (1 - contrast)
  for( ;i < d.length; i +=4){   //r,g,b,a
    d[i] =   d[i]*contrast + intercept
    d[i+1] = d[i+1]*contrast + intercept
    d[i+2] = d[i+2]*contrast + intercept
  }
  ctx.putImageData(imgData, 0, 0)
}

function openFile () {
  let canvas = document.getElementById('myCanvas')
  let ctx = canvas.getContext('2d')
  let mode = ctx.globalCompositeOperation
  document.getElementById('uploadimage').click();
  ctx.globalCompositeOperation = mode
}


function drawFile () {
  let canvas = document.getElementById('myCanvas')
  let ctx = canvas.getContext('2d')
  let img = new Image()
  let f = document.getElementById("uploadimage").files[0]
  let url = window.URL || window.webkitURL
  let src = url.createObjectURL(f);
  img.src = src;
  let mode = ctx.globalCompositeOperation
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1
  ctx.globalCompositeOperation = "source-over"
  document.getElementById('mode')
  img.onload = function() {
    canvas.height = this.height
    canvas.width = this.width
    syncBackground(canvas)
    document.getElementById("canvaswidth").value = canvas.width
    document.getElementById("canvasheight").value = canvas.height
    ctx.drawImage(img, 0, 0);
    url.revokeObjectURL(src);
    LASTCLICK[0] = canvas.width/2
    LASTCLICK[1] = canvas.height/2
    ctx.globalCompositeOperation = mode
    ctx.globalAlpha = a
  }
  document.getElementById("uploadimage").value = ""
  ctx.globalCompositeOperation = mode
  refreshMode()
}

//let OC = null

function clearOff () {
 // OC = null
 let OC = document.getElementById('OC')
 let octx = OC.getContext('2d')
 octx.clearRect(0, 0, OC.width, OC.height)
}

function copyToOff () {
 // if (!OC)
  //  OC = document.createElement('CANVAS')
  let OC = document.getElementById('OC')
  let canvas = document.getElementById('myCanvas')
  OC.height = canvas.height
  OC.width = canvas.width
  let ctx = canvas.getContext('2d')
  let OCctx = OC.getContext('2d')
  ctx.globalAlpha = 1.0
  let mode = ctx.globalCompositeOperation
  ctx.globalCompositeOperation = "source-over"
  OCctx.globalAlpha = 1.0
  OCctx.globalCompositeOperation = "source-over"
  OCctx.drawImage(canvas, 0, 0)
  ctx.globalCompositeOperation = mode
  return true
}

function pasteFromOff () {
  let OC = document.getElementById('OC')
  if (OC && OC.width > 0) {
    let canvas = document.getElementById('myCanvas')
    let ctx = canvas.getContext('2d')
    let OCctx = OC.getContext('2d')
    OCctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.drawImage(OC, 0, 0)
  }
}

document.getElementById("uploadimage").addEventListener("change", drawFile, true)

function pushColor (c) {
  document.getElementById("paintcolor").value = c
}

function randomPickColor() {
  document.getElementById("paintcolor").value = randomColor()
}

function updateColor () {
  let uc = document.getElementById("usercolor").value
  document.getElementById("paintcolor").value = uc
}

function randn_bm (min, max, skew) {
  let u = 0, v = 0;
  while(u === 0) u = Math.random() //Converting [0,1) to (0,1)
  while(v === 0) v = Math.random()
  let num = Math.sqrt( -2.0 * Math.log( u ) ) * Math.cos( 2.0 * Math.PI * v )
  num = num / 10.0 + 0.5 // Translate to 0 -> 1
  if (num > 1 || num < 0)
   num = randn_bm(min, max, skew) // resample between 0 and 1 if out of range
  else{
    num = Math.pow(num, skew) // Skew
    num *= max - min // Stretch to fill range
    num += min // offset to min
  }
  return num
}

function randomColor() {
  let r = ('0'+(randomFromTo(10,256)).toString(16)).slice(-2),
  g = ('0'+(randomFromTo(10,256)).toString(16)).slice(-2),
  b = ('0'+(randomFromTo(10,256)).toString(16)).slice(-2);
  return '#' +r+g+b;
}

function randomFromTo(from, to) {
  return Math.floor(Math.random() * (to - from + 1) + from);
}

function randomPick (array) {
  return array[Math.floor((array.length) * Math.random())]
}

function clip () {
  return
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let H = canvas.height
  let len = W/2, maxy = H/2
  ctx.save()
  let dist = document.getElementById("distro").value
  if (dist == "strip") {
    maxy = W/20
    ctx.beginPath();
    ctx.moveTo(canvas.width/2 - maxy, 0)
    ctx.lineTo(canvas.width/2 - maxy, canvas.height)
    ctx.lineTo(canvas.width/2 + maxy, canvas.height)
    ctx.lineTo(canvas.width/2 + maxy, 0)
    ctx.closePath()
    ctx.clip()
  }
  if (dist == "circle") {
    ctx.beginPath();
    ctx.arc(len, len, len, 0, 2*Math.PI, false);
    ctx.closePath()
    ctx.clip()
  }
}

function drips () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  //ctx.save()
  //clip()
  let W = canvas.width
  let c = W/2
  let margin = W/20
  let w4 = (W-2*margin)/(2+Math.floor(Math.random() * 10))*8////document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/750
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  let scale = 7+document.getElementById("speck_size").value/5
  let parts = Math.floor(W/(scale*2-1)) *1.8
  let rule = true
  if (Math.random() > 0.5)
    rule = false
  if (!grunge) {
    let t = 0
    colors = []
    for (; t < 21; t++)
      colors.push(randomColor())
  }
  let x = scale, y = 71 + pet(41)
  let i = 0, r = scale/2
  let d = 0, drift = 0
  for (; i < parts; i++) {
    let x1 = x
    let xf = 20 + Math.random() * 100
    let yf = 0.001 + Math.random()/3 * 0.002
    r = scale/2 + pet(scale/4)
    while (y < 1400) {
      d = (x1-c)
      if (d < 1)
        d += -1
      drift = xf/(d+0.01)
      if (rule) {
        if (x1 > c)
          drift -= y * yf
        else
          drift += y * yf
      } else {
        if (x1 < c)
          drift -= y * yf
        else
          drift += y * yf
      }
      x1 += drift
      y += 2
      x1 += pet(1.25)
      if (r < 0.5)
        r = 0.5
      ctx.beginPath();
      ctx.moveTo(x1, y)
      ctx.arc(x1,y,1+r+pet(2) ,0,2*Math.PI)
      ctx.closePath()
      ctx.fillStyle = colors[i%colors.length]
      ctx.fill()
      r*= 0.998
    }
    x += scale * 1.05
    y = 41 + pet(41)
  }
  ctx.restore()
}

function spiral () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let C = W/2 + (Math.random() - 0.5) * W/4
  ctx.globalAlpha = +document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/20
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let radius = 250, r0 = W/2.3 +Math.random() * 250, angle = Math.random() * 6.28
  let n = 0, end = 2400
  let shrink = 100 + Math.random() * 300
  let grow = end -100 - Math.random() * 300
  ctx.beginPath();
  for (; n < end; n++) {
    radius = r0
    // make a complete circle every 50 iterations
    angle += (Math.PI * 2) / 250;
    var x = C + radius * Math.cos(angle);
    var y = C + radius * Math.sin(angle);
    ctx.lineTo(x, y);
    r0 += 0.02 + pet(2)
    if (n > grow)
      r0 += 0.9 + pet(1)
    if (n < shrink)
     r0 -= 0.9 + pet(1)
  }
  ctx.stroke();
}

function spiral2 () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let cx = W/2
  let cy = cx
  let C = W/2 + (Math.random() - 0.5) * W/4
  ctx.globalAlpha = +document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/20
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let radius = 250, r0 = W/4 +Math.random() * 250, angle = Math.random() * 6.28
  let n = 0, end = 3000
  let shrink = W * 0.37
  let grow = W * 0.05
  ctx.beginPath();
  let inc = false, dec = false
  for (; n < end; n++) {
    radius = r0
    // make a complete circle every 50 iterations
    angle += (Math.PI * 2) / 250;
    var x = C + radius * Math.cos(angle);
    var y = C + radius * Math.sin(angle);
    ctx.lineTo(x, y);
    r0 += 0.02 + pet(2)
    let gs = distance(x,y,cx,cy)
    if (n > 151 && gs > shrink) {
      inc = false
      dec = true
    }
    if (gs < grow) {
      inc = true
      dec = false
    }
    if (inc)
      r0 += 3 + pet(0.5)
    else
    if (dec)
      r0 -= 1 + pet(0.5)
  }
  ctx.stroke();
}

function spiral3 () { // chemotaxis like
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let H = canvas.height
  let cx = W/2
  let cy = cx
  let C = W/2 + (Math.random() - 0.5) * W/4
  ctx.globalAlpha = +document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/20
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let radius = 50//250
  let angle = Math.random() * 6.28
  let n = 0, end = 7000
  let shrink = W * 0.37
  let grow = W * 0.05
  let turnAt = W/6+ Math.random() * W/6
  let inc = false, dec = false
  let turn = false
  let A = 0.001 + Math.random()/120
  var x = cx + radius * Math.cos(angle);
  var y = cy + radius * Math.sin(angle);
  ctx.beginPath();
  ctx.moveTo(x, y);
  for (; n < end; n++) {
    x = x + Math.sin(angle) * 1
    y = y + Math.cos(angle) * 1
    ctx.lineTo(x, y);
    let gs = distance(x,y,cx,cy)
    if (gs > turnAt) {
      turn = true
    } else
    if (gs < turnAt) {
      turn = false
    }
    if (turn)
      angle += A +pet(1)/10
    else
      angle += pet(5)/100
  }
  ctx.stroke();
}

function spiral4 () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let cx = W/2
  let cy = cx
  let C = W/2 + (Math.random() - 0.5) * W/4
  ctx.globalAlpha = +document.getElementById("speck_opacity").value/100
  //let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/20
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let radius = W/4 + Math.random() * W/10
  let angle = Math.random() * 6.28
  let n = 0, end = 17000
  let turnAt = W/6+ Math.random() * W/6
  let inc = false, dec = false
  let turn = false
  let A = 0.001 + Math.random()/140
  var x = cx + radius * Math.cos(angle);
  var y = cy + radius * Math.sin(angle);
  let pf = 19
  if (grunge)
    pf = 7
  let dis = distance(x,y,C,C)
  ctx.beginPath();
  ctx.moveTo(x, y);
  for (; n < end; n++) {
    x = x + Math.sin(angle) * 1
    y = y + Math.cos(angle) * 1
    ctx.lineTo(x, y);
    let gs = distance(x,y,cx,cy) - dis
    if (gs > 0) {
      turn = true
      angle += gs/W * 0.02 + pet(1)/pf
    } else
    if (gs <= 0) {
      turn = false
      angle -= gs/W *0.02 + pet(1)/pf
    }
  }
  ctx.stroke();
}

function script () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let cx = 0
  let cy = LASTCLICK[1]//W/2 + pet(W/3)
  let C = W/2 + (Math.random() - 0.5) * W/4
  ctx.globalAlpha = +document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/20
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let radius = W/10 + Math.random() * W/10
  let angle = Math.random() * 6.28
  if (Math.random() > 0.5)
    angle *= -1
  let n = 0, end = 20000//17000
  var x = 10//cx + radius * Math.cos(angle);
  var y = cy //+ radius * Math.sin(angle);
  let pf = 40
  let amult = 0.01 + Math.random()/10
  let ydrift = 0.01 + Math.random()/10
  if (Math.random() > 0.5)
    ydrift *= -1
  if (grunge)
    pf = 20
  ctx.beginPath();
  ctx.moveTo(x, y);
  let avg = 0
  let gs = 1000 * Math.random()
  for (; n < end; n++) {
    x = x + Math.sin(angle) + 0.25 + pet(0.2)
    y = y + Math.cos(angle) + ydrift
    ctx.lineTo(x, y);
    if (gs > 500) {
      angle += gs/W * amult + pet(6)/pf
    } else {
      angle -= gs/W * amult + pet(6)/pf
    }
    if (Math.random() > 0.995) {
      amult = 0.01 + Math.random()/10
      ydrift *= -1
    }
    if (x > W)
      break;
  }
  ctx.stroke();
}

function drops () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
 // ctx.save()
  clip()
  let W = canvas.width
  let c = W/2
  let margin = W/20
  let w4 = (W-2*margin)/(2+Math.floor(Math.random() * 10))*8//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  let scale = 7+document.getElementById("speck_size").value/5
  let parts = Math.floor(W/(scale*2-1)) *1.8
  let rule = true
  if (Math.random() > 0.5)
    rule = false
  if (!grunge) {
    let t = 0
    colors = []
    for (; t < 21; t++)
      colors.push(randomColor())
  }
  let x = scale, y = 71 + pet(1)
  let i = 0, r = scale/2
  let d = 0, drift = 0
  for (; i < parts; i++) {
    let x1 = x
    let xf = 20 + Math.random() * 100
    let yf = 0.001 + Math.random()/3 * 0.002
    r = scale/2 + pet(scale/4)
    while (y < 72) {
      d = (x1-c)
      if (d < 1)
        d += -1
      drift = xf/(d+0.01)
      if (rule) {
        if (x1 > c)
          drift -= y * yf
        else
          drift += y * yf
      } else {
        if (x1 < c)
          drift -= y * yf
        else
          drift += y * yf
      }
      x1 += drift
      y += 2
      x1 += pet(1.25)
      if (r < 0.5)
        r = 0.5
      ctx.beginPath();
      ctx.moveTo(x1, y)
      ctx.arc(x1,y,1+r+pet(2) ,0,2*Math.PI)
      ctx.closePath()
      ctx.fillStyle = colors[i%colors.length]
      ctx.fill()
      r*= 0.998
    }
    x += scale * 1.05
    y = 41 + pet(41)
  }
  ctx.restore()
}

function chair () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let H = canvas.height
  let margin = W/5
  margin = 100 + (W-2*margin)/(2+Math.floor(Math.random() * 10))//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 2+document.getElementById("speck_size").value/10
  ctx.lineCap = "round"
  let points = []
  points[0] = [margin, W/2+margin/2]
  points[1] = [margin*2, W/2-margin+margin/2]
  points[2] = [W-margin, W/2-margin+margin/2]
  points[3] = [W-margin*2, W/2+margin/2]
  points[4] = [margin, margin*2+margin/2]
  points[5] = [margin, margin+margin/2]
  points[6] = [margin*2, 0+margin/2]
  
  points[7] = [margin, W-margin+margin/2]
  points[8] = [margin*2, W-margin*2+margin/2]
  points[9] = [W-margin, W-margin*2+margin/2]
  points[10] = [W-margin*2, W-margin+margin/2]
  
  points[11] = [W-margin, margin/2]
  
  let g = 11
  if (grunge)
    g *= 2
  let i = 0
  for (; i < points.length; i++) {
    points[i][0] += pet(g)
    points[i][1] += pet(g)
  }
  
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  
  let flip = Math.random() > 0.5
  if (flip) {
    ctx.beginPath();
    ctx.moveTo(points[2][0], points[2][1])
    ctx.lineTo(points[11][0], points[11][1])
    if (grunge)
      ctx.lineWidth += pet(2)
    ctx.stroke()
    
    ctx.beginPath();
    ctx.moveTo(points[6][0], points[6][1])
    ctx.lineTo(points[11][0], points[11][1])
    if (grunge)
      ctx.lineWidth += pet(2)
    ctx.stroke()
  } else {
    ctx.beginPath();
    ctx.moveTo(points[0][0], points[0][1])
    ctx.lineTo(points[5][0], points[5][1])
    if (grunge)
      ctx.lineWidth += pet(2)
    ctx.stroke()
    
    ctx.beginPath();
    ctx.moveTo(points[5][0], points[5][1])
    ctx.lineTo(points[6][0], points[6][1])
    if (grunge)
      ctx.lineWidth += pet(2)
    ctx.stroke()
  }
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[7][0], points[7][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[8][0], points[8][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[2][0], points[2][1])
  ctx.lineTo(points[9][0], points[9][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[3][0], points[3][1])
  ctx.lineTo(points[10][0], points[10][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[1][0], points[1][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[2][0], points[2][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[6][0], points[6][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[2][0], points[2][1])
  ctx.lineTo(points[3][0], points[3][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[3][0], points[3][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.restore()
}

function point (x, y) {
  this.x = x
  this.y = y
}

function drawLine (ctx, pt1, pt2) {
  ctx.beginPath()
  ctx.moveTo(pt1.x, pt1.y)
  ctx.lineTo(pt2.x, pt2.y)
  ctx.stroke()
}

function person () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  ctx.lineWidth = 0.5+document.getElementById("speck_size").value/10
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let W = canvas.width
  let margin = W/8
  margin = 50 + (W-2*margin)/(2+Math.floor(Math.random() * 10))//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 0.5+document.getElementById("speck_size").value/10
  let r = 47 + Math.random() * 11

  let points = []
  points[0] = new point(W/2 + margin/2, W/2+margin/2)
  points[1] = new point(W/2 - margin/2, W/2+margin/2)
  //armpits
  points[2] = new point(W/2 + margin/2.2, margin*1.5)
  points[3] = new point(W/2 - margin/2.2, margin*1.5)
  points[5] = new point(W/2, margin*1.5) // shoulders

  points[6] = new point(W/2, margin*0.7) // head
  //hands
  points[7] = new point(margin*1.7, W/2-margin/3)
  points[8] = new point(W - margin*1.7, W/2-margin/3)
  //elbows
  points[13] = new point(margin*1.8, W/2+margin/3)
  points[14] = new point(W - margin*1.8, W/2+margin/3)
  //legs
  points[9] = new point(W/2 + margin/3, W/2+margin/2)
  points[10] = new point(W/2 - margin/3, W/2+margin/2)
  // feet
  points[11] = new point(W/2 + margin/3, W - margin/2)
  points[12] = new point(W/2 - margin/3, W - margin/2)
  // knees
  points[15] = new point(W/2 + margin/3, W-margin*1.5)
  points[16] = new point(W/2 - margin/3, W-margin*1.5)

  // 2,3,5 get petted together
  let py = pet(24)
  let px = pet(24)
  points[2].x += px
  points[2].y += py
  points[3].x += px
  points[3].y += py
  points[5].x += px
  points[5].y += py
  
  points[0].x += pet(24)
  points[0].y += pet(24)
  points[1].x += pet(24)
  points[1].y += pet(24)
  points[6].x += pet(24)
  points[6].y += pet(24)
  points[7].x += pet(24)
  points[7].y += pet(24)
  points[8].x += pet(24)
  points[8].y += pet(24)
  points[9].x += pet(24)
  points[9].y += pet(24)
  points[10].x += pet(24)
  points[10].y += pet(24)
  points[11].x += pet(24)
  points[11].y += pet(24)
  points[12].x += pet(24)
  points[12].y += pet(24)
  points[13].x += pet(24)
  points[13].y += pet(24)
  points[14].x += pet(24)
  points[14].y += pet(24)
  points[15].x += pet(24)
  points[15].y += pet(24)
  points[16].x += pet(24)
  points[16].y += pet(24)

  drawLine(ctx, points[0], points[1])
  drawLine(ctx, points[1], points[3])
  drawLine(ctx, points[0], points[2])
  drawLine(ctx, points[2], points[8])
  drawLine(ctx, points[3], points[7])

  drawLine(ctx, points[14], points[8])
  drawLine(ctx, points[13], points[7])

  drawLine(ctx, points[9], points[15])
  drawLine(ctx, points[10], points[16])
  drawLine(ctx, points[15], points[11])
  drawLine(ctx, points[16], points[12])

  ctx.beginPath()
  ctx.arc(points[5].x, points[5].y, margin/2.2, Math.PI, 2*Math.PI)
  ctx.stroke()
  ctx.beginPath()
  ctx.ellipse(points[6].x, points[6].y,  margin/4, margin/3, pet(100)/100,  0, 2*Math.PI) //head
  ctx.stroke()
}

function lamp () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  ctx.lineWidth = 0.5+document.getElementById("speck_size").value/10
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let W = canvas.width
  let margin = W/8
  margin = 50 + (W-2*margin)/(2+Math.floor(Math.random() * 10))//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 0.5+document.getElementById("speck_size").value/10
  let r = 47 + Math.random() * 11

  let points = []
  points[0] = [W/2, margin]
  points[1] = [W/2, W/2]
  points[2] = [W/2, W-margin]

  points[3] = [W/2 - margin, W/2]
  points[4] = [W/2 - margin/3, margin]

  points[5] = [W/2 + margin, W/2]
  points[6] = [W/2 + margin/3, margin]

  points[7] = [W/2, W - margin]
  points[8] = [W/2, W/2-margin/2+25]

  points[9] = [W/2-20, W - 2*margin]
  points[10] = [W/2-20, W/2-margin/2+6]

  points[11] = [W/2, W/2-margin/2] //bulb

  let g = 11
  if (grunge)
    g *= 2
  let i = 0
  for (; i < points.length; i++) {
    points[i][0] += pet(g)
    points[i][1] += pet(g)
  }

  ctx.beginPath()
  ctx.moveTo(points[3][0], points[3][1])
  ctx.lineTo(points[4][0], points[4][1])
  ctx.stroke()

  ctx.beginPath()
  ctx.moveTo(points[5][0], points[5][1])
  ctx.lineTo(points[6][0], points[6][1])
  ctx.stroke()

  ctx.beginPath()
  ctx.moveTo(points[7][0], points[7][1])
  ctx.lineTo(points[8][0], points[8][1])
  ctx.stroke()

  ctx.beginPath()
  ctx.moveTo(points[9][0], points[9][1])
  ctx.lineTo(points[10][0], points[10][1]+25)
  ctx.stroke()

  ctx.beginPath()
  ctx.arc(points[9][0], points[9][1], 6+pet(3), 0, 2*Math.PI)
  ctx.stroke()

  ctx.beginPath()
  ctx.arc(points[11][0], points[11][1]-28, 54+pet(8), 0, 2*Math.PI)
  ctx.stroke()

  let radiusX = margin/3+pet(20), radiusY = margin/6+pet(10)
  ctx.beginPath()
  ctx.ellipse(points[0][0], points[0][1], radiusX, radiusY, pet(10)/100, 0, 2* Math.PI )
  ctx.stroke()

  radiusX = margin+pet(10), radiusY = margin/3+pet(20)
  ctx.beginPath()
  ctx.ellipse(points[1][0], points[1][1], radiusX, radiusY, pet(30)/100, 0, 2* Math.PI )
  ctx.stroke()

  radiusX = margin/3+pet(10), radiusY = margin/6+pet(10)
  ctx.beginPath()
  ctx.ellipse(points[2][0], points[2][1], radiusX, radiusY, pet(10)/100, 0, 2* Math.PI )
  ctx.stroke()

  ctx.beginPath()
  ctx.ellipse(points[2][0], points[2][1]+20+pet(10), radiusX, radiusY, 0, 0, 2* Math.PI )
  ctx.stroke()
}

function birdhouse () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/5
  margin = 100 + (W-2*margin)/(2+Math.floor(Math.random() * 10))//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  ctx.lineWidth = 0.5+document.getElementById("speck_size").value/10
  let r = 47 + Math.random() * 11

  let points = []
  points[0] = [margin, W/2+margin/2]
  points[1] = [margin*2, W/2-margin+margin/2]
  points[2] = [W-margin, W/2-margin+margin/2]
  points[3] = [W-margin*2, W/2+margin/2]
  
  points[4] = [(W/2), margin/2] //peak
  
  points[5] = [margin, margin+margin/2]
  points[6] = [margin*2, 0+margin/2]
  
  points[7] = [margin, W-margin+margin/2]
  points[8] = [margin*2, W-margin*2+margin/2]
  points[9] = [W-margin, W-margin*2+margin/2]
  points[10] = [W-margin*2, W-margin+margin/2]
  
  points[11] = [(W-margin*2+margin)/2 , (W-margin+margin/2+W/2+margin/2)/2]
  
  let g = 11
  if (grunge)
    g *= 2
  let i = 0
  for (; i < points.length; i++) {
    points[i][0] += pet(g)
    points[i][1] += pet(g)
  }
  
  ctx.lineCap = "round"
  ctx.strokeStyle = document.getElementById("paintcolor").value
  
  let flip = Math.random() > 0.5
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[4][0], points[4][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[4][0], points[4][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[2][0], points[2][1])
  ctx.lineTo(points[4][0], points[4][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[3][0], points[3][1])
  ctx.lineTo(points[4][0], points[4][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[7][0], points[7][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[8][0], points[8][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[2][0], points[2][1])
  ctx.lineTo(points[9][0], points[9][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[3][0], points[3][1])
  ctx.lineTo(points[10][0], points[10][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[1][0], points[1][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[1][0], points[1][1])
  ctx.lineTo(points[2][0], points[2][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[2][0], points[2][1])
  ctx.lineTo(points[3][0], points[3][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
   ctx.beginPath();
  ctx.moveTo(points[0][0], points[0][1])
  ctx.lineTo(points[3][0], points[3][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[9][0], points[9][1])
  ctx.lineTo(points[10][0], points[10][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()

  ctx.beginPath();
  ctx.moveTo(points[8][0], points[8][1])
  ctx.lineTo(points[9][0], points[9][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[7][0], points[7][1])
  ctx.lineTo(points[8][0], points[8][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.moveTo(points[7][0], points[7][1])
  ctx.lineTo(points[10][0], points[10][1])
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  
  ctx.beginPath();
  ctx.arc(points[11][0], points[11][1], r, 0, Math.PI * 2)
  if (grunge)
    ctx.lineWidth += pet(2)
  ctx.stroke()
  ctx.restore()
}

function necker () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/20
  let w4 = (W-2*margin)/(2+Math.floor(Math.random() * 10))//document.getElementById("rows").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  if (Math.random() > 0.5) {
    //bottom
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
    
    //left side
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(w4+margin, margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.lineTo(margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[4]
    ctx.fill()
    
      //upper right
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)  // top Horizontal
    ctx.beginPath();
    ctx.moveTo(w4+margin, 0+margin)
    ctx.lineTo(W-margin, 0+margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
    
    // lower left
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(W-w4-margin, w4+margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.lineTo(margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    //top
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(w4+margin, margin)
    ctx.lineTo(W-margin, margin)
    ctx.lineTo(W-w4-margin, w4+margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    //right side
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(W-w4-margin, w4+margin)
    ctx.lineTo(W-margin, margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.closePath(+margin)
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
  } else {
      //top
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(w4+margin, margin)
    ctx.lineTo(W-margin, margin)
    ctx.lineTo(W-w4-margin, w4+margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    //right side
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(W-w4-margin, w4+margin)
    ctx.lineTo(W-margin, margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.closePath(+margin)
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
    
     // lower left square
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(W-w4-margin, w4+margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.lineTo(margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    //bottom
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(W-w4-margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
    
    //upper right square
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)  // top Horizontal
    ctx.beginPath();
    ctx.moveTo(w4+margin, 0+margin)
    ctx.lineTo(W-margin, 0+margin)
    ctx.lineTo(W-margin, W-w4-margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
   
    //left side
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, w4+margin)
    ctx.lineTo(w4+margin, margin)
    ctx.lineTo(w4+margin, W-w4-margin)
    ctx.lineTo(margin, W-margin)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[4]
    ctx.fill()
  }
  ctx.restore()
}

function elle () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  //ctx.save()
  clip()
  let margin = canvas.width/50 * (2+Math.floor(Math.random() * 10))//
  let W = canvas.width
  let w4 = (canvas.width -(2*margin))/4
  let w2 = (canvas.width -(2*margin))/2

  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['#ff0000', '#00ff00', '#FFFF00', '#FFA500', '#800080', "#0000ff"])
  let grunge = false//document.getElementById("grungy").checked
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)

  ctx.beginPath();
  ctx.moveTo(0+margin, W-w4-margin) // square in lower left
  ctx.lineTo(w4+margin, W-w4-margin)
  ctx.lineTo(w4+margin, W-margin)
  ctx.lineTo(0+margin, W-margin)
 // ctx.lineTo(w4, W-w4)
  ctx.closePath()
  //if (grunge)
    ctx.fillStyle = colors[0]//randomGradient(canvas, colors[0])
  ctx.fill()
  
  ctx.beginPath();
  ctx.moveTo(0+margin, w2+margin)
  ctx.lineTo(w2+margin, w2+margin)
  ctx.lineTo(w2+margin, W-margin)
  ctx.lineTo(w4+margin, W-margin)
  ctx.lineTo(w4+margin, W-w4-margin)
  ctx.lineTo(0+margin, W-w4-margin)
  ctx.closePath()
  //if (grunge)
    ctx.fillStyle = colors[1]//randomGradient(canvas, colors[0])
  ctx.fill()

  ctx.beginPath();
  ctx.moveTo(0+margin, w4+margin)
  ctx.lineTo(w2+w4+margin, w2-w4+margin)
  ctx.lineTo(w2+w4+margin, W-margin)
  ctx.lineTo(w2+margin, W-margin)
  ctx.lineTo(w2+margin, W-w2-margin)
  ctx.lineTo(0+margin, W-w2-margin)
  ctx.closePath()
  //if (grunge)
    ctx.fillStyle = colors[2]//randomGradient(canvas, colors[0])
  ctx.fill()
  
  ctx.beginPath();
  ctx.moveTo(0+margin, 0+margin)
  ctx.lineTo(W-margin, 0+margin)
  ctx.lineTo(W-margin, W-margin)
  ctx.lineTo(W-w4-margin, W-margin)
  ctx.lineTo(W-w4-margin, w4+margin)
  ctx.lineTo(0+margin, w4+margin)
  ctx.closePath()
  //if (grunge)
    ctx.fillStyle = colors[3]//randomGradient(canvas, colors[0])
  ctx.fill()
}

function flower () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/20
  let w4 = (W-2*margin)/(4 + (document.getElementById("rows").value/2))
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['#ff0000', '#00ff00', '#FFFF00', '#FFA500', '#800080', "#0000ff"])
  let grunge = document.getElementById("grungy").checked
  w4 *= 0.5
  let xf = w4 //* 1.0
  let r = W
  let inc = W/2
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  let i = 0, x = 0, y = 0

  if (Math.random() > 0.5) {
    x = 0, y = 0
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[0])
    ctx.fill()
    x = W, y = 0
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[1])
    ctx.fill()
    x = 0, y = W
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[2])
    ctx.fill()
    x = W, y = W
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[3])
    ctx.fill()
  } else {
    x = 0, y = W
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[2])
    ctx.fill()
    x = W, y = W
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[3])
    ctx.fill()
    
    x = 0, y = 0
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[0])
    ctx.fill()
    x = W, y = 0
    
    ctx.beginPath();
    ctx.moveTo(x, y) // \
    ctx.arc(x,y,r,0,2*Math.PI)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = randomGradient(canvas, colors[1])
    ctx.fill()
  }
}

function folded () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/20
  let w4 = (W-2*margin)/(2+Math.floor(Math.random() * 10))//
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  w4 *= 0.5
  let xf = w4 //* 1.0

  let p1 = [margin, margin] //top left
  let p2 = [w4+margin, margin]  // top
  let p3 = [margin, W-margin]
  let p4 = [w4+ margin, W-margin]
  
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(p1[0], p1[1]) // \
  ctx.lineTo(p2[0], p2[1])
  ctx.lineTo(p4[0], p4[1])
  ctx.lineTo(p3[0], p3[1])
  ctx.closePath()
  if (grunge)
    ctx.fillStyle = colors[4]
  ctx.fill()
  
  let maxloop = 7 + +(2+Math.floor(Math.random() * 10))//
  let i = 0
  for (;i < maxloop; i++) {
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p4[0], p4[1]) // /
    ctx.lineTo(p3[0], p3[1])
    ctx.lineTo(p1[0] + xf, p1[1])
    ctx.lineTo(p2[0] + xf, p2[1])
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[i%6]
    ctx.fill()
    
    p1[0] += xf
    p2[0] += xf
    p3[0] += xf
    p4[0] += xf
    
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1])
    ctx.lineTo(p2[0], p2[1])
    ctx.lineTo(p4[0], p4[1])
    ctx.lineTo(p3[0], p3[1])
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[(i+1)%6]
    ctx.fill()
  }
}

function pyramid () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/20
  let w4 = (W-2*margin)/(4 + (2+Math.floor(Math.random() * 10)))
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green"])
  let grunge = document.getElementById("grungy").checked
  w8 = w4*3

  let p1 = [margin, W/2 + W/4] //left
  let p2 = [W/2, margin]  // top
  let p3 = [W-margin, W/2 + W/4]
  let p4 = [W/2 + W/8-margin, W-margin]
  let p5 = [W/2-W/8+margin, W-W/4-W/8-margin]
  
  if (Math.random() > 0.5) {
   // left
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p2[0], p2[1]) // up
    ctx.lineTo(p4[0], p4[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
    // right
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p2[0], p2[1])
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p4[0], p4[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p2[0], p2[1]) // bottom left
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p5[0], p5[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    // top
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p2[0], p2[1]) //peak
    ctx.lineTo(p5[0], p5[1]) // up
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
   
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p4[0], p4[1]) // up
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p5[0], p5[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
    
 } else {
   
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p4[0], p4[1]) // up
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p5[0], p5[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
    
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p2[0], p2[1]) // bottom left
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p5[0], p5[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    // top
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p2[0], p2[1]) //peak
    ctx.lineTo(p5[0], p5[1]) // up
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
   
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p1[0], p1[1]) // bottom left
    ctx.lineTo(p2[0], p2[1]) // up
    ctx.lineTo(p4[0], p4[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
    // right
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(p2[0], p2[1])
    ctx.lineTo(p3[0], p3[1]) // up
    ctx.lineTo(p4[0], p4[1]) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
  }
}

function house () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  clip()
  let W = canvas.width
  let margin = W/20
  let w4 = (W-2*margin)/(4 +(2+Math.floor(Math.random() * 10)))
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'purple', "green", "gray"])
  let grunge = document.getElementById("grungy").checked
  w8 = w4*3

  let xf = W-w8
  let yf = W -(2*margin) - w8 - w8/2
  
  if (Math.random() > 0.6) {
    // upper right face
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(xf-margin,     W-margin-yf) // bottom left
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2-yf) //peak
    ctx.lineTo(xf+w8-margin,  W-w8-margin- yf)
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
    
    // floor
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin+w8, W-margin)
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.lineTo(xf-margin,     W-margin-yf) // bottom left
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    // left wall
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.lineTo(xf-margin,     W-margin - yf) // bottom left
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
    
   // left roof
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2 -yf) //peak
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[4]
    ctx.fill()

    // right roof
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(xf+w8-margin,  W-w8-margin-yf)
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2 -yf) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
    
    // right wall
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(margin+w8, W-margin) // bottom right
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.lineTo(xf+w8-margin,  W-w8-margin-yf)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    // lower left face
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(margin+w8, W-margin) // bottom right
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
  } else {
    // right roof
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(xf+w8-margin,  W-w8-margin-yf)
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2 -yf) //peak
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[5]
    ctx.fill()
    
    // right wall
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(margin+w8, W-margin) // bottom right
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.lineTo(xf+w8-margin,  W-w8-margin-yf)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[2]
    ctx.fill()
    
    // lower left face
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(w8+margin, W-w8-margin) // roof right
    ctx.lineTo(margin+w8, W-margin) // bottom right
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    // upper right face
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(xf-margin,     W-margin-yf) // bottom left
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2-yf) //peak
    ctx.lineTo(xf+w8-margin,  W-w8-margin- yf)
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[0]
    ctx.fill()
    
    // floor
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin+w8, W-margin)
    ctx.lineTo(xf-margin+w8,  W-margin-yf)
    ctx.lineTo(xf-margin,     W-margin-yf) // bottom left
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[1]
    ctx.fill()
    
    // left wall
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-margin) // bottom left
    ctx.lineTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.lineTo(xf-margin,     W-margin - yf) // bottom left
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[3]
    ctx.fill()
    
   // left roof
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath();
    ctx.moveTo(margin, W-w8-margin) // uroof left
    ctx.lineTo(margin+w8/2, W-margin-w8 - w8/2) //peak
    ctx.lineTo(xf-margin+w8/2,W-margin-w8 - w8/2 -yf) //peak
    ctx.lineTo(xf-margin,     W-w8-margin-yf) // up
    ctx.closePath()
    if (grunge)
      ctx.fillStyle = colors[4]
    ctx.fill()
  }
  ctx.restore()
}

function origamir () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  origami()
  ctx.restore()
}

function grunge33 () {
  let grunge = document.getElementById("grungy").checked
  return (!grunge || (grunge && Math.random() < 0.33))

}

function origami () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let len = W/2, maxy = W/2
  
  // four triangles
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, len)
  ctx.lineTo(W, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, len)
  ctx.lineTo(0, 0)
  ctx.lineTo(W, 0)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, len)
  ctx.lineTo(0, 0)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, len)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()

  // 4 rects
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)  // top Horizontal
  ctx.beginPath();
  ctx.moveTo(0, 0)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, len)
  ctx.lineTo(0, len)
  ctx.closePath()
  ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, len)
  ctx.lineTo(W, len)
  ctx.lineTo(W, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, 0)
  ctx.lineTo(len, 0)
  ctx.lineTo(len, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
  
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, 0)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, W)
  ctx.lineTo(len, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()

  // diamond
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, 0)
  ctx.lineTo(W, len)
  ctx.lineTo(len, W)
  ctx.lineTo(0, len)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
}


function origami4by4 () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let len = W/2, maxy = W/2
  let quat = len/2
  
  // 4 rects
  // top Horizontal
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, 0)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, quat)
  ctx.lineTo(0, quat)
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, 0)
  ctx.lineTo(quat, 0)
  ctx.lineTo(quat, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, quat)
  ctx.lineTo(W, quat)
  ctx.lineTo(W, len)
  ctx.lineTo(0, len)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(quat, 0)
  ctx.lineTo(len, 0)
  ctx.lineTo(len, W)
  ctx.lineTo(quat, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, len)
  ctx.lineTo(W, len)
  ctx.lineTo(W, len + quat)
  ctx.lineTo(0, len + quat)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len, 0)
  ctx.lineTo(len+quat, 0)
  ctx.lineTo(len+quat, W)
  ctx.lineTo(len, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(0, len + quat)
  ctx.lineTo(W, len + quat)
  ctx.lineTo(W, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
    
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.beginPath();
  ctx.moveTo(len+quat, 0)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, W)
  ctx.lineTo(len+quat, W)
  ctx.closePath()
  if (grunge33())
    ctx.fill()
}

function strokes () {
  let increase = Math.PI * 2 / 40;
  let x = 0, y = 0, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.save()
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let maxalpha = ctx.globalAlpha
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  let stroke_width = document.getElementById("speck_size").value/20
  let stroke_ct = +document.getElementById("number").value/600
  for (let t = 0; t < stroke_ct; t++) {
    let paths = [];
    let radius = Math.floor(Math.random() * 180) + 20;
    x = 0;
    y = 0;
    let x0 = x;
    let y0 = y;
    angle = Math.floor(Math.random() * 6.42);
    let centx = Math.random()*ctx.canvas.width;
    let centy = Math.random()*ctx.canvas.height;
    let edges = (3 * (Math.floor(Math.random()*6))+6);
    let maxradius = Math.random() * 200 + canvas.width/3;
    increase = Math.PI * 2/edges*0.98;
    points = [];
    bez = [];
    let xmut = -1;
    let ymut = -1;
    if (Math.random() < 0.5)
      xmut *= -1;
    if (Math.random() < 0.5)
      ymut *= -1;
    for (let i = 0; i < edges; i++) {
      radius = (Math.random() * maxradius) + maxradius * 0.8;
      x = radius * Math.cos(angle)+centx;
      y = radius * Math.sin(angle)+centy;
      points.push([x, y]);
      angle += increase;
    }
    paths.push(points);
    let pop = 60
    if (document.getElementById("grungy").checked)
      pop *= 2
    let offset = 20 + stroke_width * 26;
    let numpaths = 20 + Math.random()*30;
    for (let s = 0; s < numpaths; s++) {
      let path = [];
      for (let c = 0; c < points.length; c++) {
        path.push([points[c][0] + xmut*(offset + (pop * (Math.random()-0.5))), points[c][1] + ymut*(offset + (pop * (Math.random()-0.5)))]);
      }
      offset += (Math.random()-0.5) * stroke_width;
      paths.push(path);
    }
    radius = (canvas.width > canvas.height)? canvas.width/2: canvas.height/2;
    angle = Math.random()*6.27;
    let x1 = radius * Math.cos(angle)+centx;
    let y1 = radius * Math.sin(angle)+centy;
    let x2 = radius * Math.cos(angle+3.14)+centx;
    let y2 = radius * Math.sin(angle+3.14)+centy;
    for (let f = 1; f < paths.length; f++) {
      let pts = paths[f];
      ctx.beginPath();
      ctx.lineWidth = 1 + Math.random() * stroke_width;
      let i = 0;
      for (; i < pts.length; i++) {
        x = pts[i][0]
        y = pts[i][1]
        if (i == 0) {
          x0 = x;
          y0 = y;
          ctx.moveTo(x, y);
        } else
        if (i % 3 == 0)
          ctx.bezierCurveTo(pts[i-2][0], pts[i-2][1], pts[i-1][0], pts[i-1][1], pts[i][0], pts[i][1]);
      }
      ctx.globalAlpha = (maxalpha * 0.1 + Math.random() * maxalpha * 0.75)
      ctx.stroke();
    }
  }
  ctx.restore()
}

function strokes2 () {
  let increase = Math.PI * 2 / 40;
  let x = 0, y = 0, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let color = document.getElementById("paintcolor").value
  ctx.save()
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let maxalpha = ctx.globalAlpha
  ctx.lineCap = 'round';
  ctx.lineJoin = 'round';
  let grunge = document.getElementById("grungy").checked
  let stroke_width = 11+ document.getElementById("speck_size").value/20
  let stroke_ct = +document.getElementById("number").value/200
  for (let t = 0; t < stroke_ct; t++) {
    
    let paths = [];
    let radius = Math.floor(Math.random() * 50) + 20;
    x = 0;
    y = 0;
    angle = Math.floor(Math.random() * 6.42);
    let centx = Math.random()*canvas.width/2;
    let centy = Math.random()*canvas.height/2;
    let edges = (9 * (Math.floor(Math.random()*6))+6);
    let maxradius = Math.random() * 5 + canvas.width/10;
    increase = Math.PI * 2/edges*0.52;
    points = [];
    bez = [];
    let xmut = -1;
    let ymut = -1;
    if (Math.random() < 0.5)
      xmut *= -1;
    if (Math.random() < 0.5)
      ymut *= -1;
    for (let i = 0; i < edges; i++) {
      centx += pet(canvas.width)//Math.random()*ctx.canvas.width;
      centy += pet(canvas.height)//Math.random()*ctx.canvas.height;
      radius = (Math.random() * maxradius) + maxradius * 0.5;
      x = radius * Math.cos(angle)+centx;
      y = radius * Math.sin(angle)+centy;
      points.push([x, y]);
      angle += increase;
    }
    paths.push(points);
    let pop = 60
    if (grunge)
      pop *= 2
    let offset = 10 + stroke_width * 11;
    let numpaths = 10 + Math.random()*30;
    for (let s = 0; s < numpaths; s++) {
      let path = [];
      for (let c = 0; c < points.length; c++) {
        path.push([points[c][0] + xmut*(offset + (pop * (Math.random()-0.5))), points[c][1] + ymut*(offset + (pop * (Math.random()-0.5)))]);
      }
      offset += (Math.random()-0.5) * stroke_width;
      paths.push(path);
    }
    radius = (canvas.width > canvas.height)? canvas.width/4: canvas.height/4;
    angle = Math.random()*6.27;
    let x1 = radius * Math.cos(angle)+centx;
    let y1 = radius * Math.sin(angle)+centy;
    let x2 = radius * Math.cos(angle+3.14)+centx;
    let y2 = radius * Math.sin(angle+3.14)+centy;
    for (let f = 1; f < paths.length; f++) {
      let pts = paths[f];
      ctx.beginPath();
      ctx.lineWidth = 1 + Math.random() * stroke_width;
      let i = 0;
      for (; i < pts.length; i++) {
        x = pts[i][0] + pet(13)
        y = pts[i][1] + pet(13)
        if (i == 0) {
          ctx.moveTo(x, y);
        } else
        if (i % 3 == 0)
          ctx.bezierCurveTo(pts[i-2][0], pts[i-2][1], pts[i-1][0], pts[i-1][1], pts[i][0], pts[i][1]);
      }
      if (grunge)
        ctx.strokeStyle = petColor(color, 81)
      else
        ctx.strokeStyle = petColor(color, 51)
      ctx.globalAlpha = (maxalpha * 0.1 + Math.random() * maxalpha * 0.2)
      ctx.stroke();
    }
  }
  ctx.restore()
}

function birds () {
  var increase = Math.PI * 2 / 40;
  let x = 0, y = 0
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let centerx = ctx.canvas.width / 2;
  let centery = ctx.canvas.height / 2;
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let birdradius = 3 + document.getElementById("speck_size").value/20
  let br = birdradius
  let bpet = birdradius/15
  let numshapes = 1 + Math.floor(document.getElementById("number").value/2500)
  let angle = Math.random() * 6.42;
  let m_mod = 2, t = 0;
  for (; t < numshapes; t++) {
    var petalpoints = [];
    var prepoints = [];
    var radius = 100;
    x = 0;
    y = 0;
    var x0 = x;
    var y0 = y;
    var centx = Math.random()*ctx.canvas.width+5;
    var centy = Math.random()*ctx.canvas.height+5;
    var edges = 13 * (Math.floor(Math.random()*7)+4);
    var maxradius = Math.random() * canvas.width/3 + canvas.height/3;
    var increase = Math.PI * 2/edges*0.98;
    var points = [];
    var bez = [];
    var d_angle = angle;
    for (var i = 0; i < edges; i++) {
      if (i % 3 == 0)
        radius = (Math.random() * maxradius) + maxradius * 0.8;
      else
        radius = maxradius * 1.2;
      x = radius * Math.cos(d_angle)+centx;
      y = radius * Math.sin(d_angle)+centy;
      points.push([x, y]);
      x = (radius*1.3) * Math.cos(d_angle)+centx;
      y = (radius*1.3) * Math.sin(d_angle)+centy;
      prepoints.push([x, y]);
      d_angle += increase;
    }
    var i = 0;
    for (; i < points.length; i++) {
      x = points[i][0];
      y = points[i][1];
      var prex = prepoints[i][0];
      var prey = prepoints[i][1];
      if (i == 0) {
        x0 = x;
        y0 = y;
        ctx.moveTo(x, y);
        petalpoints.push([prex, prey]);
      } else
      if (i % 3 == 0) {
        petalpoints.push([points[i][0], points[i][1]]);
      }
    }
    
    i = 0;
    for(; i < petalpoints.length; i++) {
      centx = petalpoints[i][0];
      centy = petalpoints[i][1];
      edges = 12;
      increase = Math.PI * 2/edges*0.98;
      d_angle =  angle + (Math.random() - 0.5) * 1.5;
      var ppoints = [];
      var cents = [];
      
      birdradius = br +  Math.random() * 0.3 * br;
      for (var p = 0; p < edges; p++) {
        radius = birdradius + Math.random() * 0.5 * birdradius;
        if (p === 6) // 6
          radius = birdradius * 1.7 + pet(1);
        if ((p === 3 || p === 9) && m_mod === 2)
          radius = birdradius * (4.5 + Math.random()/3);
        if (p === 5 || p === 7)
          radius = birdradius * (0.2 + Math.random()/3);
        if (p === 2 || p === 10)
          radius = birdradius * (1.0 + Math.random()/3);
        if (p === 1 || p === 11)
          radius = birdradius * (0.05 + Math.random()/3);
        if (p == 0)
          radius = birdradius * (0.6 + Math.random()/3);
        if (p === 4 || p === 8) {
          if (Math.random() > 0.8)
            radius = birdradius * 0.6;
          else
            radius = birdradius * 1.2;
        }
        if (Math.random() < 0.1) {
          if (p === 3 || p === 9 || p == 2 || p == 10)
            radius = birdradius * (1.2 + Math.random()/3);
        }
        x = (radius+pet(8)) * Math.cos(d_angle + pet(bpet)/100)+centx;
        y = (radius+pet(8)) * Math.sin(d_angle + pet(bpet)/100)+centy;
        ppoints.push([x, y]);
        d_angle += increase;
      }
      ctx.beginPath();
      var j = 0;
      for (;j < ppoints.length; j++) {
        x = ppoints[j][0];
        y = ppoints[j][1];
        if (j == 0) {
          x0 = x;
          y0 = y;
          ctx.moveTo(x, y);
        } else
        if (j % m_mod === 0) {
          ctx.bezierCurveTo(ppoints[j-2][0] + pet(bpet), ppoints[j-2][1] + pet(bpet), ppoints[j-1][0] + pet(bpet), ppoints[j-1][1] + pet(bpet), ppoints[j][0], ppoints[j][1]);
        }
      }
      ctx.bezierCurveTo(ppoints[j-2][0], ppoints[j-2][1], ppoints[j-1][0], ppoints[j-1][1], x0, y0);
      ctx.closePath();
      ctx.fill();
    }
  }
}

function rothko () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = canvas.width
  let ch = canvas.height
  let rows = 3
  let margin = 16 + Math.random() * rows * 9
  let gap = margin/4
  let oc = ctx.fillStyle = document.getElementById("paintcolor").value
  let op = document.getElementById("speck_opacity").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let grunge = document.getElementById("grungy").checked
  let numshapes = 2 + (Math.floor(Math.random() * 2))
  let colors = shuffle(['#cc0000', '#bb4000', '#a000a0', '#0000aa','#004099', '#007020', '#F8A500', '#d8c500', '#dddddd', '#300000','#444444','#666666'])
  let fcolors = []
  let i = 0
  for (; i < numshapes; i++)
    fcolors.push(randomPick(colors))
  let bcolors = ['#300000','#444444', '#dddddd', '#666666']
  i = 0
  for (; i < fcolors.length; i++)
    bcolors.push(fcolors[i])
  ctx.fillStyle  = randomPick(bcolors)
  ctx.fillRect(0, 0, w, ch)
  let hts = new Array(numshapes)
  let h = 0, H = ch - (margin/numshapes)
  for (; h < numshapes; h++) {
    let part = 61+ Math.random() * H/numshapes
    hts[h] = part
    H -= part
  }
  if (H > margin)
    hts[1] += H - margin
  if (H < 0)
    hts[0] -= H
  let shapeheight = w/numshapes - (margin/numshapes)
  i = 0, g = 0
  let top = margin
  let m0 = margin
  let marvar = w/24
  for (; i < numshapes; i++) {
    let points = []
    shapeheight = hts[i]
    margin += (Math.random() * marvar)
    ctx.beginPath();
    ctx.moveTo(margin+pet(9), top+pet(9))
    ctx.lineTo(w-margin+pet(9), top+pet(9))
    ctx.lineTo(w-margin+pet(9), top+shapeheight-margin+pet(9))
    ctx.lineTo(margin+pet(9), top+shapeheight-margin+pet(9))
    points.push(margin+pet(9), top+pet(9))
    points.push(w-margin+pet(9), top+pet(9))
    points.push(w-margin+pet(9), top+shapeheight-margin+pet(9))
    points.push(margin+pet(9), top+shapeheight-margin+pet(9))
    ctx.closePath()
    ctx.fillStyle = petColor(randomPick(fcolors), 30)
    ctx.fill()
    ctx.globalAlpha = document.getElementById("speck_opacity").value/180
    frameRect(points, ctx.fillStyle, margin)
    ctx.globalAlpha = document.getElementById("speck_opacity").value/100
    g += gap
    top += shapeheight
    margin = m0
  }
  let functions = ["dotblur", /*"jaggyblur", "dirblur"*/]
  document.getElementById("speck_size").value = 45 + pet(15)
  document.getElementById("speck_opacity").value = 25 + pet(15)
  ctx.fillStyle = petColor(randomPick(bcolors), 30)
  dissOver()
  let f = randomPick(functions)
  document.getElementById("speck_opacity").value = 20 + pet(10)
  window[f](canvas)
  document.getElementById("speck_size").value = 20 + Math.random() * 5
  f = randomPick(functions)
  window[f](canvas)
  document.getElementById("speck_size").value = 9 + Math.random() * 5
  dissOver()
  f = randomPick(functions)
  window[f](canvas)
  document.getElementById("speck_opacity").value = 20 + pet(10)
  document.getElementById("paintcolor").value =  "#000000"
  haze()
  document.getElementById("speck_opacity").value = op
  document.getElementById("paintcolor").value = oc
  refreshMode()
}

function seedRect () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = canvas.width
  let rows = 1
  let margin = 4 + Math.random() * 11
  let gap = margin/2
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let grunge = document.getElementById("grungy").checked
  clip()
  let h = 17, H = 23
  let shapeheight = 17 + Math.random() * 50
  let i = 0, g = 0
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'white', 'purple', "green", 'black'])
  let top = margin + 9
  let points = []
  ctx.beginPath();
  ctx.moveTo(margin, top)
  ctx.lineTo(w-margin, top)
  ctx.lineTo(w-margin, top+shapeheight-margin)
  ctx.lineTo(margin, top+shapeheight-margin)
  points.push(margin, top)
  points.push(w-margin, top)
  points.push(w-margin, top+shapeheight-margin)
  points.push(margin, top+shapeheight-margin)
  ctx.closePath()
  if (grunge)
    ctx.fillStyle = randomPick(colors)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/400
  frameRect(points, ctx.fillStyle, margin)
    ctx.fillStyle = randomColor()
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.restore()
}

function grid () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = canvas.width, h = canvas.height
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = Math.floor(1 +  document.getElementById("speck_size").value/10)
  let spacing = Math.floor(1 + (document.getElementById("number").value/100))
  let ratio = 1
  if (document.getElementById("grungy").checked)
    ratio = 3
  spacing += ctx.lineWidth * 2
  let i = 0
  let margin = 40
  let maxh = (h - (2 * margin))/spacing
  let y = margin
 /* for (; i < maxh; i++) { // horizontal
    ctx.beginPath()
    ctx.moveTo(margin, y)
    ctx.lineTo(w-margin, y)
    ctx.closePath()
    ctx.stroke()
    y += spacing
  }*/
  i = 0
  maxh = (w - (2 * margin))/(spacing*ratio)
  let x = margin
  for (; i < maxh; i++) {
    ctx.beginPath()
    ctx.moveTo(x, margin)
    ctx.lineTo(x, h-margin)
    ctx.closePath()
    ctx.stroke()
    x += spacing*ratio
  }
}

function gridOG () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = canvas.width
  let r = 2 + Math.floor(Math.random() * 7)
  let margin = w/10
  let n = (canvas.width-margin/2)/r
  let noff = n/4
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  //ctx.save()
  clip()
  let grunge = document.getElementById("grungy").checked
  let colors = shuffle(['red', 'blue', 'yellow', 'orange', 'white', 'purple', "green", 'black'])
  let type = (Math.random() > 0.5)? "r": "c"
  let numshapes = r*r
  let i = 0, x = noff*1.25, y = noff*1.25
  for (; i < numshapes; i++) {
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    if (grunge) {
      shuffle(colors)
      ctx.fillStyle = colors[0]
    }
    ctx.beginPath();
    if (type == "rxxxxxxx") {
      ctx.moveTo(x, y)
      ctx.lineTo(x + n*0.75, y)
      ctx.lineTo(x + n*0.75, y + n*0.75)
      ctx.lineTo(x, y + n*0.75)
    } else
      ctx.arc(x+noff,y+noff, noff, 0, 2*Math.PI);
    ctx.closePath()
    ctx.fill()
    x += n
    if (i > 0 && i % r === (r-1)) {
      y += n
      x = noff*1.25
    }
  }
  ctx.restore()
}

function rays () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let D =  (5 + Math.floor(document.getElementById("speck_size").value/50))
  let grunge = document.getElementById("grungy").checked
  let W = canvas.width
  let H = canvas.height
  ctx.globalAlpha = document.getElementById("speck_opacity").value/200
  clip()
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = 0.25
  let x = Math.random() * W, y = Math.random() * H
  let w = 2 +Math.random()*14
  let p = 1+D*3
  let i = 0
  let s = 0
  let x2 = 0, y2 = 0
  while (s < 100) {
    x2 = (Math.random() - 0.5) * W * 4
    y2 = (Math.random() - 0.5) * W * 4
    ctx.beginPath()
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x2, y2)
    ctx.closePath()
    ctx.stroke()
    
    y += pet(89)
    x += pet(89)
    s++
  }
}

function walk () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let D =  (5 + Math.floor(document.getElementById("speck_size").value/80))
  let grunge = document.getElementById("grungy").checked
  let angledelta = 0.3
  if (grunge)
    angledelta = 0.8
  let W = canvas.width
  let H = canvas.height
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let x = Math.random() * W, y = Math.random() * H
  let p = 1+D*1
  let i = 0
  let s = 0
  let angle = Math.random()*2*Math.PI;
  let stepsize = 1
  let w = 1 + Math.random()*D/10
  while (s < 2000) {
    w = 1 + Math.random()*D/25
    ctx.beginPath()
    if (s > 100  && s < 800 && Math.random() > 0.96) {
      D *=1.03
      p = 1+D/2
      stepsize = 2
    } else
    if (s > 800 && Math.random() > 0.9) {
      D /=1.03
      p = 1+D
      stepsize = 1
    }
    angle += (Math.random()-0.5) * angledelta
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y +pet(p))
    ctx.lineTo(x + w + pet(p), y+w +pet(p))
    ctx.lineTo(x + pet(p), y+w+pet(p))
    ctx.closePath()
    ctx.fill()
    x += 1 * Math.cos(angle)
    y += 1 * Math.sin(angle)
    w += 0.001
    s++
  }
}

function frame () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let D =  (5 + Math.floor(document.getElementById("speck_size").value/4))
  let grunge = document.getElementById("grungy").checked
  let W = canvas.width
  let H = canvas.height
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let x = -1, y = -1
  let w = 6 +Math.random()*14
  let p = 6+D*1.2
  let i = 0
  while (y < canvas.height) {
    w = D +Math.random()*D/2
    ctx.beginPath()
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y +pet(p))
    ctx.lineTo(x + w + pet(p), y+w +pet(p))
    ctx.lineTo(x + pet(p), y+w+pet(p))
    ctx.closePath()
    ctx.fill()
    
    ctx.beginPath()
    ctx.moveTo(W - pet(p), y+pet(p))
    ctx.lineTo(W - w + pet(p), y +pet(p))
    ctx.lineTo(W - w + pet(p), y+w +pet(p))
    ctx.lineTo(W - pet(p), y+w+pet(p))
    ctx.closePath()
    ctx.fill()
    y += 2
  }
  x = 0, y = -1
  while (x < canvas.width) {
    w = D +Math.random()*D/2
    ctx.beginPath()
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y +pet(p))
    ctx.lineTo(x + w + pet(p), y+w +pet(p))
    ctx.lineTo(x + pet(p), y+w+pet(p))
    ctx.closePath()
    ctx.fill()
    
    ctx.beginPath()
    ctx.moveTo(x - pet(p), H-pet(p))
    ctx.lineTo(x - w + pet(p), H -pet(p))
    ctx.lineTo(x - w + pet(p), H-w -pet(p))
    ctx.lineTo(x - pet(p), H-w-pet(p))
    ctx.closePath()
    ctx.fill()
    x += 2
  }
  ctx.restore()
}

function rectFrame () {
  const rect = true
  framePolaroid(rect)
}

function framePolaroid (rect) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let D =  (5 + Math.floor(document.getElementById("speck_size").value/3))
  let grunge = document.getElementById("grungy").checked
  let W = canvas.width
  let H = canvas.height
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let x = -1, y = -1
  let w = 6 + Math.random()*14
  let wobble = 8
  if (document.getElementById("grungy").checked)
    wobble = 4
  
  let i = 0
  while (y < canvas.height) {
    w = D +Math.random()*D/wobble
    ctx.beginPath()
    ctx.moveTo(x, y)
    ctx.lineTo(x + w, y )
    ctx.lineTo(x + w, y+w )
    ctx.lineTo(x , y+w)
    ctx.closePath()
    ctx.fill()
    
    ctx.beginPath()
    ctx.moveTo(W, y)
    ctx.lineTo(W - w, y )
    ctx.lineTo(W - w, y+w )
    ctx.lineTo(W, y+w)
    ctx.closePath()
    ctx.fill()
    y += 2
  }
  x = 0, y = -1
  while (x < canvas.width) {
    w = D +Math.random()*D/wobble
    ctx.beginPath()
    ctx.moveTo(x, y)
    ctx.lineTo(x + w, y )
    ctx.lineTo(x + w, y+w )
    ctx.lineTo(x, y+w)
    ctx.closePath()
    ctx.fill()
    
    if (rect) {
      ctx.beginPath()
      ctx.moveTo(x, H)
      ctx.lineTo(x - w, H)
      ctx.lineTo(x - w, H-w)
      ctx.lineTo(x, H-w)
      ctx.closePath()
      ctx.fill()
      x += 2
    } else {
      ctx.beginPath()
      ctx.moveTo(x, H)
      ctx.lineTo(x - w, H)
      ctx.lineTo(x - w, H-3*w)
      ctx.lineTo(x, H-3*w)
      ctx.closePath()
      ctx.fill()
      x += 2
    }
  }
  ctx.restore()
}

function frameRect (points, c, margin) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let D =  (5 + Math.floor(document.getElementById("speck_size").value/10))
  let grunge = document.getElementById("grungy").checked
  let H = distance(points[0], points[1], points[6], points[7])
  let W = distance(points[0], points[1], points[2], points[3])
  ctx.fillStyle = c
  let w = 6 + Math.random()*14
  let h = w/2
  let p = 6+D*1.5
  let x = points[0], y = points[1]

  while (y < points[5]-w) {
    w = D +Math.random()*D/2
    ctx.beginPath()
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y +pet(p))
    ctx.lineTo(x + w + pet(p), y+w +pet(p))
    ctx.lineTo(x + pet(p), y+w+pet(p))
    ctx.closePath()
    ctx.fill()
    
    ctx.beginPath()
    ctx.moveTo(points[2] - pet(p), y + pet(p))
    ctx.lineTo(points[2] - w + pet(p), y + pet(p))
    ctx.lineTo(points[2] - w + pet(p), y + w + pet(p))
    ctx.lineTo(points[2] - pet(p), y + w + pet(p))
    ctx.closePath()
    ctx.fill()
    y += 2
  }
  
  x = points[0], y = points[1]
  while (x < points[2]-w) {
    w = D +Math.random()*D/2
    ctx.beginPath()
    ctx.moveTo(x + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y+pet(p))
    ctx.lineTo(x + w + pet(p), y+w +pet(p))
    ctx.lineTo(x + pet(p), y+pet(p))
    ctx.closePath()
    ctx.fill()
    
    ctx.beginPath()
    ctx.moveTo(x + pet(p), points[5]-pet(p))
    ctx.lineTo(x + w + pet(p), points[5] -pet(p))
    ctx.lineTo(x + w + pet(p), points[5]-pet(p))
    ctx.lineTo(x + pet(p), points[5]-pet(p))
    ctx.closePath()
    ctx.fill()
    x += 2
  }
}

function tile (type) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let sides =  (2 + Math.floor(document.getElementById("speck_size").value/20))
  let w = canvas.width
  let n = canvas.width/sides
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  let colors = []
  let c = 0
  let nc = 1 + (Math.floor(Math.random() * 3))
  for (; c < nc; c++)
    colors.push(randomColor())
  if (type == "C2" || type == "B2") {
    colors.push(randomColor())
    colors.push(randomColor())
    colors.push(randomColor())
  }
  let numshapes = sides*sides
  let i = 0, x = 0, y = 0
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (type != "W")
    ctx.fillRect(0, 0, w, w)
  ctx.fillStyle = randomColor()//randomGradient(canvas, document.getElementById("paintcolor").value)
  let grunge = document.getElementById("grungy").checked
  let rc = randomColor()
  let pattern = [0,1,2,3,4,5,6,7,8,9,10,11]
  shuffle(pattern)
  for (; i < numshapes; i++) {
    ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)]
    if (grunge)
        ctx.fillStyle = randomGradient(canvas, colors[Math.floor(Math.random() * colors.length)])
    if (type == "D")
      dtile(x,y,n,pattern[i%5])
    else
    if (type == "M")
      mtile(x,y,n, pattern[i%8])
    else
    if (type == "C")
      ctile(x,y,n,pattern[i%4])
    else
    if (type == "C2") {
      ctile2(x,y,n, colors, grunge, pattern[i%4])
    } else
    if (type == "B2") {
      btile(x,y,n, colors, grunge)
    } else
    if (type == "W") {
      bwash(x,y,n)
    } else
      triangle(x, y, n, pattern[i%4])
    x += n
    if (i > 0 && i % sides === (sides-1)) {
      y += n
      x = 0
    }
  }
  ctx.restore()
}

function shuffle (array) {
  return array.sort(() => Math.random() - 0.5);
}

function circle () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let cx = canvas.width/2 + (Math.random()-0.5) * 200
  let cy = canvas.height/2 + (Math.random()-0.5) * 200
  let r = 10 + Math.floor(document.getElementById("speck_size").value)
  r += pet(r/3)
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.beginPath()
  ctx.moveTo(cx, cy)
  ctx.arc (cx, cy, r, 0, 2*Math.PI)
  ctx.closePath()
  ctx.fill()

  ctx.restore()
}

function sides () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = 21+document.getElementById("speck_size").value/1
  w += 41 * Math.random()
  let x = 0, y = 0
  let x2 = w
  let y2 = canvas.height
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (document.getElementById("grungy").checked)
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  
  ctx.beginPath()
  ctx.moveTo(x, y)
  ctx.lineTo(x2, y)
  ctx.lineTo(x2, y2)
  ctx.lineTo(x, y2)
  ctx.closePath()
  ctx.fill()
}

function sides2 () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let w = 21+document.getElementById("speck_size").value/3
  w += 41 * Math.random()
  let x = canvas.width * Math.random() - w, y = 0
  let x2 = x + w
  let y2 = canvas.height
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (document.getElementById("grungy").checked)
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.beginPath()
  ctx.moveTo(x, y)
  ctx.lineTo(x2, y)
  ctx.lineTo(x2, y2)
  ctx.lineTo(x, y2)
  ctx.closePath()
  ctx.fill()
}

function square (x, y, w) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let cx = canvas.width/2 + (Math.random()-0.5) * 200
  let cy = canvas.height/2 + (Math.random()-0.5) * 200
  let len = 10 + 2 * Math.floor(document.getElementById("speck_size").value)
  clip()
  cx -= len/2
  cy -= len/2
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (document.getElementById("grungy").checked)
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.beginPath()
  ctx.moveTo(cx, cy)
  ctx.lineTo(cx+len, cy)
  ctx.lineTo(cx+len, cy+len)
  ctx.lineTo(cx, cy+len)
  ctx.closePath()
  ctx.fill()
  ctx.restore()
}

function bwash (x, y, w) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.save()
  if (Math.random() > 0.01) {
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.lineTo(x+w, y)
    ctx.lineTo(x+w, y+w)
    ctx.lineTo(x, y+w)
    ctx.closePath()
    ctx.fill()
  }
  ctx.restore()
}

function btile (x, y, w, colors, grunge) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.save
  if (grunge) {
    x += pet(13), y += pet(13)
  }
  if (Math.random() > 0.1) {
    shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.lineTo(x+w, y)
    ctx.lineTo(x+w, y+w)
    ctx.lineTo(x, y+w)
    ctx.closePath()
    ctx.fill()
  }
  if (Math.random() > 0.0) {
    
    shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x+w/2,y+w/2)
    ctx.arc (x+w/2, y+w/2, w/2.1 - (Math.random() * w/3), 0, 2*Math.PI)
    ctx.closePath()
    ctx.fill()
  }
  ctx.restore()
}

function ctile2 (x, y, w, colors, grunge, i) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let q = i%4
  ctx.save()
  if (q == 0) {
    if (grunge)
      shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.arc (x, y, w, 0, 0.5*Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[1]
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.arc (x, y, 2*w/3, 0, 0.5*Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.arc (x, y, w/3, 0, 0.5*Math.PI)
    ctx.closePath()
    ctx.fill()
  } else
  if (q == 1) {
    if (grunge)
      shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x,y+w)
    ctx.arc (x, y+w, w, 1.5*Math.PI, 0)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[1]
    ctx.beginPath()
    ctx.moveTo(x,y+w)
    ctx.arc (x, y+w, 2*w/3, 1.5*Math.PI, 0)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x,y+w)
    ctx.arc (x, y+w, w/3, 1.5*Math.PI, 0)
    ctx.closePath()
    ctx.fill()
  } else
  if (q == 2) {
    if (grunge)
      shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x+w,y)
    ctx.arc (x+w, y, w, 0.5*Math.PI, Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[1]
    ctx.beginPath()
    ctx.moveTo(x+w,y)
    ctx.arc (x+w, y, 2*w/3, 0.5*Math.PI, Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x+w,y)
    ctx.arc (x+w, y, w/3, 0.5*Math.PI, Math.PI)
    ctx.closePath()
    ctx.fill()
  } else
  if (q == 3) {
    if (grunge)
      shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x+w,y+w)
    ctx.arc (x+w, y+w, w, Math.PI, 1.5*Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[1]
    ctx.beginPath()
    ctx.moveTo(x+w,y+w)
    ctx.arc (x+w, y+w, 2*w/3, Math.PI, 1.5*Math.PI)
    ctx.closePath()
    ctx.fill()
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.moveTo(x+w,y+w)
    ctx.arc (x+w, y+w, w/3, Math.PI, 1.5*Math.PI)
    ctx.closePath()
    ctx.fill()
  } else
  if (q == 4) {
    if (grunge)
      shuffle(colors)
    ctx.fillStyle = colors[0]
    ctx.beginPath()
    ctx.fillRect(x,y,w,w)
    ctx.closePath()
    if (Math.random() < 0.5) {
      ctx.fillStyle = colors[1]
      ctx.beginPath()
      ctx.moveTo(x+w/3, y)
      ctx.lineTo(x+2*w/3, y)
      ctx.lineTo(x+2*w/3, y+w)
      ctx.lineTo(x+w/3, y+w)
      ctx.closePath()
      ctx.fill()
    } else {
      ctx.fillStyle = colors[1]
      ctx.beginPath()
      ctx.moveTo(x, y+w/3)
      ctx.lineTo(x+w, y+w/3)
      ctx.lineTo(x+w, y+2*w/3)
      ctx.lineTo(x, y+2*w/3)
      ctx.closePath()
      ctx.fill()
    }
  }
  ctx.restore()
}

function ctile (x, y, w, i) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let q = i % 4//Math.floor(Math.random() * 4)
  ctx.beginPath()
  if (q == 1) {
    ctx.moveTo(x,y)
    ctx.arc (x, y, w, 0, 0.5*Math.PI)
  } else
  if (q == 0) {
    ctx.moveTo(x,y+w)
    ctx.arc (x, y+w, w, 1.5*Math.PI, 0)
  } else
  if (q == 3) {
    ctx.moveTo(x+w,y)
    ctx.arc (x+w, y, w, 0.5*Math.PI, Math.PI)
  } else
  if (q == 2) {
    ctx.moveTo(x+w,y+w)
    ctx.arc (x+w, y+w, w, Math.PI, 1.5*Math.PI)
  } else
    ctx.fillRect(x,y,w,w)
  ctx.closePath()
  ctx.fill()
}

function dtile (x, y, w, i) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let q = i%5
  ctx.beginPath()
  if (q == 0) {
    ctx.arc (x+w/2, y, w/2, 0, Math.PI)
  } else
  if (q == 1) {
    ctx.arc (x, y+w/2, w/2, 1.5*Math.PI, 0.5*Math.PI)
    
  } else
  if (q == 2) {
    ctx.arc (x+w, y+w/2, w/2, 0.5*Math.PI, 1.5*Math.PI)
    
  } else
  if (q == 3) {
    ctx.arc (x+w/2, y+w, w/2, Math.PI, 0)
  } else
    ctx.arc (x+w/2, y+w/2, w/2, 2*Math.PI, 0)
  ctx.closePath()
  ctx.fill()
}

function mtile (x, y, w, i) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");

  let q = i%8
  ctx.beginPath()
  if (q == 0) {
    ctx.moveTo (x, y)
    ctx.lineTo(x+w, y)
    ctx.lineTo(x+w/2, y+w/2)
  } else
  if (q == 1) {
    ctx.moveTo (x, y)
    ctx.lineTo(x, y+w)
    ctx.lineTo(x+w/2, y+w/2)
  } else
  if (q == 2) {
    ctx.moveTo (x+w, y)
    ctx.lineTo(x+w, y+w)
    ctx.lineTo(x+w/2, y+w/2)
  } else
  if (q == 3) {
    ctx.moveTo (x+w, y)
    ctx.lineTo(x, y)
    ctx.lineTo(x+w/2, y+w/2)
  } else
  if (q == 4) {
    ctx.arc (x+w/2, y, w/2, 0, Math.PI)
  } else
  if (q == 5) {
    ctx.arc (x, y+w/2, w/2, 1.5*Math.PI, 0.5*Math.PI)
    
  } else
  if (q == 6) {
    ctx.arc (x+w, y+w/2, w/2, 0.5*Math.PI, 1.5*Math.PI)
    
  } else
  if (q == 7) {
    ctx.arc (x+w/2, y+w, w/2, Math.PI, 0)
  }
  ctx.closePath()
  ctx.fill()
}

function triangle (x, y, w, i) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  // draw a triangle in one or four orientations
  // pick 3 corners |_ -| _| |-
  
  let q = i % 4
  ctx.beginPath()
  if (q == 0) {
    ctx.moveTo (x, y)
    ctx.lineTo(x+w, y)
    ctx.lineTo(x+w, y+w)
  } else
  if (q == 1) {
    ctx.moveTo (x, y)
    ctx.lineTo(x, y+w)
    ctx.lineTo(x+w, y+w)
  } else
  if (q == 2) {
    ctx.moveTo (x+w, y)
    ctx.lineTo(x+w, y+w)
    ctx.lineTo(x, y+w)
  } else {
    ctx.moveTo (x+w, y)
    ctx.lineTo(x, y)
    ctx.lineTo(x, y+w)
  }
  ctx.closePath()
  ctx.fill()
}

function albers () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let f1 = W/9.6
  let f2 = 2* f1
  let f3 = 3 * f1
  let f4 = 4 *f1
  let len = W/2, maxy = W/2
  let quat = len/2
  let top = f1/4
  let t = top
  // 4 rects
  ctx.save()
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let grunge = document.getElementById("grungy").checked
  
  top = 0
  clip()
  
  ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(0+top, 0 + top)
  ctx.lineTo(W-top, 0 + top)
  ctx.lineTo(W-top, W-top)
  ctx.lineTo(0+top, W-top)
  ctx.closePath()
  ctx.fill()
  
  top += t*2
  ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(f1, f1+top)
  ctx.lineTo(W-f1, f1+top)
  ctx.lineTo(W-f1, W-f1+top)
  ctx.lineTo(f1, W-f1+top)
  ctx.closePath()
  ctx.fill()
  
  top += t * 2
  ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(f2, f2+top)
  ctx.lineTo(W-f2, f2+top)
  ctx.lineTo(W-f2, W-f2+top)
  ctx.lineTo(f2, W-f2+top)
  ctx.closePath()
  ctx.fill()
  
  top += t*2
  ctx.fillStyle = randomColor()
  if (grunge)
    ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.beginPath();
  ctx.moveTo(f3, f3+top)
  ctx.lineTo(W-f3, f3+top)
  ctx.lineTo(W-f3, W-f3+top)
  ctx.lineTo(f3, W-f3+top)
  ctx.closePath()
  ctx.fill()
  ctx.restore()
}

function concentriccirc() {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let r = canvas.width/2
  let f1 = r/4
  let x = r, y = r
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.fillRect(0,0,canvas.width,canvas.height)
  ctx.beginPath();
  ctx.arc(x, y, r, 0, 2*Math.PI);
  ctx.closePath()
  ctx.fill()

  r -= f1
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.arc(x, y, r, 0, 2*Math.PI);
  ctx.closePath()
  ctx.fill()

  r -= f1
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.arc(x, y, r, 0, 2*Math.PI);
  ctx.closePath()
  ctx.fill()

  r -= f1
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.arc(x, y, r, 0, 2*Math.PI);
  ctx.closePath()
  ctx.fill()
  ctx.restore()
}

function concentric () {
  if (Math.random() > 0.5)
    concentriccirc()
  else
    concentricrect()
}

function concentricrect () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let f1 = W/8
  let f2 = 2* f1
  let f3 = 3 * f1
  let len = W/2, maxy = W/2
  let quat = len/2
  // 4 rects
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let grunge = document.getElementById("grungy").checked

  clip()
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(0, 0)
  ctx.lineTo(W, 0)
  ctx.lineTo(W, W)
  ctx.lineTo(0, W)
  ctx.closePath()
  ctx.fill()

  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(f1, f1)
  ctx.lineTo(W-f1, f1)
  ctx.lineTo(W-f1, W-f1)
  ctx.lineTo(f1, W-f1)
  ctx.closePath()
  ctx.fill()

  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(f2, f2)
  ctx.lineTo(W-f2, f2)
  ctx.lineTo(W-f2, W-f2)
  ctx.lineTo(f2, W-f2)
  ctx.closePath()
  ctx.fill()

  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  if (grunge)
    ctx.fillStyle = randomColor()
  ctx.beginPath();
  ctx.moveTo(f3, f3)
  ctx.lineTo(W-f3, f3)
  ctx.lineTo(W-f3, W-f3)
  ctx.lineTo(f3, W-f3)
  ctx.closePath()
  ctx.fill()
  ctx.restore()
}

function chips () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let maxdist = Math.pow(Math.pow(cx, 2) + Math.pow(cy, 2), 0.5) +200
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.strokeStyle = document.getElementById("paintcolor").value
  for (var t = 0; t < 5; t++) {
    var radius = 13
    x = 0;
    y = 0;
    var x0 = x;
    var y0 = y;
    angle = Math.floor(Math.random() * 6.42);
    ctx.beginPath();
    var cent = Math.random()*ctx.canvas.width+50;
    var centy = Math.random()*ctx.canvas.height+50;
    var edges = 3+Math.random()*26;
    let max = Math.PI * 2
    let increase = Math.PI * 2/edges;
    for (var i = 0; i < 100; i++) {
      increase += Math.random()/50
      radius = 13 + (13/2 * Math.random())
      x = radius * Math.cos(angle)+cent;
      y = radius * Math.sin(angle)+centy;
      ctx.lineTo(x, y);
      angle += increase;
      if (angle >= max)
        break;
    }
    ctx.closePath();
    ctx.fill()
  }
}

function chaze () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let G = document.getElementById("grungy").checked
  let multiplier = 1.5
  if (G)
    multiplies = 3
  clip()
  let x = canvas.width/2 + pet(170)
  let y = canvas.height/2 + pet(170)
  let x1 = canvas.width/2 + pet(300)
  let y1 = canvas.height/2 + pet(300)
  let r = x * (multiplier + Math.random()/2)
  let r1 = r/5
  let rg = ctx.createRadialGradient(x, y, r, x1, y1, r1)
  let col1 = document.getElementById("paintcolor").value
  let col2 = "rgba("+hexToR(col1)+", "+hexToG(col1)+", "+hexToB(col1)+", 0.0)";// transparent
  rg.addColorStop(0.01, col1);
  rg.addColorStop(document.getElementById("speck_opacity").value/100, col2);
  ctx.fillStyle = rg
  ctx.fillRect(0,0,canvas.width, canvas.height)
  ctx.restore()
}

function rectify () {
  let width = document.getElementById("speck_size").value/5
  width = (100 - width + 2)
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let W = 2 + Math.floor(document.getElementById("speck_size").value/10)
  let wdivs = W
  let cw = canvas.width
  let ch = canvas.height
  let w = cw/wdivs
  let hdivs = Math.round(wdivs * ch/cw)
  let h = ch/hdivs
  let i = 0, x = w, y = 0
  let N =(1+wdivs) * (1+hdivs)
  for (; i < N; i++) {
    if (Math.random() < 0.5)
      hazeRect(x, y, x+w, y-h)
    x += w
    if (x >= (wdivs)*w) {
      x = 0
      y += h
    }
  }
}

function hazeRect (x1, y1, x2, y2) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.fillStyle = randomGradientRect(canvas, document.getElementById("paintcolor").value, x1, y1, x2, y2)
  let sx = (x1<x2)? x1:x2
  let lx = (x1>x2)? x1:x2
  
  let sy = (y1<y2)? y1:y2
  let ly = (y1>y2)? y1:y2
  
  ctx.fillRect(sx,sy,lx-sx,ly-sy)
}

function haze () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  ctx.fillRect(0,0,canvas.width, canvas.height)
  ctx.restore()
}

function makeSquare (all) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  W = canvas.width
  H = canvas.height
  if (W == H)
    return
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let canvasoff = document.getElementById("off")
  let ctxoff = canvasoff.getContext("2d")
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctxoff.drawImage(canvas,0,0)
  let pad = 0, x = 0, y = 0
  if (H > W) {
    x = (H-W)/2
    canvas.width += (H-W)
  } else
  if (W > H) {
    y = (W-H)/2
    canvas.height += (W-H)
  }
  syncBackground(canvas)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  ctx.drawImage(canvasoff, x, y)
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctx.globalCompositeOperation = mode
}

function makeSquare2 (all) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  W = canvas.width
  H = canvas.height
  if (W == H)
    return
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let canvasoff = document.getElementById("off")
  let ctxoff = canvasoff.getContext("2d")
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctxoff.drawImage(canvas,0,0)
  let pad = 0, x = 0, y = 0
  if (H > W) {
    x = 0//(H-W)/2
    canvas.width += (H-W)
  } else
  if (W > H) {
    y = 0//(W-H)/2
    canvas.height += (W-H)
  }
  syncBackground(canvas)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  ctx.drawImage(canvasoff, x, y)
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctx.globalCompositeOperation = mode
}

function expandMargins (all) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let canvasoff = document.getElementById("off")
  let ctxoff = canvasoff.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  let value = +document.getElementById("rednumber").value

  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctxoff.drawImage(canvas,0,0)
  W = canvas.width
  if (all)
    canvas.width += value
  H = canvas.height
  if (!all && grunge)
    canvas.height *= 2
  else
    canvas.height += value
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height

  let yoffset = 0
  if (all)
    yoffset = (canvas.height-H)/2
  ctx.drawImage(canvasoff, (canvas.width-W)/2, yoffset)
  
  syncMarker()
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctx.globalCompositeOperation = mode
  syncBackground(canvas)
}

function nudgeUp () {
  nudgeCanvas(true)
}

function nudgeDown () {
  nudgeCanvas(false)
}

function nudgeCanvas (up) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  ctx.globalAlpha = 1.0//document.getElementById("speck_opacity").value/100
  let canvasoff = document.getElementById("off")
  let ctxoff = canvasoff.getContext("2d")
  let value = +document.getElementById("rednumber").value
  if (up)
    value *= -1
  canvasoff.width = canvas.width
  canvasoff.height = canvas.height
  ctxoff.drawImage(canvas,0,0)
  ctx.clearRect(0,0,canvas.width, canvas.height)
  ctx.drawImage(canvasoff, 0, value)
  ctxoff.clearRect(0,0,canvasoff.width, canvasoff.height)
  syncBackground(canvas)
}

function fill (canvas, fs) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (fs)
    ctx.fillStyle = fs
  ctx.fillRect(0,0,canvas.width, canvas.height)
}

function hazeo () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  let G = document.getElementById("grungy").checked
  if ((G && Math.random() > 0.7) || !G)
    ctx.fillRect(0,0,canvas.width, canvas.height)
}

function rc () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalCompositeOperation = "source-over"
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  let cx = canvas.height/2, cy = canvas.width/2
  ocanvas.height = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.width = (canvas.height > canvas.width)? canvas.height: canvas.width
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  let swap = canvas.height
  canvas.height = canvas.width
  canvas.width = swap
  syncBackground(canvas)
  cx = canvas.height/2, cy = canvas.width/2
  ctx.translate(cy, cx)
  ctx.rotate(Math.PI * 0.5)
  ctx.translate(-cx,-cy)
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  //LASTCLICK[0] = myCanvas.width/2
  //LASTCLICK[1] = myCanvas.height/2
  ctx.globalAlpha = a
  refreshMode()
  syncMarker()
}

function rcc () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalCompositeOperation = "source-over"
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  let cx = canvas.height/2, cy = canvas.width/2
  ocanvas.height = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.width = (canvas.height > canvas.width)? canvas.height: canvas.width
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  let swap = canvas.height
  canvas.height = canvas.width
  canvas.width = swap
  syncBackground(canvas)
  cx = canvas.height/2, cy = canvas.width/2
  ctx.translate(cy, cx)
  ctx.rotate(Math.PI * -0.5)
  ctx.translate(-cx,-cy)
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
  //LASTCLICK[0] = myCanvas.width/2
  //LASTCLICK[1] = myCanvas.height/2
  ctx.globalAlpha = a
  refreshMode()
  syncMarker()
}

function flipH () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalCompositeOperation = "source-over"
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  ctx.translate(canvas.width, 0)
  ctx.scale(-1,1)
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.globalAlpha = a
  refreshMode()
}

function flipV () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.globalCompositeOperation = "source-over"
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  ctx.translate(0, canvas.height)
  ctx.scale(1,-1)
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.globalAlpha = a
  refreshMode()
}

function flipStrip () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let w = 40 + Math.random() * canvas.width/2
  let x = (canvas.width) * Math.random()
  octx.clearRect(0,0,canvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  octx.clearRect(0,0,x,ocanvas.height)
  octx.clearRect(x+w,0,ocanvas.width,ocanvas.height)
  ctx.translate(0, canvas.height)
  ctx.scale(1,-1)
  ctx.clearRect(x,0,w,canvas.height)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.globalAlpha = a
}

function flipStripH () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let h = 40 + Math.random() * canvas.height/2
  let y = (canvas.height) * Math.random()
  octx.clearRect(0,0,canvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  octx.clearRect(0,0,canvas.width,y)
  octx.clearRect(0,y+h,ocanvas.width,ocanvas.height)
  ctx.translate(canvas.width, 0)
  ctx.scale(-1,1)
  ctx.clearRect(0,y,canvas.width, h)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
  ctx.globalAlpha = a
}

function pixelado () {
  slices()
  rc()
  slices()
  rcc()
}

function shred () {
  blasco()
  rc()
  blasco()
  rcc()/*
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  octx.drawImage(canvas, 0, 0)
  ctx.drawImage(ocanvas, 0, h)
  ctx.drawImage(ocanvas, h, h)
  ctx.drawImage(ocanvas, h, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
 // ctx.setTransform(1,0,0,1,0,0)
  ctx.globalAlpha = a*/
}

function slices () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  let count = ch/h - 1
  let y = 0, i = 0
  for (;i < count; i++) {
    sliceH(y, h, ctx, octx, canvas, ocanvas)
    y += h
  }
  ctx.globalAlpha = a
}

function sliceH (y, h, ctx, octx, canvas, ocanvas) {
  octx.clearRect(0,0,canvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  octx.clearRect(0,0,canvas.width,y)
  octx.clearRect(0,y+h,ocanvas.width,ocanvas.height)
  ctx.translate(0,2*y+h)
  ctx.scale(1,-1)
  ctx.clearRect(0,y,canvas.width, h)
  ctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  ctx.setTransform(1,0,0,1,0,0)
}

function pasta () {
  pastaSlice()
  rc()
  pastaSlice()
  rcc()
}

function closediv (N, d) {
  if (N % d === 0)
    return d
  let i = 0
  let results = []
  for (; i < N; i++) {
    if (N % i == 0)
      results.push(i)
  }
  let min = N
  i = 0
  for (; i < results.length; i++) {
    if (results[i] - d >= 0)
      return results[i]
  }
  return d
}

function pastaSlice () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  canvas.width *= 2
  canvas.height /= 2
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  //h = closediv(canvas.height, h)
  let count = ch/h*2
  let y = 0, yon =0, i = 0
  for (;i < count; i++) {
    ctx.drawImage(ocanvas, 0, y, ocanvas.width, h, 0, yon, canvas.width/2, h);
    ctx.drawImage(ocanvas, 0, y+h, ocanvas.width, h, canvas.width/2, yon, canvas.width/2, h);
    y += h*2
    yon += h
  }
  ctx.globalAlpha = a
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}
 
function reverse () { // rotate canvas at touch x,y. concentric circles
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  let h = 2 + Math.floor(document.getElementById("speck_size").value/10)
  let n = canvas.width/h/2
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  octx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let cx = canvas.width/2
  let cy = canvas.height/2
  let x = 0, y = 0
  let x2 = canvas.width, y2 = canvas.height
  let i = 0
  let angle = Math.PI
  if (grunge)
    angle /= 2
  octx.drawImage(ocanvas, 0,0)

  for (; i < n; i++) {
    ctx.save()
    ctx.beginPath()
    ctx.moveTo(x,y)
    ctx.lineTo(x2,y)
    ctx.lineTo(x2,y2)
    ctx.lineTo(x,y2)
    ctx.closePath()
    ctx.clip()
    octx.translate(cx, cy)
    octx.rotate(angle);
    octx.translate(-cx,-cy)
    octx.drawImage(canvas, 0, 0)
    ctx.drawImage(ocanvas, 0,0)
    ctx.restore()
    x += h
    y += h
    x2 -= h
    y2 -= h
  }
  ctx.globalAlpha = a
  octx = ocanvas.getContext('2d')
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function rotateCent () { // rotate canvas at touch x,y. concentric circles
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  let radius = 4 + Math.floor(document.getElementById("speck_size").value/2)
  let r0 = radius
  let n = canvas.width/radius
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  octx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let x = canvas.width/2
  let y = canvas.height/2
  x = LASTCLICK[0]
  y = LASTCLICK[1]
  let i = 0
  let angle = -Math.PI/n
  for (; i < n/2; i++) {
    octx.translate(x, y)
    octx.rotate(angle);
    octx.translate(-x,-y)
    ctx.save()
    octx.drawImage(canvas, 0, 0)
    ctx.beginPath()
    ctx.arc(x, y, radius, 0, 2*Math.PI)
    ctx.closePath()
    ctx.clip()
    ctx.drawImage(ocanvas, 0,0)
    octx.translate(x,y)
    octx.rotate(-angle);
    octx.translate(-x,-y)
    ctx.restore()
    radius += r0
  }
  ctx.globalAlpha = a
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function rotateCirc () { // grip of rotated circles
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  let n = 2 + Math.floor(document.getElementById("speck_size").value/20)
  // 27 ... 2 => 2 ... 27
  // max+min - n
  n = (27 + 2) - n
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  let h = canvas.height/n
  let w = canvas.width/n
  let x = w/2
  let y = h/2
  let i = 0
  for (; i < n*n; i++) {
    if (i > 0 && i % (n) == 0) {
      x = w/2
      y += h
    }
    let angle = (Math.PI * (Math.random() - 0.5) * Math.PI/2)
    let radius = canvas.width/(n+1)/2
    if (grunge) {
      radius += pet(radius/2)
      x += pet(radius/2)
      y += pet(radius/2)
    }
    octx.translate(x, y)
    octx.rotate(angle);
    octx.translate(-x,-y)
    ctx.save()
    octx.drawImage(canvas, 0, 0)
    ctx.beginPath()
    ctx.arc(x, y, radius, 0, 2*Math.PI)
    ctx.closePath()
    ctx.clip()
    ctx.drawImage(ocanvas, 0,0)
    octx.translate(x,y)
    octx.rotate(-angle);
    octx.translate(-x,-y)
    ctx.restore()
    x += w
  }
  ctx.globalAlpha = a
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function dots () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  ctx.fillStyle = document.getElementById("paintcolor").value
  let ch = canvas.height
  let h = 2 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h
  let off = h/2
  let r = w/2
  let t = 0
  if (grunge) {
    t = 2
    r *= 0.7
  }
  let count = (canvas.height/h + 2) * (canvas.width/w + 2)
  let newline = Math.floor(canvas.width/w)+2
  let counter = 0
  let x = 0, y = 0
  let i = 0
  for (;i < count; i++) {
    ctx.beginPath()
    ctx.arc(x+w/2+pet(t),y+h/2+pet(t),r+pet(w/5),0,Math.PI*2)
    ctx.closePath()
    ctx.fill()
    x += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = -w/2
      y += h
      off *= -1
      x += off/2
    }
  }
}

function diamonds () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h
  let off = 0

  let count = 4*(1+canvas.height/h) * (1+canvas.width/w)
  let newline = 2*Math.floor(canvas.width/w) + 1
  let counter = 0
  let x = 0, y = 0
  let i = 0
  ctx.save()
  ctx.beginPath()
  for (;i < count; i++) {
    ctx.moveTo(x+w/4,y)
    ctx.lineTo(x+w/2, y+h/4)
    ctx.lineTo(x+w/4, y+h/2)
    ctx.lineTo(x, y+h/4)
    x += w/2
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = 0
      y += h/2
    }
  }
  ctx.closePath()
  ctx.clip()
  ctx.clearRect(0,0,canvas.width, canvas.height)
  ctx.restore()
}

function checkerboard () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h
  let off = -1
  let count = 2*(1+canvas.height/h) * (1+canvas.width/w)
  let newline = Math.floor(canvas.width/w) + 1
  let counter = 0
  let x = 0, y = 0
  let i = 0
  ctx.save()
  ctx.beginPath()
  for (;i < count; i++) {
    ctx.moveTo(x,y)
    ctx.lineTo(x+w/2, y)
    ctx.lineTo(x+w/2, y+h/2)
    ctx.lineTo(x, y+h/2)
    x += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      if (off < 0)
        x = w/2
      else
        x = 0
      y += h/2
      off *= -1
    }
  }
  ctx.closePath()
  ctx.clip()
  ctx.clearRect(0,0,canvas.width, canvas.height)
  ctx.restore()
}

function dashes (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h/4
  let off = h/4
  let r = w/2
  let t = r
  if (grunge) {
    t = r*2
    r *= 1.4
  }
  ctx.lineCap = "round"
  ctx.lineWidth = r
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let count = canvas.height/h * canvas.width/w * 4.3
  let newline = Math.floor(canvas.width/w) + 2
  let counter = 0
  let x = 0, y = 0
  let i = 0
  for (;i < count; i++) {
    ctx.save()
    ctx.beginPath()
    ctx.moveTo(x+pet(t), y+pet(t))
    ctx.lineTo(x+w/2+pet(t),y+pet(t))
    ctx.stroke()
    x += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = 0
      y += h/4
    }
  }
}
  
function holes2 (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height
  let h = 2 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h
  let off = h/2
  let r = w/2
  let t = r
  if (grunge) {
    t = r*2
    r *= 1.4
  }
  let count = canvas.height/h * canvas.width/w
  let newline = Math.floor(canvas.width/w)
  let counter = 0
  let x = w, y = h/2
  let xo = 0, yo = 0, i = 0
  for (;i < count; i++) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(x+w/2+pet(t),y+h/2+pet(t),r+pet(w/5),0,Math.PI*2)
    ctx.closePath()
    ctx.clip()
    ctx.clearRect(0,0,canvas.width, canvas.height)
    ctx.restore()
    x += w*1.8
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = w
      xo = 0
      y += 1.5*h
      yo += h
      off *= -1
      x =+ off
    }
  }
}

function holes () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let ch = canvas.height
  let h = 2 + Math.floor(document.getElementById("speck_size").value/4)
  let w = h
  let off = h/2
  let r = w/2
  let t = 0
  if (grunge) {
    t = r
    r *= 1.4
  }
  let count = canvas.height/h * canvas.width/w
  let newline = Math.floor(canvas.width/w)
  let counter = 0
  let x = w, y = h/2
  let xo = 0, yo = 0, i = 0
  for (;i < count; i++) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(x+w/2+pet(t),y+h/2+pet(t),r+pet(w/5),0,Math.PI*2)
    ctx.closePath()
    ctx.clip()
    ctx.clearRect(0,0,canvas.width, canvas.height)
    ctx.restore()
    x += w*2
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = w
      xo = 0
      y += 2*h
      yo += h
      off *= -1
      x =+ off
    }
  }
}

function samplec () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  ctx.clearRect(0,0,ocanvas.width,canvas.height)
  canvas.width /= 2
  canvas.height /= 2
  syncBackground(canvas)
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  let w = h
  let count = canvas.height/h * canvas.width/w
  let newline = Math.floor(canvas.width/w)
  let counter = 0
  let x = w, y = h
  let xo = 0, yo = 0, i = 0
  for (;i < count; i++) {
    ctx.save()
    ctx.beginPath()
    ctx.arc(xo+w/2,yo+h/2,w/2,0,Math.PI*2)
    ctx.closePath()
    ctx.clip()
    //if (i % 4 == 0)
    //  ctx.clearRect(0,0,canvas.width, canvas.height)
    //if (i % 4 == 0)
    ctx.drawImage(ocanvas, x, y, w, h, xo, yo, w, h);
    ctx.restore()
    x += w*2
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = w
      xo = 0
      y += 2*h
      yo += h
    }
  }
  ctx.globalAlpha = a
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function sample () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let a = ctx.globalAlpha
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  ctx.clearRect(0,0,ocanvas.width,canvas.height)
  canvas.width /= 2
  canvas.height /= 2
  syncBackground(canvas)
  let ch = canvas.height
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  let w = h
  let count = canvas.height/h * canvas.width/w
  let newline = Math.floor(canvas.width/w)
  let counter = 0
  let x = w, y = h
  let xo = 0, yo = 0, i = 0
  for (;i < count; i++) {
    ctx.drawImage(ocanvas, x, y,  w, h, xo, yo, w, h);
    x += w*2
    xo += w
    counter++
    if (i > 0 && newline == counter) {
      counter = 0
      x = w
      xo = 0
      y += 2*h
      yo += h
    }
  }
  ctx.globalAlpha = a
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function zoom () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  
  canvas.width *= 1.2
  canvas.height *= 1.2
  
  syncBackground(canvas)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
 // LASTCLICK[0] = myCanvas.width/2
 // LASTCLICK[1] = myCanvas.height/2
  ctx.globalCompositeOperation = mode
  syncMarker()
}

function zoom_neg () {
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  octx.drawImage(canvas, 0, 0)
  
  canvas.width /= 1.2
  canvas.height /= 1.2
 
  syncBackground(canvas)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
 // LASTCLICK[0] = myCanvas.width/2
//  LASTCLICK[1] = myCanvas.height/2
  ctx.globalCompositeOperation = mode
  syncMarker()
}

function blasco () {
  let h = 4 + Math.floor(document.getElementById("speck_size").value/2)
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let temp = document.createElement("CANVAS")
  let tempctx = temp.getContext("2d")
  let a = ctx.globalAlpha
  let grunge = document.getElementById("grungy").checked
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  temp.height = canvas.height * 2 + h*2
  temp.width = canvas.width
  let ch = canvas.height
  let count = ch/h - 1
  let y = 0, i = 0
  for (;i < count; i++) {
    if (grunge) {
      if (i % 2 == 0) {
        sliceHC(y, h, ctx, octx, canvas, ocanvas, temp, tempctx, grunge)
        y += h
      } else
        y += h
    } else {
      sliceHC(y, h, ctx, octx, canvas, ocanvas, temp, tempctx, grunge)
        y += h
    }
  }
  
  if (grunge) {
    canvas.height *= 1
    canvas.height += 2*h
  } else {
    canvas.height *= 2
    canvas.height += 2*h
  }
  syncBackground(canvas)
  ctx.drawImage(temp, 0, 0)
  ctx.globalAlpha = a
  ctx.setTransform(1,0,0,1,0,0)
  syncMarker()
}

function sliceHC (y, h, ctx, octx, canvas, ocanvas, t, tctx, g) {
  octx.clearRect(0,0,canvas.width,ocanvas.height)
  octx.drawImage(canvas, 0, 0)
  octx.clearRect(0,0,canvas.width,y)
  octx.clearRect(0,y+h,ocanvas.width,ocanvas.height)
  if (g)
    tctx.translate(0,h)
  else
    tctx.translate(0,y+h)
  tctx.clearRect(0,y,canvas.width, h)
  tctx.drawImage(ocanvas, 0, 0)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  tctx.setTransform(1,0,0,1,0,0)
}

function randomGradientRect(canvas, col1, x1, y1, x2, y2) {
  let centx = Math.random() * canvas.width;
  let centy = Math.random() * canvas.height;
  let radius = canvas.width/2;
  let angle = Math.random()*6.27;
  let p = (x1-x2)
  let my_gradient = canvas.getContext('2d').createLinearGradient(x1-pet(p), y1-pet(p), x2+pet(p), y2+pet(p));
  let col2 = "rgba("+hexToR(col1)+", "+hexToG(col1)+", "+hexToB(col1)+", 0.0)";// transparent
  my_gradient.addColorStop(0,col1);
  my_gradient.addColorStop(1,col2);
  return my_gradient;
}

function petColor (c, p) {
  let r = hexToR(c) + Math.floor(pet(p))
  let g = hexToG(c) + Math.floor(pet(p))
  let b = hexToB(c) + Math.floor(pet(p))
  if (r > 255 || r < 0)
    r =  hexToR(c)
  if (g > 255 || g < 0)
    g =  hexToG(c)
  if (b > 255 || b < 0)
    b =  hexToB(c)
  let R = ('0'+(Math.round(r)).toString(16)).slice(-2),
      G = ('0'+(Math.round(g)).toString(16)).slice(-2),
      B = ('0'+(Math.round(b)).toString(16)).slice(-2);
  return "#"+R+G+B
}

function randomGradient(canvas, col1) {
  let x1 = 0, y1 = 0, x2 = 0, y2 = 0;
  let centx = Math.random() * canvas.width;
  let centy = Math.random() * canvas.height;
  let radius = canvas.width/2;
  let angle = Math.random()*6.27;
  x1 = radius * Math.cos(angle)+centx;
  y1 = radius * Math.sin(angle)+centy;
  x2 = radius * Math.cos(angle+3.14)+centx;
  y2 = radius * Math.sin(angle+3.14)+centy;
  let my_gradient = canvas.getContext('2d').createLinearGradient(x1, y1, x2, y2);
  if (col1 === undefined)
    col1 = randomColor();

  let col2 = "rgba("+hexToR(col1)+", "+hexToG(col1)+", "+hexToB(col1)+", 0.0)";// transparent
  my_gradient.addColorStop(0,col1);
  my_gradient.addColorStop(1,col2);
  return my_gradient;
}

function randomGradientLeft(canvas, col1) {
  let x1 = 0, y1 = 0, x2 = 0, y2 = 0;
  let centx = -1//Math.random() * canvas.width;
  let centy = Math.random() * canvas.height;
  let radius = canvas.width/2;
  let angle = Math.random()*6.27;
  x1 = radius * Math.cos(angle)+centx;
  y1 = 0//radius * Math.sin(angle)+centy;
  x2 = radius * Math.cos(angle+3.14)+centx;
  y2 = 0//radius * Math.sin(angle+3.14)+centy;
  
  console.log(x1,x2)
  let my_gradient = canvas.getContext('2d').createLinearGradient(x1, y1, x2, y2);
  if (col1 === undefined)
    col1 = randomColor();

  let col2 = "rgba("+hexToR(col1)+", "+hexToG(col1)+", "+hexToB(col1)+", 0.0)";// transparent
  my_gradient.addColorStop(0,col1);
  my_gradient.addColorStop(1,col2);
  return my_gradient;
}

function hexToR(h) { return parseInt((cutHex(h)).substring(0,2),16) }
function hexToG(h) { return parseInt((cutHex(h)).substring(2,4),16) }
function hexToB(h) { return parseInt((cutHex(h)).substring(4,6),16) }
function cutHex(h) { return (h.charAt(0)=="#") ? h.substring(1,7) : h}

function hrips () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let centerx = canvas.width / 2;
  let centery = canvas.height / 2;
  let thickness = document.getElementById("speck_size").value
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  //ctx.save()
  clip()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let yincrement = 4;
  let numshapes = 1
  for (let t = 0; t < numshapes; t++) {
    let points = [];
    let width = 1 + Math.random()*3;
    ctx.lineWidth = 3+Math.random()*11;
    let x = -20;
    let y = Math.random() * canvas.height * 1.5
    y //+= thickness
    let x0 = x;
    let y0 = y;
    ctx.beginPath();
    ctx.moveTo(x, y);
    points.push([x,y]);
    let direction = 0.8;
    if (y < centery)
      direction = -0.8;
    let yincrement = 1 + Math.random() * 3;
    let jump = 3 + Math.random() * 4;
    while (x < canvas.width+20) {
      y += (Math.random()-0.5) * yincrement;
      x += 1 + 3 * Math.random();
      if (Math.random() < 0.1)
        x += 3 + Math.random() * 7;
      if (Math.random() < 0.5)
        y -= jump * (Math.random()*direction);
      ctx.lineTo(x+Math.random()*4,y+(1+width + Math.random() * 5));
      points.push([x,y]);
      if (Math.random() < 0.05) {
        direction *= -1;
      }
    }
    y -= thickness
    while (x > -20) {
      y -= (Math.random()-0.5) * yincrement;
      x -= 1 + 3 * Math.random();
      if (Math.random() < 0.040)
        x -= 7 + Math.random() * 7;
      if (Math.random() < 0.5)
        y += jump * (Math.random()*direction);
      ctx.lineTo(x+Math.random()*4,y+(1+width + Math.random() * 5));
      points.push([x,y]);
      if (Math.random() < 0.1) {
        direction *= -1;
      }
    }
    ctx.fillStyle = document.getElementById("paintcolor").value
    if (document.getElementById("grungy").checked)
      ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.closePath();
    ctx.fill();
  }
  ctx.restore()
}

function smudgearcs2 () {
  smudge ('arcs2')
}

function smudgearcs () {
  smudge ('arcs')
}

function smudgestars () {
  smudge ('stars')
}

function smudgestreaks () {
  smudge ('streaks')
}
function smudgestreaks2 () {
  smudge ('streaks2')
}

function smudgewatercolor () {
  smudge ('watercolor')
}

function smudgehorizontal () {
  smudge ('horizontal')
}

function smudgehorizontal2 () {
  smudge ('horizontal2')
}

function smudge (type) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let H = canvas.height
  let xoff = -W, yoff = -W
  let len = W/2, maxy = W/2
  let off = document.getElementById("offscreen");
  let ctoff = off.getContext("2d");
  let canvasoff = document.getElementById("offscreen");
  let ctxoff = canvasoff.getContext("2d");
  let n = 0, x = 0, y = 0
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100 //* 0.75
  let smudge_size = 2 + Math.random()*13
  let dx = pet(smudge_size*3), dy = pet(smudge_size*3)
  let smudge_ct = 1 + document.getElementById("number").value/150
  let area = canvas.width * canvas.height
  let shapemultiplier = area/(1024*1024)
  smudge_ct *= shapemultiplier
  if (type == "watercolor")
    smudge_ct /= 4
  //clip()
  for (; n < smudge_ct; n++) {
    if (type === "streaks")
      offstreaks()
    else
    if (type === "streaks2")
      offmix()
    else
    if (type === "horizontal")
      offhorizontal()
    else
    if (type === "horizontal2")
      offhorizontal2()
    else
    if (type === "arcs")
      offarcs()
    else
    if (type === "arcs2")
      offarcs2()
    else
    if (type === "stars")
      offstars()
    else
    if (type === "watercolor")
      offwatercolor()
    else
      offspecks()
    x = Math.random()*canvas.width
    y = Math.random()*canvas.height
    dx = pet(13), dy = pet(13)
    let i = 0
    let moves = smudge_size
    if (type == "arcs2")
      moves = 1
    for (; i < moves; i++) {
      ctx.drawImage(canvasoff, x,   y)
      ctx.drawImage(canvasoff, x-W, y-H)
      ctx.drawImage(canvasoff, x,   y-H)
      ctx.drawImage(canvasoff, x+W, y-H)
      ctx.drawImage(canvasoff, x-W, y+H)
      ctx.drawImage(canvasoff, x,   y+H)
      ctx.drawImage(canvasoff, x+W, y+H)
      ctx.drawImage(canvasoff, x-W, y)
      ctx.drawImage(canvasoff, x+W, y)
      x += dx + pet(23)
      y += dy + pet(23)
    }
  }
  ctxoff.clearRect(0,0,canvasoff.width, canvasoff.height)
 // ctx.restore()
}

function fog () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let W = canvas.width
  let H = canvas.height
  let xoff = -W, yoff = -H
  let len = W/2, maxy = W/2
  let canvasoff = document.getElementById("offscreen");
  let ctxoff = canvasoff.getContext("2d");
  let n = 0, x = 0, y = 0
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100 //* 0.75
  let smudge_size = 51 + Math.random()* 100
  let colors = []
  let grunge = document.getElementById("grungy").checked
  if (grunge)
    colors.push(randomColor())
  else
    colors.push(document.getElementById("paintcolor").value)
  //clip()
  let smudge_ct = 1 + document.getElementById("number").value/100
  let area = canvas.width * canvas.height
  let shapemultiplier = area/(1024*1024)
  smudge_ct *= shapemultiplier
  ctxoff.save()
  for (; n < smudge_ct; n++) {
    x = Math.random() * (W + 40) - 256
    y = Math.random() * (H + 40) - 256
    offbrush(colors)
    let i = 0
    let moves = 15//smudge_size * 8
    for (; i < moves; i++) {
      ctx.drawImage(canvasoff, x += pet(41), y += pet(41))
    }
  }
  ctxoff.restore()
  ctxoff.clearRect(0,0,canvasoff.width, canvasoff.height)
  ctx.restore()
}

function offwatercolor (colors) {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
  ctx.globalAlpha = 0.02
  let maxradius = 20 + document.getElementById("speck_size").value/4
  let d = 14 + Math.random() * maxradius
  d *= 5
  let count = 10
  ctx.fillStyle = document.getElementById("paintcolor").value
  for (let j = 0; j < count; j++) {
    ctx.beginPath();
    x = cx + pet(d)
    y = cy + pet(d)
    ctx.arc(x, y, 5+Math.random()*maxradius, 0, 2*Math.PI);
    ctx.fill();
  }
  let size = document.getElementById("speck_size").value
  document.getElementById("speck_size").value = 30
  dirblur(canvas)
  document.getElementById("speck_size").value = size
  smearrandom(canvas)
}

function offbrush (colors) {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height)
  ctx.globalAlpha = 0.01
  let maxradius = 1 + document.getElementById("speck_size").value/3
  let d = 41 + Math.random() * maxradius
  d *= 5
  let count = 9
  ctx.fillStyle = colors[Math.floor(Math.random() * colors.length)]
  for (let j = 0; j < count; j++) {
    ctx.beginPath();
    x = cx + pet(d)*Math.cos(Math.random()*6.28)
    y = cy + pet(d)*Math.sin(Math.random()*6.28)
    ctx.arc(x, y, Math.random()*maxradius, 0, 2*Math.PI);
    ctx.fill();
  }
}

function offstars () {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let csize = ctx.canvas.height
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.1
  let maxWidth = 0.15 + document.getElementById("speck_size").value/500
  ctx.strokeStyle = document.getElementById("paintcolor").value
  if (document.getElementById("grungy").checked)
    maxWidth *= 2
  ctx.globalAlpha = 0.1
  let s = 0
  let count = 7
  for (; s < count; s++) {
    x = Math.random() * canvas.width;
    y = Math.random() * canvas.height;
    let spokes = 7 + Math.random() * 9
    let spokelength = 20 + 51 * Math.random()
    for (let i = 0; i < spokes; i++) {
      ctx.lineWidth = maxWidth * Math.random()
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x+Math.cos(Math.random()*6.28)*pet(spokelength), y+Math.sin(Math.random()*6.28)*pet(spokelength));
      ctx.stroke()
    }
  }
}

function offmix () {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let csize = ctx.canvas.height
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.1
  let maxWidth = 0.15 + document.getElementById("speck_size").value/300
  ctx.strokeStyle = document.getElementById("paintcolor").value
  if (document.getElementById("grungy").checked)
    maxWidth *= 2
  ctx.globalAlpha = 0.1
  let s = 0
  let count = 7
  let maxradius = 1 + document.getElementById("speck_size").value/150
  for (; s < count; s++) {
    let spokes = 27 + Math.random() * 9
    let spokelength = 20 + 51 * Math.random()
    for (let i = 0; i < spokes; i++) {
      x = Math.random() * canvas.width;
      y = Math.random() * canvas.height;
      ctx.lineWidth = maxWidth * Math.random()
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x+Math.cos(Math.random()*6.28)*pet(spokelength), y+Math.sin(Math.random()*6.28)*pet(spokelength));
      ctx.stroke()
    }
  }
}

function offhorizontal () {
  let  canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let csize = ctx.canvas.height
  let x = 0, y = 0
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.globalAlpha = 0.1
  let maxWidth = 0.15 + document.getElementById("speck_size").value/500
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  if (grunge)
    maxWidth *= 2
  ctx.lineWidth = 0.1
  let count = 21
  let ybump = 0
  for (let j = 0; j < count; j++) {
    ctx.lineWidth = maxWidth * Math.random()
    ctx.beginPath()
    y = Math.random() * csize
    ctx.moveTo(Math.random() * cx, y)
    ybump = pet(43)
    ctx.lineTo(cx + Math.random() * cx/3, y + ybump)
    ctx.stroke()
  }
}

function offhorizontal2 () {
  let  canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let csize = ctx.canvas.height
  let x = 0, y = 0
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.globalAlpha = 0.1
  let maxWidth = 0.35 + document.getElementById("speck_size").value/500
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let grunge = document.getElementById("grungy").checked
  if (grunge)
    maxWidth *= 2
  ctx.lineWidth = 0.1
  let count = 21
  let ybump = 0
  for (let j = 0; j < count; j++) {
    ctx.lineWidth = maxWidth * Math.random()
    ctx.beginPath()
    y = Math.random() * csize
    ctx.moveTo(Math.random() * cx, y)
    ybump = pet(13)
    ctx.lineTo(cx + Math.random() * cx/3, y + ybump)
    ctx.stroke()
  }
}

function offstreaks () {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let csize = ctx.canvas.height
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.1
  let maxWidth = 0.15 + document.getElementById("speck_size").value /500
  if (document.getElementById("grungy").checked)
    maxWidth *= 2
  ctx.strokeStyle = document.getElementById("paintcolor").value
  //ctx.lineWidth = 0.1
  let count = 7
  for (let j = 0; j < count; j++) {
    ctx.lineWidth = maxWidth * Math.random()
    ctx.beginPath()
    ctx.moveTo(Math.random() * cx, Math.random() * csize)
    ctx.lineTo(cx + Math.random() * cx, Math.random() * csize)
    ctx.stroke()
  }
}

function offarcs2 () {
  let  canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  let s = 0, e = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.25
  let maxWidth = 3 + document.getElementById("speck_size").value/500
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let maxradius = 57 + document.getElementById("speck_size").value /2
  if (document.getElementById("grungy").checked)
    maxradius *= 2
  let d = 40 + Math.random() * 39
  let count = 13
  for (let j = 0; j < count; j++) {
    ctx.beginPath();
    ctx.lineWidth = maxWidth * Math.random()
    x = cx + pet(d)*Math.cos(Math.random()*0.5)
    y = cy + pet(d)*Math.sin(Math.random()*0.5)
    e = Math.random()*6.28
    s = e+Math.random()*1.5
    ctx.arc(x, y, Math.random()*maxradius, e, s);
    ctx.stroke();
  }
}

function offarcs () {
  let  canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  let s = 0, e = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.15
  let maxWidth = 0.15 + document.getElementById("speck_size").value /500
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = 0.1
  let maxradius = 17 + document.getElementById("speck_size").value /2
  if (document.getElementById("grungy").checked)
    maxradius *= 2
  let d = 40 + Math.random() * 39
  let count = 53
  for (let j = 0; j < count; j++) {
    ctx.beginPath();
    ctx.lineWidth = maxWidth * Math.random()
    x = cx + pet(d)*Math.cos(Math.random()*0.5)
    y = cy + pet(d)*Math.sin(Math.random()*0.5)
    e = Math.random()*6.28
    s = e+Math.random()*1.5
    ctx.arc(x, y, Math.random()*maxradius, e, s);
    ctx.stroke();
  }
}

function offspecks2 () {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.075
  let maxradius = 1 + document.getElementById("speck_size").value /20
  
  let d = 1 + Math.random() * 41
  let count = 7
  for (let j = 0; j < 7; j++) {
    ctx.beginPath();
    x = cx + pet(d)*Math.cos(Math.random()*6.28)
    y = cy +pet(d)*Math.sin(Math.random()*6.28)
    ctx.arc(x, y, Math.random()*maxradius, 0, 2*Math.PI);
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
    ctx.fill();
  }
}

function offspecks () {
  let canvas = document.getElementById("offscreen");
  let ctx = canvas.getContext("2d");
  let cx = ctx.canvas.width/2;
  let cy = ctx.canvas.height/2;
  let x = 0, y = 0
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height)
  ctx.globalAlpha = 0.0025
  let maxradius = 2 + document.getElementById("speck_size").value /10
  ctx.fillStyle = document.getElementById("paintcolor").value
  let d = 51 + Math.random() * 41
  let count = 5
  for (let j = 0; j < 17; j++) {
    ctx.beginPath();
    x = cx + pet(d)*Math.cos(Math.random()*6.28)
    y = cy +pet(d)*Math.sin(Math.random()*6.28)
    ctx.arc(x, y, Math.random()*maxradius, 0, 2*Math.PI);
    ctx.fill();
  }
}

function specksRadial () {
  let canvas = document.getElementById("myCanvas");
  let dist = "rect"//document.getElementById("distro").value
  let cx = canvas.width/2, cy = canvas.height/2
  let ctx = canvas.getContext("2d");
  let grunge = document.getElementById("grungy").checked
  let num = document.getElementById("number").value
  let area = canvas.width * canvas.height
  let shapemultiplier = area/(1024*1024)
  num *= shapemultiplier
  let speck_size = 0.2+ document.getElementById("speck_size").value/200
  let r0 = speck_size
  let speck_opacity = document.getElementById("speck_opacity").value/100
  let flatness = false//document.getElementById("flatten").value
  let canvas_w = canvas.width
  let canvas_h = canvas.height
  let x = 0, y = 0
  let f = flatness/100 * canvas.height/2
  ctx.globalAlpha = speck_opacity
  let alpha0 = ctx.globalAlpha
 // let maxY = canvas.height/2
  ctx.fillStyle = document.getElementById("paintcolor").value
  if (dist != "gaussian")
    clip()
  for (let j = 0; j < num; j++) {
    ctx.beginPath();
    if (dist == "gaussian") {
      x = randn_bm(0, canvas_w, 1)
      y = randn_bm(0, canvas_h, 1)
      if (flatness > 1) {
        x = randn_bm(f, canvas_size - f, 1)
      }
    } else {
      x = Math.random() * canvas_w
      y = Math.random() * canvas_h
    }
    ctx.arc(x, y, speck_size, 0, 2*Math.PI);
    ctx.closePath();
    if (grunge) {
      speck_size = r0 + Math.random() * r0 * 3
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0
    }
    ctx.fill()
  }
  ctx.restore()
}

function hatches (cross) {
  let grunge = document.getElementById("grungy").checked
  //clearCanvas()
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  let x = -50, y = -50;
  let x_inc = 20, y_inc = 20
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  alpha0 = ctx.globalAlpha
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = document.getElementById("speck_size").value/(5*6.25)
  linewidth0 = ctx.lineWidth
  let radius = document.getElementById("speck_size").value/(2*6.25)
  let rows = document.getElementById("rows").value*8
  let inc = 512/rows
  numlines = 0;
  x = inc, y = inc // should try different initial offset
  x_inc = inc, y_inc = inc
  //ctx.save()
  clip()
  for (var i = 0; i < 1000; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.0
      ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
    }
    ctx.beginPath();
    ctx.moveTo(-20, y)
    ctx.lineTo(x, -20)
    ctx.stroke();
    x += x_inc
    y += y_inc
  }
  if (cross) {
    i = 0, x = -50, y = canvas.height + 50
    for (var i = 0; i < 1000; i++) {
      if (grunge) {
        ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.0
        ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
      }
      ctx.beginPath();
      ctx.moveTo(-20, y)
      ctx.lineTo(x, canvas.height+20)
      ctx.stroke();
      x += x_inc
      y -= y_inc
    }
  }
  ctx.restore()
}

function caption () {
  let grunge = document.getElementById("grungy").checked
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  let cx = canvas.width/2, cy = canvas.height/2
  let styles = ["normal", "100", "500", "900", "bold", "italic", "lighter", "oblique"]
  let faces = ["monospace"]//, "sans-serif", "serif", "courier", "ariel", "times"]
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let text = document.getElementById("caption").value
  let size = document.getElementById("speck_size").value/6.25
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.font = size+"px sans-serif"
  ctx.font = randomPick(styles)+" "+size+"pt " + randomPick(faces)
  let x = 40, y = canvas.height - 40
  ctx.fillText(text, x, y)
}

function character () {
  let grunge = document.getElementById("grungy").checked
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100

  let styles = ["normal", "100", "500", "900", "bold", "italic", "lighter", "oblique"]
  let faces = ["monospaced", "sans-serif", "serif", "courier", "ariel", "times"]

  let x = -32, y = -32, x0 = x, y0 = y, off = 0;
  let numlines = 0;
  let x_inc = 16, y_inc = 16
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let alpha0 = ctx.globalAlpha
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.strokeStyle = document.getElementById("paintcolor").value
  let text = document.getElementById("atext").value
  let radius = document.getElementById("speck_size").value/6.25
  let rad0 = radius
  let rows = Math.pow(2, 9-document.getElementById("rows").value)
  let inc = rows
  let maxy = canvas.height/2
  numlines = 0;
  x_inc = inc, y_inc = inc
  clip()
  ctx.font = radius+"px sans-serif"
  ctx.font = randomPick(styles)+" "+radius+"pt " + randomPick(faces)
  for (var i = 0; i < 24000; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0
      radius = rad0 + Math.random() * rad0/3
      ctx.font = radius+"px"
      text = String.fromCharCode(32 + Math.floor(Math.random() * 96)) // 32 - 127 = ascii
    }
    if (grunge && Math.random() < 0.1)
      ctx.strokeText(text, x, y)
    else
      ctx.fillText(text, x, y)
    x += x_inc;
    if (i % (160) === 0) {
      numlines++;
      if (numlines % 2 === 0)
        off = x_inc/2;
      else
        off = 0;
      x = off - (radius/2);
      y += inc;
    }
  }
  ctx.restore()
}

function halftone () {
  let grunge = document.getElementById("grungy").checked
  //clearCanvas()
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  let x = -32, y = -32, x0 = x, y0 = y, off = 0;
  let numlines = 0;
  let x_inc = 16, y_inc = 16
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let alpha0 = ctx.globalAlpha
  ctx.fillStyle = document.getElementById("paintcolor").value
  let radius = 0.2+document.getElementById("speck_size").value/62.5
  let rad0 = radius
  let rows = Math.pow(2, 9-document.getElementById("rows").value)
  let inc = rows
  let maxy = canvas.height/2
  numlines = 0;
  x_inc = inc, y_inc = inc
  clip()
  for (var i = 0; i < 24000; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0
      radius = rad0 + Math.random() * rad0/3
    }
    ctx.beginPath();
    ctx.arc(x, y, radius, 0, 2*Math.PI);
    ctx.closePath();
    ctx.fill();
    x += x_inc;
    if (i % (160) === 0) {
      numlines++;
      if (numlines % 2 === 0)
        off = x_inc/2;
      else
        off = 0;
      x = off;
      y += inc;
    }
  }
  ctx.restore()
}

function straightLines (cross) { // vertical lines
  let grunge = document.getElementById("grungy").checked
 // clearCanvas()
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  let x = -50, y = -50;
  let x_inc = 20, y_inc = 20
  ctx.globalAlpha = (document.getElementById("speck_opacity").value) /100
  alpha0 = ctx.globalAlpha
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = document.getElementById("speck_size").value/(5*6.25)
  linewidth0 = ctx.lineWidth
  let radius = document.getElementById("speck_size").value/12.5
  let rows = document.getElementById("rows").value*8
  let inc = 512/rows
  numlines = 0;
  x = -20, y = 0 + ctx.lineWidth/2 // should try different initial offset
  x_inc = inc, y_inc = inc
  let maxy = canvas.height/2
  clip()
  let i = 0
  for (; i < 1000; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.3
      ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
    }
    ctx.beginPath();
    ctx.moveTo(-20, y)
    ctx.lineTo(canvas.width+20, y)
    ctx.stroke();
    y += y_inc
  }
  if (cross) {
    i = 0, x = -20, y = -20
    for (; i < 1000; i++) {
      if (grunge) {
        ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.3
        ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
      }
      ctx.beginPath();
      ctx.moveTo(x, y)
      ctx.lineTo(x, canvas.height+20)
      ctx.stroke();
      x += x_inc
      y = -20
    }
  }
  ctx.restore()
}

function skinnyLines () { // vertical lines
  let grunge = document.getElementById("grungy").checked
 // clearCanvas()
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext('2d');
  let x = -50, y = -50;
  let x_inc = 20, y_inc = 20
  ctx.globalAlpha = (document.getElementById("speck_opacity").value) /100
  alpha0 = ctx.globalAlpha
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = 1
  linewidth0 = ctx.lineWidth
  let radius = document.getElementById("speck_size").value/(2*6.25)
 // let rows = document.getElementById("rows").value*8
  let inc = ctx.lineWidth*3//512/rows
  numlines = 0;
  x = -20, y = 0 + ctx.lineWidth/2 // should try different initial offset
  x_inc = inc, y_inc = inc
  let maxy = canvas.height * 2
  clip()
  let i = canvas.height/2
  for (; i < maxy; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.3
      ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
    }
    ctx.beginPath();
    ctx.moveTo(-20, y)
    ctx.lineTo(canvas.width+20, y)
    ctx.stroke();
    y += y_inc + pet(2)
  }
  ctx.restore()
}

function eye () { // vertical lines
  let grunge = document.getElementById("grungy").checked
 // clearCanvas()
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext('2d')
  let x = canvas.width/2 + pet(9), y = canvas.height/2 + pet(9);
  let r = 0.5, rinc = 3.9
  ctx.globalAlpha = (document.getElementById("speck_opacity").value) /100
  alpha0 = ctx.globalAlpha
  ctx.strokeStyle = document.getElementById("paintcolor").value
  ctx.lineWidth = 0.5
  linewidth0 = ctx.lineWidth
  let radius = document.getElementById("speck_size").value/(2*6.25)
  let rows = (2+Math.floor(Math.random() * 10))*8//document.getElementById("rows").value*8
  numlines = 0;
  let end = 0, start = 0
  clip()
  let i = 0
  for (; i < 1000; i++) {
    if (grunge) {
      ctx.globalAlpha = alpha0 + (Math.random() - 0.5) * alpha0/1.3
      ctx.lineWidth = linewidth0 + Math.random() * linewidth0/4
    }
    ctx.beginPath();
    start = Math.random() *2 * Math.PI
    end = start + 3.14
    ctx.arc(x,y, r, start, end)
    ctx.stroke();
    r += rinc + pet(1)
  }
  ctx.restore()
}

function blobs () {
  let grunge = document.getElementById("grungy").checked
  let increase = Math.PI * 2 / 40;
  let x = 350, y = 270, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let centx = canvas.width/2;
  let centy = canvas.height/2;
  let area = canvas.width * canvas.height
  let shapemultiplier = area/(1024*1024)
  let cx = centx, cy = centy
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let alpha0 = ctx.globalAlpha
  let numshapes = 25
  ctx.fillStyle = document.getElementById("paintcolor").value
  numshapes = 1 + document.getElementById("number").value/10
  numshapes *= shapemultiplier
  let radius = 1
  //clip()
  for (let t = 0; t < numshapes; t++) {
    x = 0;
    y = 0;
    let x0 = x;
    let y0 = y;
    angle = Math.floor(Math.random() * 6.42);
    centx = Math.random()*ctx.canvas.width+5;
    centy = Math.random()*ctx.canvas.height+5
    let edges = 19 * Math.random() + 9;
    let rmax = document.getElementById("speck_size").value/20 // max = 500
    let maxradius = 1 + rmax * Math.random();
    let r0 = maxradius
    increase = Math.PI * 2/edges*0.98;
    points = [];
    bez = [];
    radius = (Math.random() * maxradius) + maxradius * 0.9;
    for (let i = 0; i < edges; i++) {
      if (grunge) {
        maxradius = r0 + (Math.random()) * r0 * 2
      }
      //radius = (Math.random() * maxradius) + maxradius * 0.9;
      radius += pet(maxradius/1)
      x = radius * Math.cos(angle)+centx;
      y = radius * Math.sin(angle)+centy;
      points.push([x, y]);
      angle += increase;
    }
    let W = canvas.width
    drawPath(points, 0, 0)
    drawPath(points, -W, -W)
    drawPath(points, 0, -W)
    drawPath(points, W, -W)

    drawPath(points, -W, +W)
    drawPath(points, 0, +W)
    drawPath(points, W, +W)

    drawPath(points, -W, 0)
    drawPath(points, +W, 0)
  }
  //ctx.restore()
}

function tatter () {
  let grunge = document.getElementById("grungy").checked
  let increase = Math.PI * 2 / 40;
  let x = 0, y = 0, angle = 0
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let centx = ctx.canvas.width/2;
  let centy = ctx.canvas.height/2;
  let cx = centx, cy = centy
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let numshapes = 1 + document.getElementById("number").value/5
  ctx.fillStyle = document.getElementById("paintcolor").value
  let radius = 1
  for (let t = 0; t < numshapes; t++) {
    x = 0;
    y = 0;
    let y0 = y;
    angle = Math.floor(Math.random() * 6.42);
    centx = Math.random()*ctx.canvas.width+5;
    y0 = canvas.height*3/4 + Math.random() * canvas.height*1/4
    if (grunge)
      y0 = canvas.height/2 + Math.random() * canvas.height/4
    centy = y0 + Math.random()*y0 + 60
    if (100/(canvas.height-centy)/(canvas.height/2) * Math.random() > 0.0004) {
      let edges = 11 * Math.random() + 9;
      let rmax = document.getElementById("speck_size").value/20 // max = 500
      let maxradius = Math.abs(1 + 500/(1+(canvas.height+10-centy)))
      increase = Math.PI * 2/edges*0.98;
      let points = [];
      let i = 0
      for (; i < edges; i++) {
        radius = (Math.random() * maxradius/1.5) + maxradius;
        x = radius * Math.cos(angle)+centx;
        y = radius * Math.sin(angle)+centy;
        points.push([x, y]);
        angle += increase;
      }
      drawPath(points, 0, 0, ctx)
    }
  }
}

function scratch () { // based on blobs
  let grunge = document.getElementById("grungy").checked
  let increase = Math.PI * 2 / 40;
  let x = 0, y = 0, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let centx = 20 + Math.random() * canvas.width - 40
  let centy = ctx.canvas.height/2;
  let cx = centx, cy = centy
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let alpha0 = ctx.globalAlpha
  let numshapes = 1 + document.getElementById("number").value/20
  let area = canvas.width * canvas.height
  let shapemultiplier = area/(1024*1024)
  numshapes *= shapemultiplier
  ctx.fillStyle = document.getElementById("paintcolor").value
  let radius = 1
  for (let t = 0; t < numshapes; t++) {
    x = 0;
    y = 0;
    angle = Math.floor(Math.random() * 6.42);
    centy = Math.random()*ctx.canvas.height+5
    let edges = 19 * Math.random() + 9;
    let rmax = document.getElementById("speck_size").value/20 // max = 500
    let maxradius = 1 + rmax * Math.random();
    let r0 = maxradius
    increase = Math.PI * 2/edges*0.98;
    points = [];
    radius = (Math.random() * maxradius) + maxradius * 0.9;
    for (let i = 0; i < edges; i++) {
      if (grunge) {
        maxradius = r0 + (Math.random()) * r0 * 2
      }
      radius += pet(maxradius)
      x = radius * Math.cos(angle)+centx;
      y = radius * Math.sin(angle)+centy;
      points.push([x, y]);
      angle += increase;
    }
    //let W = canvas.width
    drawPath(points, 0, 0)
  }
}

function drawBlobAt (ctx, x, y, r) {
  let x0 = x;
  let y0 = y;
  angle = Math.floor(Math.random() * 6.42);
 // centx = Math.random()*ctx.canvas.width+5;
  //centy = Math.random()*ctx.canvas.height+5
  let edges = 39 * Math.random() + 9;
  let rmax = document.getElementById("speck_size").value/50 // max = 500
  let maxradius = 1 + rmax * Math.random();

  let r0 = r
  increase = Math.PI * 2/edges*0.98;
  points = [];
  points.push([x,y])
  radius = (Math.random() * maxradius) + maxradius * 0.9;
  for (let i = 0; i < edges; i++) {
    radius += pet(maxradius)
    x = radius * Math.cos(angle)+x;
    y = radius * Math.sin(angle);
    points.push([x, y]);
    angle += increase;
  }
  drawPath(points, 0, 0, ctx)
}

function drawCircleAt(ctx,x,y,r) {
  ctx.beginPath()
  ctx.moveTo(x, y)
  ctx.arc(x,y,r,0,Math.PI*2)
  ctx.closePath()
  ctx.fill()
}

function drawHouseAt(ctx,x,y,r) {
  ctx.beginPath()
  x += pet(Math.random() * r)
  y -= r
  r *= 2
  ctx.moveTo(x, y)  //top
  x += r/2 + pet(20)
  y += r/2
  ctx.lineTo(x, y) //right tip
  x -= (18)+pet(11)
  ctx.lineTo(x, y+pet(14)) // x in
  y += r/2
  ctx.lineTo(x+pet(11), y+pet(34))// right bottom
  y += r/7
  x -= r/2 + pet (r/2)
  ctx.lineTo(x+pet(4), y+pet(11))// bottom minpoint
  y -= r/7
  x -= r/3
  ctx.lineTo(x+pet(14), y+pet(34)) //left bottom
  y -= r/2
  ctx.lineTo(x+pet(14), y+pet(11)) // x in left
  x -= 17
  ctx.lineTo(x+pet(11), y+pet(14)) // left tip
  
  ctx.closePath()
  ctx.fill()
}

function drawRectAt(ctx,x,y,r) {
  ctx.beginPath()
  x -= r
  y -= r
  r *= 2
  ctx.moveTo(x, y)
  ctx.lineTo(x+r, y)
  ctx.lineTo(x+r, y+r)
  ctx.lineTo(x, y+r)
  ctx.closePath()
  ctx.fill()
}

function drawXAt(ctx,x,y,r) {
  ctx.beginPath()
  x -= r
  y -= r
  let h = r*2
  ctx.moveTo(x+h/4, y)
  ctx.lineTo(x+h/2, y+h/4)
  ctx.lineTo(x+h*3/4, y)
  ctx.lineTo(x+h, y+h/4)
  
  ctx.lineTo(x+h*3/4, y+h/2)
  ctx.lineTo(x+h, y+h*3/4)

  ctx.lineTo(x+h*3/4, y+h)
  ctx.lineTo(x+h/2, y+h*3/4)
  ctx.lineTo(x+h/4, y+h)
  
  ctx.lineTo(x, y+h*3/4)
  ctx.lineTo(x+h/4, y+h/2)
  ctx.lineTo(x, y+h/4)

  ctx.closePath()
  ctx.fill()
}

function drawDiamondAt(ctx,x,y,r) {
  ctx.beginPath()
  x -= r
  y -= r
  let h = r*2
  ctx.moveTo(x+h/2, y)
  ctx.lineTo(x+h, y+h/2)
  
  ctx.lineTo(x+h/2, y+h)

  ctx.lineTo(x, y+h/2)

  ctx.closePath()
  ctx.fill()
}


function drawTriangleAt(ctx,x,y,r) {
  ctx.beginPath()
  x -= r
  y -= r
  ctx.moveTo(x+r, y)
  r*=2
  ctx.lineTo(x+r, y+r)
  ctx.lineTo(x, y+r)
  ctx.closePath()
  ctx.fill()
}

function card () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  let centerx = ctx.canvas.width / 2;
  let centery = ctx.canvas.height / 2;
  let x = centerx/2
  let y = centery/2
  let r = h/5
  let colors = []
  let i = 0
  for (; i < 2; i++)
    colors.push(randomColor())
  ctx.fillStyle = randomGradient(canvas);
  //ctx.save()
  clip()
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let grunge = document.getElementById("grungy").checked
  if (grunge) {
    colors = ["red", "blue", "yellow", "green"]
  }

  ctx.fillStyle = randomPick(colors)
  let f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
  y = h * 0.75
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
    
  x = h * 0.75
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
  y = h * 0.25
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  //pushColor(randomPick(colors))
  ctx.restore()
}

function card2 () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  let centerx = ctx.canvas.width / 2;
  let centery = ctx.canvas.height / 2;
  let x = centerx/3
  let y = centery/3
  let r = h/6 - 12
  let colors = []
  let i = 0
  for (; i < 3; i++)
    colors.push(randomColor())
  ctx.fillStyle = randomGradient(canvas);
  //ctx.save()
  clip()
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let grunge = document.getElementById("grungy").checked
  if (grunge) {
    colors = ["red", "blue", "yellow", "green", "orange"]
  }

  ctx.fillStyle = randomPick(colors)
  let f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
  x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
   x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
    
    
  x = centerx/3, y =  centery/3 + h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
  x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
    
  x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
    
  // botton row
   
  x = centerx/3, y =  centery/3 + h * 2/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  
  x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
    
  x += h * 1/3
  ctx.fillStyle = randomPick(colors)
  f = (Math.floor(Math.random() * 4))
  if (f == 0)
    drawCircleAt(ctx,x,y,r)
  else
  if (f == 1)
    drawTriangleAt(ctx,x,y,r)
  else
  if (f == 2)
    drawRectAt(ctx,x,y,r)
  else
    drawXAt(ctx,x,y,r)
  //pushColor(randomPick(colors))
  ctx.restore()
}


function randomWord () {
  return randomPick(words.split("\n"))
}

function diagonal () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  let centerx = ctx.canvas.width / 2;
  let centery = ctx.canvas.height / 2;
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  //document.getElementById("paintcolor").value = randomColor()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let baseline = h * 4/5
  let x =-10
  let y = Math.random() * h/3
  ctx.beginPath()
  ctx.moveTo(x, y)
  let slope = 2 * Math.random()
  let i = 0
  while (y < baseline && x < w) {
    y += slope + pet (13)//+ (Math.random() - 0.5) * 0.5
    x += 5 * Math.random()
    ctx.lineTo(x, y)
    if (Math.random() > 0.8) {
      y += 6 * Math.random()
      x += 7 * Math.random()
    }
    if (Math.random() > 0.9) {
      y -= 5 * Math.random()
      x += 4 * Math.random()
    }
  }
  y = baseline
  while (x > 0) {
    y += 0.25+pet(6)
    x -= 2 * Math.random()
    ctx.lineTo(x,y)
  }
  ctx.closePath()
  ctx.fill()
  flipH()
}

function clearDotAt () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  ctx.fillStyle = document.getElementById("paintcolor").value
  let x = LASTCLICK[0]
  let y = LASTCLICK[1]
  let r = 2 + document.getElementById("speck_size").value/3
  //if (document.getElementById("grungy").checked)
  r += pet(r/3)
  ctx.beginPath()
  ctx.arc(x, y, r, 0, Math.PI*2);
  ctx.closePath()
  ctx.fill()
  if (document.getElementById("grungy").checked) {
    ctx.globalAlpha = 0.15
    r *= 1.1
    ctx.beginPath()
    ctx.arc(x+pet(2), y, r, 0, Math.PI*2);
    ctx.closePath()
    ctx.fill()
    r*= 1.1
    ctx.beginPath()
    ctx.arc(x, y+pet(2), r, 0, Math.PI*2);
    ctx.closePath()
    ctx.fill()
  }
}

function clearFace () {
  document.getElementById("face").value = ""
}

function drawTextAt () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  ctx.fillStyle = document.getElementById("paintcolor").value
  let styles = document.getElementById("style").value
  let faces = document.getElementById("face").value
  let size = +document.getElementById("textsize").value
  if (!faces || faces.length < 1)
    return
  let x = LASTCLICK[0]
  let y = LASTCLICK[1]
  let word = document.getElementById("caption").value
  ctx.moveTo(x, y)
  ctx.font = (styles)+" "+size+"pt " + (faces)
  ctx.fillText(word, x, y);
}

function stem (x,y,r, m) {
  this.x = x
  this.y = y
  this.r = r
  this.bias = (Math.random() - 0.5) * 0.3
  this.xdelta = (5+Math.random()*5) * (Math.random() - 0.5)
  this.max = m //+ Math.random() * 100
  this.count = 0
}

function branching () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  ctx.fillStyle = document.getElementById("paintcolor").value
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let h = canvas.height;
  let w = canvas.width;
  let branches = []
  let m = 2150, yf = 1
  let x = w/2 + pet(w/2), y = h /* 4/5 + pet(h/5)*/, r = w/130 + pet(w/120)
  let s = new stem (x,y,r, m)
  branches.push(s)
  //ctx.clearRect(0,0,canvas.width,canvas.height)
  let i = 0
  let n = 0
  for (; n < 1700; n++) {
    i = 0
    for (; i < branches.length; i++) {
      if (branches[i].count < branches[i].max) {
        drawCircleAt(ctx, branches[i].x+pet(branches[i].r/4), branches[i].y, branches[i].r +pet(branches[i].r/7))
        branches[i].x += 1.2*(branches[i].xdelta*branches[i].r) * branches[i].bias
        branches[i].y -= branches[i].r/2 + pet(3) * yf
        
        branches[i].r *= 0.991
        branches[i].count++
        branches[i].xdelta *= 1.002
        if (Math.random() > 0.997)
          branches[i].bias *= 0.9
        m *= 0.995
       // if (branches[i].r < 0.1)
       //  break
        if (Math.random() > 0.95 && branches.length < 90) {
          branches.push(new stem(branches[i].x, branches[i].y, branches[i].r, m))
        }
      }
    }
  }
}

function land () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let h = canvas.height;
  let w = canvas.width;
  let centerx = ctx.canvas.width / 2;
  let centery = ctx.canvas.height / 2;
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  //document.getElementById("paintcolor").value = randomColor()
  ctx.fillStyle = document.getElementById("paintcolor").value
  let baseline = h - h/7 * Math.random() - 10
  let x =-10
  let y = baseline - h/3 * Math.random() - 30
  ctx.beginPath()
  ctx.moveTo(x, y)
  let slope = 0.01 * Math.random()
  let i = 0
  while (y < baseline && x < w) {
    y += slope + pet (3)//+ (Math.random() - 0.5) * 0.5
    x += 5 * Math.random()
    ctx.lineTo(x, y)
    if (Math.random() > 0.8) {
      y += 6 * Math.random()
      x += 7 * Math.random()
    }
    if (Math.random() > 0.9) {
      y -= 5 * Math.random()
      x += 4 * Math.random()
    }
  }
  y = baseline
  while (x > 0) {
    y += pet(6)
    x -= 5 * Math.random()
    ctx.lineTo(x,y)
  }
  ctx.closePath()
  ctx.fill()
  flipH()
}

function shape2 () {// right side only
  var radvar = 0;
  var increase = Math.PI * 2 / 40;
  var x = 0, y = 0, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  var h = canvas.height;
  var w = canvas.width;
  var centerx = ctx.canvas.width / 2;
  var centery = ctx.canvas.height / 2;
  ctx.fillStyle = randomGradient(canvas);
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let grunge = document.getElementById("grungy").checked
  let numshapes = 1
  let ia = 0
  ctx.save()
  ctx.fillStyle = document.getElementById("paintcolor").value;
  if (grunge)
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  for (var t = 0; t < numshapes; t++) {
    let radius = 10
    x = 0;
    y = 0;
    var x0 = x;
    var y0 = y;
    let turn = 0
    angle = Math.PI/2
    let angle2 = angle
    ctx.beginPath();
    var centx = canvas.width + 20 + canvas.width/3
    var centy = canvas.height/2 + pet(canvas.height);
    var edges = Math.random()*31+Math.random()*31;
    var maxradius = canvas.height/1.7 + Math.random() * canvas.height/5;
    increase = Math.PI * 2/edges;
    ctx.beginPath();
    let rfactor = 2
    let mfactor = maxradius
    for (var i = 0; i < edges-1; i++) {
      angle2 = angle + Math.PI / edges
      rfactor =  maxradius/40 + Math.random() *11
      if (Math.random()> 0.63)
        mfactor += (Math.random() - 0.5) * maxradius/9
      radius = Math.random() * rfactor + mfactor;
      radius += pet(radius/7)
      centx = centx+pet(23)
      centy = centy+pet(23)
      ctx.arc(centx, centy, radius, angle, angle2)
      angle = angle2
      ia = increase + Math.PI/180 * pet(2);
      angle += ia
      turn += ia
      if(turn >= 6.28)
        break;
    }
    ctx.closePath();
    ctx.fill();
    ctx.clip()
    randomColor()
    document.getElementById("speck_opacity").value = 77
    strokes2()
  }
  ctx.restore()
}

function shape () {// right side only
  var radvar = 0;
  var increase = Math.PI * 2 / 40;
  var x = 0, y = 0, angle = 4.7;
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  var h = canvas.height;
  var w = canvas.width;
  var centerx = ctx.canvas.width / 2;
  var centery = ctx.canvas.height / 2;
  ctx.fillStyle = randomGradient(canvas);
 // ctx.save()
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let grunge = document.getElementById("grungy").checked
  let numshapes = 1;//Math.random() * max_shapes() + 2;
  let ia = 0
  ctx.fillStyle = document.getElementById("paintcolor").value;
  if (grunge)
    ctx.fillStyle = randomGradient(canvas, document.getElementById("paintcolor").value)
  for (var t = 0; t < numshapes; t++) {
    let radius = 10//Math.floor(Math.random() * 350) + 320;
    x = 0;
    y = 0;
    var x0 = x;
    var y0 = y;
    let turn = 0
    angle = Math.floor(Math.random() * 6.42);
    ctx.beginPath();
    var centx = canvas.width + 260 //(Math.random() > 0.5)? ctx.canvas.width + 50 * Math.random(): Math.random() * -50;
    var centy = canvas.height/2 + pet(canvas.height/2);
    var edges = Math.random()*121+Math.random()*121;
    var maxradius = canvas.height/2 + Math.random() * canvas.height/3;
    increase = Math.PI * 2/edges;
    ctx.beginPath();
    let rfactor = 2
    let mfactor = maxradius
    for (var i = 0; i < edges-1; i++) {
      rfactor =  maxradius/40 + Math.random() *11
      if (Math.random()> 0.63)
        mfactor += (Math.random() - 0.5) * maxradius/9
      radius = Math.random() * rfactor + mfactor;
      x = radius * Math.cos(angle)+centx;
      y = radius * Math.sin(angle)+centy;
      centx = centx+pet(23)
      centy = centy+pet(23)
      if (i == 0) {
        x0 = x;
        y0 = y;
      }
      ctx.lineTo(x, y);
      ia = increase + Math.PI/180 * pet(9);
      angle += ia
      turn += ia
      if(turn >= 6.28)
        break;
    }
    ctx.lineTo(x0, y0);
    ctx.closePath();
    ctx.fill();
  }
}

function drawPath(points, offsetX, offsetY, c) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  if (c)
    ctx = c
  let x = 0, y = 0, x0 = 0, y0 = 0
  ctx.beginPath()
  let i = 0;
  for (; i < points.length; i++) {
    x = points[i][0] + offsetX;
    y = points[i][1] + offsetY;
    if (i == 0) {
      x0 = x;
      y0 = y;
      ctx.moveTo(x, y);
    } else
    ctx.lineTo(x,y)
  }
  ctx.closePath();
  ctx.fill();
}

function fade () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let cx = ctx.canvas.width/2
  let cy = ctx.canvas.height/2
  let w = canvas.width, h = canvas.height
  let maxdist = 101 + Math.random() * w/2
  maxdist = Math.pow(Math.pow(cx, 2) + Math.pow(cy, 2), 0.5)
  let d = 1000
  let data = ctx.getImageData(0,0,canvas.width,canvas.height)
  let i = 0, x = 0, y = 0
  let len = w * h
  for (;i < len; i++) {
    x = i % w
    if (x === 0)
      y += 1
    d = Math.random() * w
    let px = data.data.slice(i*4, i*4+4)
    px[3] *= d/maxdist
    data.data.set(px, i*4)
  }
  ctx.putImageData(data, 0, 0);
}

function downFade () {
  rc()
  leftFade()
  rcc()
}

function leftFade () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let cx = ctx.canvas.width/2 + pet(150)
  let cy = ctx.canvas.height/2 + pet(150)
  let rightx = canvas.width
  let w = canvas.width, h = canvas.height
  let maxdist = Math.pow(Math.pow(cx, 2) + Math.pow(cy, 2), 0.5)
  maxdist *= 1.2
  let d = 1000
  let data = ctx.getImageData(0,0,canvas.width,canvas.height)
  let i = 0, x = 0, y = 0
  let len = w * h
  for (;i < len; i++) {
    x = i % w
    if (x === 0)
      y += 1
    d = lindistance((x*1.5), 0)
    let px = data.data.slice(i*4, i*4+4)
    px[3] *= d/maxdist
    //setPixel(data, i, px)
    data.data.set(px, i*4)
  }
  ctx.putImageData(data, 0, 0);
}

function edgeGrey () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  ocanvas.width = canvas.width
  ocanvas.height = canvas.height
  octx.drawImage(canvas,0,0)
  greyScale(ocanvas)
  vig(ocanvas)
  ctx.drawImage(ocanvas,0,0)
}

function edgeDarken () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  ocanvas.width = canvas.width
  ocanvas.height = canvas.height
  octx.drawImage(canvas,0,0)
  adjustBrightness(-10, ocanvas)
  vig(ocanvas)
  ctx.drawImage(ocanvas,0,0)
}

function edgeBlur () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  ocanvas.width = canvas.width
  ocanvas.height = canvas.height
  octx.drawImage(canvas,0,0)
 // blurCanvas(ocanvas)
 // blurCanvas(ocanvas)
 
smearrandom(ocanvas)
  vig(ocanvas)
  ctx.drawImage(ocanvas,0,0)
}

function vig (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let cx = ctx.canvas.width/2 + pet(150)
  let cy = ctx.canvas.height/2 + pet(150)

  cx = LASTCLICK[0]
  cy = LASTCLICK[1]
  let s = document.getElementById("speck_size").value // up to 500
  // decrease d as s increases?
  let w = canvas.width, h = canvas.height
  let maxdist = Math.pow(Math.pow(cx, 2) + Math.pow(cy, 2), 0.5)
  maxdist *= 1.2
  let d = 1000
  let data = ctx.getImageData(0,0,canvas.width,canvas.height)
  let i = 0, x = 0, y = 0
  let len = w * h
  for (;i < len; i++) {
    x = i % w
    if (x === 0)
      y += 1
    d = distance(x, y, cx+pet(29), cy+pet(29))
    let px = data.data.slice(i*4, i*4+4)
    px[3] *= d/maxdist
    data.data.set(px, i*4)
  }
  ctx.putImageData(data, 0, 0);
}

function jump () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let c = canvas.width/2
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let i = 0
  let px = canvas.width/4 +Math.random() * canvas.width/3
  let py = canvas.height/4 +Math.random() * canvas.height/3
  if (Math.random() > 0.5)
    px *= -1
    
  if (Math.random() > 0.5)
    py *= -1
  if (document.getElementById("grungy").checked) {
    //p = 100
  }
  ctx.save()
  for (; i < 1; i++) {
    ctx.translate(px, py)
    //ctx.rotate((Math.random() - 0.5) * rotation * Math.PI);
    
    ctx.drawImage(ctx.canvas, 0,0)
  }
  ctx.restore()
}

function pasteFromOff () {
  let OC = document.getElementById('OC')
  if (OC && OC.width > 0) {
    let canvas = document.getElementById('myCanvas')
    let ctx = canvas.getContext('2d')
    let OCctx = OC.getContext('2d')
    OCctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.globalAlpha = document.getElementById("speck_opacity").value/100
    ctx.drawImage(OC, 0, 0)
  }
}

function smearrandom (c) {
  if (c)
    canvas = c
  else
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let off = document.createElement('CANVAS')
  let offctx = off.getContext("2d")
  off.width = canvas.width
  off.height = canvas.height
  offctx.drawImage(canvas, 0, 0)
  let jump = 1 + document.getElementById("speck_size").value/2
  let jump2 = jump
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/400
  let i = 0
  let n = 2
  ctx.save()
  for (; i < n; i++) {
    if (Math.random() > 0.5)
      jump2 *= -1
    if (Math.random() > 0.5)
      jump *= -1
    ctx.drawImage(off, jump/2 + pet(jump/2),  jump2/2 + pet(jump2/2))
  }
  ctx.restore()
}

function smearrandomoc () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let off = document.getElementById('OC')
  if (off && off.width > 0) {
    let x = off.width/2
    let y = off.height/2
    let angle = 2
    let offctx = off.getContext("2d")
    let c = canvas.width/3
    let jump = 1 + document.getElementById("speck_size").value/2
    let jump2 = jump
    ctx.globalAlpha = (document.getElementById("speck_opacity").value)/400
    let i = 0
    let n = 2
    ctx.save()
    for (; i < n; i++) {
      if (Math.random() > 0.5)
        jump2 *= -1
      if (Math.random() > 0.5)
        jump *= -1
      ctx.drawImage(off, jump/2 + pet(jump/2),  jump2/2 + pet(jump2/2))
    }
    ctx.restore()
  }
}

function smearzoom () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let off = document.createElement('CANVAS')
  off.height = canvas.height*1.05
  off.width = canvas.width*1.05
  let x = LASTCLICK[0]//off.width/2
  let y = LASTCLICK[1]//off.height/2
  let xoffset = (canvas.width - off.width)/2
  let yoffset = (canvas.height - off.height)/2
  
  xoffset += (canvas.width/2 - x)/2
  yoffset += (canvas.height/2 - y)/2
  
  let angle = 2
  offctx = off.getContext("2d")
  offctx.drawImage(canvas, xoffset, yoffset, off.width, off.height)
  let c = canvas.width/3
  let jump = 1 + document.getElementById("speck_size").value/10
  let jump2 = jump
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/200
  let i = 0
  let n = 2 //+ Math.random() * 17
  ctx.save()
  for (; i < n; i++) {
    console.log(jump)
    if (Math.random() > 0.5)
      jump2 *= -1
    if (Math.random() > 0.5)
      jump *= -1
    ctx.drawImage(off, jump/2 + pet(jump/2),  jump2/2 + pet(jump2/2))
  }
  ctx.restore()
}


function smearside () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let off = document.createElement('CANVAS')
  off.height = canvas.height
  off.width = canvas.width
  let x = off.width/2
  let y = off.height/2
  let angle = 2
  offctx = off.getContext("2d")
  offctx.drawImage(canvas, 0, 0)
  let c = canvas.width/3
  let jump = 1 + document.getElementById("speck_size").value/5
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/200
  let i = 0
  let n = 2 //+ Math.random() * 17
  ctx.save()
  for (; i < n; i++) {
   // offctx.translate(x,y)
   // offctx.rotate(-angle);
   // offctx.translate(-x,-y)
    ctx.drawImage(off, jump/2 + pet(jump/2), pet(jump/2))
  }
  ctx.restore()
}

function smeardown () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let c = canvas.width/3
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/400
  let i = 0
  let n = 5 + Math.random() * 17
  ctx.save()
  for (; i < n; i++) {
    ctx.translate(c+pet(3), c+3+pet(3))
    ctx.translate(-c, -c);
    ctx.drawImage(ctx.canvas, 0, 0)
  }
  ctx.restore()
}

function smear (micro) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let c = canvas.width/2
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let i = 0
  let m = 7
  if (micro)
    m = 2
  let p = 20, rotation = 0.01
  
  ctx.save()
  for (; i < 5; i++) {
    ctx.translate(c+pet(m), c+pet(m));
    ctx.translate(-c+pet(m), -c+pet(m));
    ctx.drawImage(ctx.canvas, pet(p), pet(p))
  }
  ctx.restore()
}

function edgeSmear () {
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let numshapes = 2 + Math.log(document.getElementById("number").value)/2
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let cx = canvas.height/2, cy = canvas.width/2
  ocanvas.height = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.width = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.height += 50
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  let c = ocanvas.height * 0.5
  octx.fillStyle = randomGradient(ocanvas, document.getElementById("paintcolor").value)
  octx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let x = canvas.width/100 * Math.random()
  let y = 4
  let r = 17
  let i = 0
  let p = 61
  if (document.getElementById("grungy").checked)
    p *= 3
  for (; i < numshapes; i++) {
    octx.fillStyle = randomGradient(ocanvas, document.getElementById("paintcolor").value)
    octx.globalAlpha = Math.random()
    drawBlobAt (octx, x+pet(p), y, r+pet(17))
  }
  i = 0
  let N = (Math.log(canvas.height+1) * 11.3) - 46
  for (; i < N; i++) {
    octx.globalAlpha = Math.random()
    octx.translate(c, c+3+pet(1))
    octx.translate(-c, -c)
    octx.drawImage(octx.canvas, 0, 0)
  }
  ctx.drawImage(ocanvas, 0, -50)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function smeardownOff () {
  let ocanvas = document.createElement("CANVAS")
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let numshapes = 2 + Math.log(document.getElementById("number").value)/2
  ctx.globalAlpha = document.getElementById("speck_opacity").value/100
  let cx = canvas.height/2, cy = canvas.width/2
  ocanvas.height = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.width = (canvas.height > canvas.width)? canvas.height: canvas.width
  ocanvas.height += 50
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  let c = ocanvas.height * 0.5
  octx.fillStyle = randomGradient(ocanvas, document.getElementById("paintcolor").value)
  octx.globalAlpha = (document.getElementById("speck_opacity").value)/100
  let x = canvas.width * Math.random()
  let y = 4
  let r = 17
  let i = 0
  let p = 61
  if (document.getElementById("grungy").checked)
    p *= 3
  for (; i < numshapes; i++) {
    octx.fillStyle = randomGradient(ocanvas, document.getElementById("paintcolor").value)
    octx.globalAlpha = Math.random()
    drawBlobAt (octx, x+pet(p), y, r+pet(17))
  }
  i = 0
  let N = (Math.log(canvas.height+1) * 11.3) - 46
  for (; i < N; i++) {
    octx.globalAlpha = Math.random()
    octx.translate(c, c+3+pet(1))
    octx.translate(-c, -c)
    octx.drawImage(octx.canvas, 0, 0)
  }
  ctx.drawImage(ocanvas, 0, -50)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
}

function smearsideways () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let c = canvas.height/2
  ctx.globalAlpha = (document.getElementById("speck_opacity").value)/400
  let i = 0
  let p = 5
  if (document.getElementById("grungy").checked) {
    p = 11
  }
  ctx.save()
  for (; i < 33; i++) {
    ctx.translate(c+3+pet(1), c+pet(1))
    ctx.rotate(0 * Math.PI);
    ctx.translate(-c, -c);
    ctx.drawImage(ctx.canvas,3, pet(p))
  }
  ctx.restore()
}

function refreshMode () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let selectElement = document.getElementById("mode");
  ctx.globalCompositeOperation = selectElement.value
  return true
}

function syncBackground (canvas) {
  let bkg = document.getElementById("background");
  bkg.style.height = canvas.height +"px"
  bkg.style.width = canvas.width +"px"
  syncMarker()
}

function resizeCanvas () {
  let canvas_size = 1080//256 * document.getElementById("canvas_size").value
  let ocanvas = document.getElementById('off')
  let octx = ocanvas.getContext('2d')
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d")
  let mode = ctx.globalCompositeOperation
  let a = ctx.globalAlpha
  ctx.globalAlpha = 1.0
  ocanvas.height = canvas.height
  ocanvas.width = canvas.width
  ctx.imageSmoothingEnabled = false
  octx.drawImage(canvas, 0, 0)
  canvas.height = canvas_size
  canvas.width = canvas_size
  
  let selection = document.getElementById("canvassizes").value
  if (selection == "portrait") {
    canvas.width = 1080
    canvas.height = 1350
  } else
  if (selection == "landscape") {
    canvas.width = 1080
    canvas.height = 608
  }
  syncBackground(canvas)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
//  LASTCLICK[0] = myCanvas.width/2
//  LASTCLICK[1] = myCanvas.height/2
  ctx.imageSmoothingEnabled = false
  syncBackground(canvas)
  ctx.drawImage(ocanvas,0,0,canvas.width,canvas.height)
  octx.clearRect(0,0,ocanvas.width,ocanvas.height)
  document.getElementById("canvaswidth").value = canvas.width
  document.getElementById("canvasheight").value = canvas.height
 // LASTCLICK[0] = myCanvas.width/2
 // LASTCLICK[1] = myCanvas.height/2
  ctx.globalCompositeOperation = mode
  //syncMarker()
}

function clearCanvas () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  ctx.clearRect(0,0,canvas.width, canvas.height)
}

function saveAs () {
  //console.log(document.getElementById("myCanvas").height)
  document.getElementById("downloader").download = "image.png";
  document.getElementById("downloader").href = document.getElementById("myCanvas").toDataURL("image/png").replace(/^data:image\/[^;]/, 'data:application/octet-stream');
}

function pet(v) {
  return (Math.random() -0.5) * v;
}

function distance (x1, y1, x2, y2) {
  return Math.pow(Math.pow(x1-x2, 2) + Math.pow(y1-y2, 2), 0.5)
}

function lindistance(x1,x2) {
  return Math.abs(x1,x2)
}

function updateDist () {
  let d = document.getElementById("distribution").value
  let el = document.getElementById("dist")
  if (d == 0)
    el.innerHTML = "gaussian"
  else
    el.innerHTML = "square"
}

function transparenter () {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let pixels = imgData.data;
  let i = 0
  for (; i < pixels.length; i += 4) {
    pixels[i + 3] *= 0.9;
  }
  ctx.putImageData(imgData, 0, 0);
}

function adjustBrightness (n, canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let pixels = imgData.data;
  let i = 0
  for (; i < pixels.length; i += 4) {
    pixels[i] += n;
    pixels[i + 1] += n;
    pixels[i + 2] += n;
  }
  ctx.putImageData(imgData, 0, 0);
}

function adjustWarmth (n, canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let g = n/2
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let pixels = imgData.data;
  let i = 0
  for (; i < pixels.length; i += 4) {
    pixels[i] += n;
   // pixels[i + 1] += g;
    pixels[i + 2] -= n;
  }
  ctx.putImageData(imgData, 0, 0);
}

function saturationScale (sv) {
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let dA = imageData.data; // raw pixel data in array
  //var sv = 1.25; // saturation value. 0 = grayscale, 1 = original
  var luR = 0.3086; // constant to determine luminance of red. Similarly, for green and blue
  var luG = 0.6094;
  var luB = 0.0820;
  var az = (1 - sv)*luR + sv;
  var bz = (1 - sv)*luG;
  var cz = (1 - sv)*luB;
  var dz = (1 - sv)*luR;
  var ez = (1 - sv)*luG + sv;
  var fz = (1 - sv)*luB;
  var gz = (1 - sv)*luR;
  var hz = (1 - sv)*luG;
  var iz = (1 - sv)*luB + sv;
  let i = 0
  for(; i < dA.length; i += 4) {
      var red = dA[i]; // Extract original red color [0 to 255]. Similarly for green and blue below
      var green = dA[i + 1];
      var blue = dA[i + 2];
      var saturatedRed = (az*red + bz*green + cz*blue);
      var saturatedGreen = (dz*red + ez*green + fz*blue);
      var saturateddBlue = (gz*red + hz*green + iz*blue);
      dA[i] = saturatedRed;
      dA[i + 1] = saturatedGreen;
      dA[i + 2] = saturateddBlue;
  }
  ctx.putImageData(imageData, 0, 0);
}

function rgb_lrgb1(v) {
  return (v /= 255) <= 0.04045 ? v / 12.92 : ((v + 0.055) / 1.055) ** 2.4;
}

function lrgb_rgb1(v) {
  return (v <= 0.0031308 ? 12.92 * v : 1.055 * (v ** (1 / 2.4)) - 0.055) * 255;
}

function gray (r, g, b) {
  const kr = 0.2126
  const kg = 0.7152
  const kb = 0.0722
  return lrgb_rgb1(kr * rgb_lrgb1(r) + kg * rgb_lrgb1(g) + kb * rgb_lrgb1(b));
}

function greyScale_fancy (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  const context = canvas.getContext("2d");
  const kr = 0.2126
  const kg = 0.7152
  const kb = 0.0722
  //context.canvas.style = "max-width: 100%;";
  //context.drawImage(image, 0, 0, width, height);
  const input = context.getImageData(0, 0, canvas.width, canvas.height);
  const output = context.createImageData(canvas.width, canvas.height);
  for (let y = 0, i = 0; y < canvas.height; ++y) {
    for (let x = 0; x < canvas.width; ++x, i += 4) {
      const r = rgb_lrgb1(input.data[i + 0]);
      const g = rgb_lrgb1(input.data[i + 1]);
      const b = rgb_lrgb1(input.data[i + 2]);
      const a = lrgb_rgb1(kr * r + kg * g + kb * b);
      output.data[i + 0] = r
      output.data[i + 1] = g
      output.data[i + 2] = b
      output.data[i + 3] = 255;
    }
  }
  context.putImageData(output, 0, 0);
  //return context.canvas;
}

function greyScale (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imgData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height);
  let pixels = imgData.data;
  let i = 0
  for (; i < pixels.length; i += 4) {
    let lightness = parseInt((pixels[i] + pixels[i + 1] + pixels[i + 2]) / 3);
    pixels[i] = lightness;
    pixels[i + 1] = lightness;
    pixels[i + 2] = lightness;
  }
  ctx.putImageData(imgData, 0, 0);
}

function lum () {
  let c = document.getElementById("paintcolor").value
  let r = hexToR(c) / 255
  let g = hexToG(c) / 255
  let b = hexToB(c) / 255

  // Find greatest and smallest channel values
  let cmin = Math.min(r,g,b),
      cmax = Math.max(r,g,b),
      delta = cmax - cmin,
      h = 0,
      s = 0,
      l = 0;
  return ((cmax + cmin) / 2)
}

function threshold () {
  let threshold = lum() * 255
  let canvas = document.getElementById("myCanvas");
  let ctx = canvas.getContext("2d");
  let imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  let d = imageData.data; // raw pixel data in array
  for (var i=0; i<d.length; i+=4) {
    var r = d[i];
    var g = d[i+1];
    var b = d[i+2];
    var v = (0.2126*r + 0.7152*g + 0.0722*b >= threshold) ? 255 : 0;
    d[i] = d[i+1] = d[i+2] = v
  }
  ctx.putImageData(imageData, 0, 0);
}

function randomKernel () {
  let wts = [0,1,2,3,4,5,1/2]
  let sum = 0, i = 0
  let k = []
  for (; i < 9; i++) {
    k.push(randomPick(wts) * Math.floor(2*(Math.random() - 0.5)))
    sum += k[i]
  }
  if (sum != 0) {
    let sum2 = 0
    i = 0
    for (; i < 9; i++) {
      k[i] /= sum
      sum2 += k[i]
    }
      console.log(k, sum2)

  }
  return k
}

function randomConvolution () {
  let k = randomKernel()
  convolutionMatrix(k, 0)
}

function blurCanvas (canvas) {
  if (!canvas)
    canvas = document.getElementById("myCanvas")
  let k = [1,1,1,1,1,1,1,1,1]
  convolutionMatrix(k, 0, canvas, 9)
}

function emboseCanvas () {
  let k = [[-1,-1,-1,
           -1,1,1,
            1,1,1],
          
          [1,1,1,
           1,1,-1,
         - 1,-1,-1],
           
          [-1,-1,1,
           -1,1,1,
           -1,1,1],
          
          [1,1,-1,
           1,1,-1,
           1,-1,-1]
        ]
            
    convolutionMatrix(randomPick(k), 0)
}


function sharpenCanvas () {
  let k = [0,-1,0,
          -1,5,-1,
           0,-1,0]
    convolutionMatrix(k, 0)
}

function edgeCanvas () {
  let k = [0,1,0,
           1,-4,1,
           0,1,0]
    convolutionMatrix(k, 0)
    invertColors()
    return true
}

function blur2Canvas () {
  let canvas = document.getElementById("myCanvas");
  let k = [1, 2, 1,
           2, 4, 2,
           1, 2, 1]
    convolutionMatrix(k, 0, canvas, 16)
}

function identityCanvas () {
  let k = [0,0,0,
           0,1,0,
           0,0,0]
    convolutionMatrix(k, 0)
}

function convolutionMatrix (kernel, offset, canvas, div) {
  if (!canvas)
    canvas = document.getElementById("myCanvas")
  if (!div)
    div = 1
  let i = 0
  let ctx = canvas.getContext("2d")
  let input = ctx.getImageData(0, 0, canvas.width, canvas.height)
  let output = ctx.createImageData(input)
  let w = input.width, h = input.height
  let iD = input.data, oD = output.data
  for (let y = 1; y < h - 1; y += 1) {
    for (let x = 1; x < w - 1; x += 1) {
      for (let c = 0; c < 3; c += 1) {
        i = (y * w + x) * 4 + c
        oD[i] = offset +
        (kernel[0] * iD[i - w * 4 - 4] +
          kernel[1] * iD[i - w * 4] +
          kernel[2] * iD[i - w * 4 + 4] +
          kernel[3] * iD[i - 4] +
          kernel[4] * iD[i] +
          kernel[5] * iD[i + 4] +
          kernel[6] * iD[i + w * 4 - 4] +
          kernel[7] * iD[i + w * 4] +
          kernel[8] * iD[i + w * 4 + 4])/div
      }
      oD[(y * w + x) * 4 + 3] = 255
    }
  }
  ctx.putImageData(output, 0, 0)
}

// ====================
function sobel () {
  let canvas = document.getElementById("myCanvas")
  let ctx = canvas.getContext("2d")
  let imageData = ctx.getImageData(0, 0, ctx.canvas.width, ctx.canvas.height)
  let pixels = imageData.data
  let i = 0
  let data = imageData.data
  let width = imageData.width;
  let height = imageData.height;
   const kernelX = [
    [-1,0,1],
    [-2,0,2],
    [-1,0,1]
  ];
  const kernelY = [
    [-1,-2,-1],
    [0,0,0],
    [1,2,1]
  ];
  let sobelData = [];
  let grayscaleData = [];
  function bindPixelAt(data) {
    return function(x, y, i) {
      i = i || 0;
      return data[((width * y) + x) * 4 + i];
    };
  }
  let pixelAt = bindPixelAt(data);
  let x, y;
  for (y = 0; y < height; y++) {
    for (x = 0; x < width; x++) {
      var r = pixelAt(x, y, 0);
      var g = pixelAt(x, y, 1);
      var b = pixelAt(x, y, 2);
      var avg = (r + g + b) / 3;
      grayscaleData.push(avg, avg, avg, 255);
    }
  }
  pixelAt = bindPixelAt(grayscaleData);
  for (y = 0; y < height; y++) {
    for (x = 0; x < width; x++) {
      let pixelX = (
        (kernelX[0][0] * pixelAt(x - 1, y - 1)) +
        (kernelX[0][1] * pixelAt(x, y - 1)) +
        (kernelX[0][2] * pixelAt(x + 1, y - 1)) +
        (kernelX[1][0] * pixelAt(x - 1, y)) +
        (kernelX[1][1] * pixelAt(x, y)) +
        (kernelX[1][2] * pixelAt(x + 1, y)) +
        (kernelX[2][0] * pixelAt(x - 1, y + 1)) +
        (kernelX[2][1] * pixelAt(x, y + 1)) +
        (kernelX[2][2] * pixelAt(x + 1, y + 1))
      );
      let pixelY = (
        (kernelY[0][0] * pixelAt(x - 1, y - 1)) +
        (kernelY[0][1] * pixelAt(x, y - 1)) +
        (kernelY[0][2] * pixelAt(x + 1, y - 1)) +
        (kernelY[1][0] * pixelAt(x - 1, y)) +
        (kernelY[1][1] * pixelAt(x, y)) +
        (kernelY[1][2] * pixelAt(x + 1, y)) +
        (kernelY[2][0] * pixelAt(x - 1, y + 1)) +
        (kernelY[2][1] * pixelAt(x, y + 1)) +
        (kernelY[2][2] * pixelAt(x + 1, y + 1))
      );
      let magnitude = Math.sqrt((pixelX * pixelX) + (pixelY * pixelY))>>>0;
      sobelData.push(magnitude, magnitude, magnitude, 255);
    }
  }
  let clampedArray = sobelData;
  clampedArray = new Uint8ClampedArray(sobelData);
  ctx.putImageData(toImageData(clampedArray,width,height), 0, 0)
  invertColors()
  return true
}

function toImageData(data, width, height) {
  if (typeof ImageData === 'function' && Object.prototype.toString.call(data) === '[object Uint16Array]') {
    return new ImageData(data, width, height);
  } else {
    if (typeof window === 'object' && typeof window.document === 'object') {
      var canvas = document.createElement('canvas');
      if (typeof canvas.getContext === 'function') {
        var context = canvas.getContext('2d');
        var imageData = context.createImageData(width, height);
        imageData.data.set(data);
        return imageData;
      } else {
        return new FakeImageData(data, width, height);
      }
    } else {
      return new FakeImageData(data, width, height);
    }
  }
};

function FakeImageData(data, width, height) {
  return {
    width: width,
    height: height,
    data: data
  };
}
  
</script>
<!--script src="wordlist2.js"></script-->
</body>
</html>